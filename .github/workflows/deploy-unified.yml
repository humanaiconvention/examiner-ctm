name: Unified CI & Deploy

################################################################################
# Action Pin Table (Generated 2025-09-28)
# Format: <action> <tag> <commit-sha>
# actions/checkout v5.0.0 08c6903cd8c0fde910a37f88322edcfb5dd907a8
# actions/setup-node v5.0.0 a0853c24544627f65ddf259abe73b1d18a591444
# actions/upload-artifact v4.6.2 ea165f8d65b6e75b540449e92b4886f43607fa02
# actions/upload-pages-artifact v4.0.0 7b1f4a764d45c48632c6b24a0339c27f5614fb0b
# actions/deploy-pages v4.0.5 d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e
# peter-evans/create-or-update-comment v4.0.0 71345be0265236311c031f5c7866368bd1eff043
################################################################################

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  PREVIEW_PASSWORD_SECRET: ${{ secrets.PREVIEW_PASSWORD }}

concurrency:
  group: unified-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: Quality Gates
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: '20'
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install deps (root + web)
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Lint
        run: |
          npm run lint --workspace web -- --max-warnings=0 || (echo "Lint failed"; exit 1)
        continue-on-error: false
      - name: Typecheck
        run: npm run typecheck
      - name: Unit Tests
        run: |
          npm test --workspaces --if-present -- --run --reporter=basic || (echo "Tests failed"; exit 1)
      - name: Coverage (non-blocking)
        run: npm run test:coverage || echo "Coverage step failed or not present"
      - name: Generate ESLint & Test Reports (scripts)
        run: |
          npm run lint:report --workspace web || echo '{"note":"lint:report failed"}' > web/eslint-report.json
          npm run test:report --workspace web || echo '{"note":"test:report failed"}' > web/test-report/results.json
          # Ensure junit exists (vitest reporter path)
          if [ ! -f web/test-report/junit.xml ]; then
            echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?><testsuite name=\"placeholder\" tests=\"0\" failures=\"0\"/>" > web/test-report/junit.xml
          fi
      - name: Aggregate Problem Budget
        run: |
          node web/scripts/problem-budget.mjs || (echo "Problem budget failed"; exit 1)
      - name: Upload Problem Budget Summary
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: problem-budget
          path: web/problem-budget-summary.json
          if-no-files-found: error
      - name: Summarize Test Results
        if: always()
        id: test_summary
        run: |
          set -e
          SUMMARY_JSON=web/test-report/summary.json
          if [ -f web/test-report/junit.xml ]; then
            # Parse simple metrics from junit (tests, failures, skipped) via awk/grep (avoid extra deps)
            LINE=$(grep -m1 '<testsuite' web/test-report/junit.xml || true)
            TOTAL=$(echo "$LINE" | sed -n 's/.*tests="\([0-9]\+\)".*/\1/p')
            FAIL=$(echo "$LINE" | sed -n 's/.*failures="\([0-9]\+\)".*/\1/p')
            SKIP=$(echo "$LINE" | sed -n 's/.*skipped="\([0-9]\+\)".*/\1/p')
            [ -z "$TOTAL" ] && TOTAL=0; [ -z "$FAIL" ] && FAIL=0; [ -z "$SKIP" ] && SKIP=0
            PASS=$((TOTAL-FAIL-SKIP))
            echo "{\"tests\":$TOTAL,\"passes\":$PASS,\"failures\":$FAIL,\"skipped\":$SKIP}" > $SUMMARY_JSON
          else
            echo '{"tests":0,"passes":0,"failures":0,"skipped":0}' > $SUMMARY_JSON
          fi
          echo "summary=$(cat $SUMMARY_JSON | tr '\n' ' ')" >> $GITHUB_OUTPUT
          echo "Test Summary:" >> $GITHUB_STEP_SUMMARY
          cat $SUMMARY_JSON | jq -r '. | "Total: \(.tests)  Pass: \(.passes)  Fail: \(.failures)  Skip: \(.skipped)"' >> $GITHUB_STEP_SUMMARY
      - name: Post PR Comment (Test Summary)
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            âœ… Test Summary
            ````
            ${{ steps.test_summary.outputs.summary }}
            ````
            _artifact: quality-reports / junit.xml_
            (Updates on new commits.)
          edit-mode: replace
      - name: Generate Quality Badge JSON
        if: always()
        run: |
          mkdir -p build-metrics
            if [ -f web/test-report/summary.json ]; then
              cp web/test-report/summary.json build-metrics/test-summary.json
            fi
          if [ -f web/eslint-report.json ]; then
            WARN=$(jq '[.[]? | select(.severity==1)] | length' web/eslint-report.json 2>/dev/null || echo 0)
            ERR=$(jq '[.[]? | select(.severity==2)] | length' web/eslint-report.json 2>/dev/null || echo 0)
          else
            WARN=0; ERR=0;
          fi
          if [ -f build-metrics/test-summary.json ]; then
            TOTAL=$(jq '.tests' build-metrics/test-summary.json); PASS=$(jq '.passes' build-metrics/test-summary.json); FAIL=$(jq '.failures' build-metrics/test-summary.json)
          else
            TOTAL=0; PASS=0; FAIL=0;
          fi
          COLOR=green
          if [ "$FAIL" -gt 0 ]; then COLOR=red; elif [ "$WARN" -gt 0 ]; then COLOR=yellow; fi
          jq -n --arg tests "$TOTAL" --arg pass "$PASS" --arg fail "$FAIL" --arg warn "$WARN" --arg err "$ERR" --arg color "$COLOR" '{schema:1,tests:$tests|tonumber,passes:$pass|tonumber,failures:$fail|tonumber,warnings:$warn|tonumber,errors:$err|tonumber,color:$color}' > build-metrics/quality-badge.json
      - name: Upload Quality Badge JSON
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: quality-badge
          path: build-metrics/quality-badge.json
          if-no-files-found: warn
      - name: Upload Quality Reports (incl JUnit)
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: quality-reports
          path: |
            web/eslint-report.json
            web/test-report/results.json
            web/test-report/junit.xml
            web/problem-budget-summary.json
          if-no-files-found: warn
          retention-days: 5
      - name: Upload Coverage Artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage
          path: web/coverage
          if-no-files-found: ignore
          retention-days: 5
      - name: Slack Notify (Quality Gate)
        if: always() && env.SLACK_WEBHOOK_URL != ''
        run: |
          status="success"
          if [ "${{ job.status }}" != "success" ]; then status="failure"; fi
          node .github/scripts/slack-notify.mjs \
            --webhook "$SLACK_WEBHOOK_URL" \
            --event quality \
            --status "$status" \
            --summary-file web/problem-budget-summary.json \
            --commit "$GITHUB_SHA" \
            --repo "$GITHUB_REPOSITORY" \
            --run-id "$GITHUB_RUN_ID" \
            --workflow "$GITHUB_WORKFLOW" || echo "Slack quality notify failed"

  deploy:
    name: Build & Deploy Pages
    needs: [quality]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: github-pages
    env:
      NODE_VERSION: '20'
      # After this date SBOM mismatch in verify job becomes a failure (promoted from warning)
      SBOM_ENFORCE_DATE: '2025-10-15'
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install deps (root + web)
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Build Site
        run: |
          cd web
          if [ -n "$CUSTOM_DOMAIN" ]; then
            export PUBLIC_BASE_PATH='/'
            echo "Custom domain detected: $CUSTOM_DOMAIN (base=/)"
          else
            export PUBLIC_BASE_PATH="/${{ github.event.repository.name }}"
            echo "No custom domain; using base $PUBLIC_BASE_PATH"
          fi
          PUBLIC_BASE_PATH=$PUBLIC_BASE_PATH npm run build
          echo "Commit: $GITHUB_SHA" > dist/DEPLOY_MARKER.txt
          if [ -f public/health.txt ]; then cp public/health.txt dist/health.txt; else echo "OK" > dist/health.txt; fi
          BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          jq -n --arg commit "$GITHUB_SHA" --arg time "$BUILD_TIME" --arg ref "${GITHUB_REF#refs/heads/}" '{commit:$commit,time:$time,ref:$ref}' > dist/version.json
          # Inject meta tag (before closing head) & window.__APP_VERSION__
          if grep -q '</head>' dist/index.html; then
            sed -i "s#</head>#<meta name=\"x-app-version\" content=\"$GITHUB_SHA\" />\n<script>window.__APP_VERSION__=$(cat dist/version.json)</script>\n</head>#" dist/index.html || true
          fi
      - name: Index Hash Change (optional drift signal)
        run: |
          set -e
          cd web
          if [ ! -f dist/readyz.json ]; then echo "No dist/readyz.json present (build script may have changed)"; ls -al dist || true; exit 0; fi
          PREV_URL="https://humanaiconvention.github.io/${{ github.event.repository.name }}/readyz.json"
          echo "Attempting to fetch previous deployed readyz: $PREV_URL"
          curl -sSf "$PREV_URL" -o previous-readyz.json || { echo "Previous readyz fetch failed (first deploy or unreachable)"; exit 0; }
          echo "Running index hash change check (informational)."
          set +e
          node scripts/check-index-hash-changed.mjs previous-readyz.json dist/readyz.json --require-change
          rc=$?
          if [ $rc -eq 3 ]; then
            echo "::warning::indexHash did not change while a change was required (potential missing content update)."
          elif [ $rc -ne 0 ]; then
            echo "Index hash check exited with code $rc (non-fatal)."
          else
            echo "Index hash check passed.";
          fi
          set -e
      - name: Bundle Size Manifest
        run: |
          cd web
          node scripts/bundle-size.mjs manifest
          cp dist-size-manifest.json dist/bundle-size-manifest.json || true
      - name: Bundle Size Check
        run: |
          cd web
          # Attempt to fetch previous manifest from main (best-effort)
          if git show HEAD:web/dist-size-manifest.json > prev-manifest.json 2>/dev/null; then
            export SIZE_BASELINE=prev-manifest.json
          fi
          node scripts/bundle-size.mjs check
      - name: Upload Bundle Size Artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: bundle-size
          path: |
            web/dist-size-manifest.json
            web/bundle-size-result.json
          if-no-files-found: warn
      - name: Compute Integrity Hash
        run: |
          cd web
          node scripts/verify-inline-version.mjs --with-hash || exit 1
          cat dist/version-integrity.json
      - name: Compute SBOM (CycloneDX minimal for attestation)
        run: |
          cd web
          mkdir -p sbom
          npx @cyclonedx/cyclonedx-npm --spec-version 1.5 --output-format json --output-file sbom/sbom.json
          jq -r ".components | length as $n | \"SBOM components: \" + ($n|tostring)" sbom/sbom.json || true
      - name: SBOM Component Diff (pre-baseline commit)
        run: |
          cd web
          if [ -f sbom/sbom.json ]; then
            if git show HEAD:web/sbom/sbom.json > baseline-sbom.json 2>/dev/null; then
              node scripts/compare-sbom.mjs --current sbom/sbom.json --baseline baseline-sbom.json --license --out sbom-diff.json || echo "SBOM diff failed"
            else
              node scripts/compare-sbom.mjs --current sbom/sbom.json --license --out sbom-diff.json || echo "SBOM diff failed"
            fi
            if [ -f sbom-diff.json ]; then echo "SBOM Diff:"; jq -r '.summary' sbom-diff.json; fi
          else
            echo "No current SBOM present; skipping diff.";
          fi
      - name: Derive SBOM & Integrity Hash Attestation
        id: attest
        run: |
          cd web
          sbomSha=$(sha256sum sbom/sbom.json | awk '{print $1}')
          integSha=$(jq -r '.sha256' dist/version-integrity.json)
          jq -n --arg sbom "$sbomSha" --arg integrity "$integSha" --arg commit "$GITHUB_SHA" --arg time "$(date -u +%Y-%m-%dT%H:%M:%SZ)" '{commit:$commit,time:$time,integritySha256:$integrity,sbomSha256:$sbom,format:"cyclonedx-1.5"}' > web/attestation.json
          cat web/attestation.json
          echo "sbomSha=$sbomSha" >> $GITHUB_OUTPUT
          echo "integritySha=$integSha" >> $GITHUB_OUTPUT
      - name: Generate Provenance (SLSA-lite in-toto statement)
        id: provenance
        run: |
          cd web
          integSha=$(jq -r '.sha256' dist/version-integrity.json)
          sbomSha=$(sha256sum sbom/sbom.json | awk '{print $1}')
          attSha=$(sha256sum attestation.json | awk '{print $1}')
          buildType="https://github.com/${GITHUB_REPOSITORY}/actions/workflows/deploy-unified.yml@${GITHUB_SHA}"
          started=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          # Minimal in-toto / SLSA style provenance
          jq -n --arg commit "$GITHUB_SHA" --arg integ "$integSha" --arg sbom "$sbomSha" --arg att "$attSha" --arg started "$started" --arg builder "$buildType" '{_type:"https://in-toto.io/Statement/v0.1", subject:[{name:"dist/index.html", digest:{sha256:$integ}}], predicateType:"https://slsa.dev/provenance/v1", predicate:{buildDefinition:{buildType:$builder, externalParameters:{}, resolvedDependencies:[{name:"sbom.json", digest:{sha256:$sbom}}, {name:"attestation.json", digest:{sha256:$att}}]}, runDetails:{builder:{id:$builder}, metadata:{invocationId:$commit, startedOn:$started}}}}' > provenance.json
          cat provenance.json
          echo "provenanceSha=$(sha256sum provenance.json | awk '{print $1}')" >> $GITHUB_OUTPUT
      - name: Generate SLSA v1 Predicate (consolidated)
        id: slsa
        run: |
          cd web
          integSha=$(jq -r '.sha256' dist/version-integrity.json)
          buildWorkflow="https://github.com/${GITHUB_REPOSITORY}/.github/workflows/deploy-unified.yml@${GITHUB_SHA}"
          started=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          sbomSha=$(sha256sum sbom/sbom.json | awk '{print $1}')
          attSha=$(sha256sum attestation.json | awk '{print $1}')
          provLiteSha=$(sha256sum provenance.json | awk '{print $1}')
          jq -n --arg integ "$integSha" --arg sbom "$sbomSha" --arg att "$attSha" --arg prov "$provLiteSha" --arg builder "$buildWorkflow" --arg commit "$GITHUB_SHA" --arg started "$started" '{"_type":"https://in-toto.io/Statement/v0.1","subject":[{"name":"dist/index.html","digest":{"sha256":$integ}}],"predicateType":"https://slsa.dev/provenance/v1","predicate":{"buildDefinition":{"buildType":$builder,"externalParameters":{},"resolvedDependencies":[{name:"sbom.json",digest:{sha256:$sbom}},{name:"attestation.json",digest:{sha256:$att}},{name:"provenance.json",digest:{sha256:$prov}}]},"runDetails":{"builder":{"id":$builder},"metadata":{"invocationId":$commit,"startedOn":$started}}}}' > slsa-provenance.json
          cat slsa-provenance.json
          echo "slsaProvenanceSha=$(sha256sum slsa-provenance.json | awk '{print $1}')" >> $GITHUB_OUTPUT
      # SLSA predicate: Add a dedicated job in future for official generator if required.
      - name: Upload Attestation Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: attestation
          path: web/attestation.json
          retention-days: 15
      - name: Upload Provenance Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: provenance
          path: web/provenance.json
          retention-days: 15
      - name: Commit baseline integrity & attestation (fast-forward)
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          cp web/dist/version-integrity.json web/version-integrity.json
          cp web/attestation.json web/attestation-latest.json
          cp web/provenance.json web/provenance-latest.json || true
          cp web/slsa-provenance.json web/slsa-provenance-latest.json || true
          # Commit SBOM baseline for drift detection in daily audit
          if [ -f web/sbom/sbom.json ]; then
            mkdir -p web/sbom
            cp web/sbom/sbom.json web/sbom/sbom.json
            git add web/sbom/sbom.json || true
          fi
          git add web/version-integrity.json web/attestation-latest.json || true
          git add web/provenance-latest.json web/slsa-provenance-latest.json || true
          if git diff --cached --quiet; then echo "No baseline changes to commit"; exit 0; fi
          git commit -m "chore: update integrity baseline (ci)" || exit 0
          git pull --ff-only origin main || true
          git push origin HEAD:main || echo "Non-fatal: push failed (race)"
      - name: Install Cosign
        run: |
          COSIGN_VERSION=v2.4.0
          curl -sSL -o cosign.tgz https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64.tgz
          tar -xzf cosign.tgz cosign
          sudo mv cosign /usr/local/bin/cosign
          cosign version || true
      - name: Sign Artifacts (keyless)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -e
          cd web
          # Capture signature, certificate (OIDC leaf cert), and bundle (Rekor inclusion proof) for each artifact
          sign_one() {
            local file=$1 base=$2
            echo "Signing $file -> $base"
            cosign sign-blob --yes "$file" \
              --output-signature "$base.sig" \
              --output-certificate "$base.cert" \
              --bundle "$base.bundle" || { echo "Signing failed for $file"; exit 1; }
          }
          sign_one attestation.json attestation
          sign_one dist/version-integrity.json version-integrity
          if [ -f sbom/sbom.json ]; then sign_one sbom/sbom.json sbom; fi
          if [ -f provenance.json ]; then sign_one provenance.json provenance; fi
          if [ -f slsa-provenance.json ]; then sign_one slsa-provenance.json slsa-provenance; fi
      - name: Verify Signatures & Rekor Inclusion
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -e
          cd web
          IDENTITY_SUB="https://github.com/${GITHUB_REPOSITORY}/.github/workflows/deploy-unified.yml@refs/heads/main"
          ISSUER="https://token.actions.githubusercontent.com"
          verify_blob() {
            local file=$1 sig=$2
            if [ ! -f "$file" ]; then echo "Missing $file"; exit 1; fi
            if [ ! -f "$sig" ]; then echo "Missing signature $sig"; exit 1; fi
            echo "Verifying $file";
            cosign verify-blob --signature "$sig" "$file" \
              --certificate-identity "$IDENTITY_SUB" \
              --certificate-oidc-issuer "$ISSUER" || { echo "cosign verify-blob failed for $file"; exit 1; }
          }
          verify_blob attestation.json attestation.sig
          verify_blob dist/version-integrity.json version-integrity.sig
          [ -f sbom/sbom.json ] && verify_blob sbom/sbom.json sbom.sig || echo "No SBOM to verify"
          [ -f provenance.json ] && verify_blob provenance.json provenance.sig || echo "No provenance to verify"
          [ -f slsa-provenance.json ] && verify_blob slsa-provenance.json slsa-provenance.sig || echo "No slsa-provenance to verify"
          echo "Signatures verified. Validating Rekor inclusion proofs (bundles)."
          bundle_check() {
            local base=$1
            if [ ! -f "$base.bundle" ]; then echo "Missing bundle for $base"; return 1; fi
            # Basic JSON sanity & required fields
            if ! jq -e '.Payload.body | length > 0 and .LogID and .IntegratedTime' "$base.bundle" >/dev/null 2>&1; then
              echo "Bundle validation failed for $base (missing required fields)"; return 2; fi
            echo "Bundle OK for $base (LogID=$(jq -r '.LogID' $base.bundle) Index=$(jq -r '.Verification.InclusionProof.LogIndex // "?"' $base.bundle))";
          }
          bundle_check attestation || exit 1
          bundle_check version-integrity || exit 1
          [ -f sbom.bundle ] && bundle_check sbom || echo "No SBOM bundle"
            [ -f provenance.bundle ] && bundle_check provenance || echo "No provenance bundle"
          [ -f slsa-provenance.bundle ] && bundle_check slsa-provenance || echo "No slsa-provenance bundle"
          # Additional lightweight cert sanity: ensure OIDC issuer present in cert PEM
          cert_check() {
            local base=$1
            if [ -f "$base.cert" ]; then
              if ! grep -q "sigstore" "$base.cert"; then echo "Warning: cert for $base lacks expected 'sigstore' marker"; fi
            fi
          }
          cert_check attestation
          cert_check version-integrity
          cert_check sbom || true
          cert_check provenance || true
          cert_check slsa-provenance || true
          echo "Rekor inclusion & certificate sanity checks complete."
      - name: Upload Signatures
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: signatures
          path: |
            web/attestation.sig
            web/version-integrity.sig
            web/sbom/sbom.sig
            web/provenance.sig
            web/slsa-provenance.sig
            web/attestation.cert
            web/version-integrity.cert
            web/sbom/sbom.cert
            web/provenance.cert
            web/slsa-provenance.cert
            web/attestation.bundle
            web/version-integrity.bundle
            web/sbom/sbom.bundle
            web/provenance.bundle
            web/slsa-provenance.bundle
          if-no-files-found: ignore
          retention-days: 15
      - name: Policy Enforcement (lightweight)
        run: |
          set -e
          echo "Evaluating policy: .github/policies/sigstore-policy.yaml"
          if [ ! -f .github/policies/sigstore-policy.yaml ]; then echo "Policy file missing"; exit 1; fi
          required=("web/dist/version-integrity.json:version-integrity" "web/attestation.json:attestation" "web/provenance.json:provenance" "web/slsa-provenance.json:slsa-provenance")
          failures=0
          for pair in "${required[@]}"; do
            file=${pair%%:*}; base=${pair##*:}
            if [ -f "$file" ]; then
              for ext in sig cert bundle; do
                path="web/${base}.${ext}"
                if [ ! -f "$path" ]; then echo "Missing $ext for $base ($path)"; failures=$((failures+1)); fi
              done
            else
              echo "Artifact file absent (optional or not generated): $file";
            fi
          done
          if [ $failures -gt 0 ]; then
            echo "Policy enforcement: FAILED ($failures missing signature assets)"; exit 87
          fi
          echo "Policy enforcement: PASSED"
      - name: OCI Reference Signature Verification (cosign verify)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -e
          repoLower="${GITHUB_REPOSITORY,,}"
          base="ghcr.io/${repoLower}"
          tag="$GITHUB_SHA"
          IDENTITY_SUB="https://github.com/${GITHUB_REPOSITORY}/.github/workflows/deploy-unified.yml@refs/heads/main"
          ISSUER="https://token.actions.githubusercontent.com"
          verify_ref() {
            local ref=$1
            echo "Verifying OCI ref: $ref"
            cosign verify "$ref" \
              --certificate-identity "$IDENTITY_SUB" \
              --certificate-oidc-issuer "$ISSUER" >/dev/null || { echo "cosign verify failed for $ref"; exit 1; }
          }
          verify_ref ${base}/attestation:${tag}
          verify_ref ${base}/integrity:${tag}
          if oras manifest fetch ${base}/sbom:${tag} >/dev/null 2>&1; then verify_ref ${base}/sbom:${tag}; else echo "No sbom ref found"; fi
          if oras manifest fetch ${base}/provenance:${tag} >/dev/null 2>&1; then verify_ref ${base}/provenance:${tag}; else echo "No provenance ref found"; fi
          if oras manifest fetch ${base}/slsa-provenance:${tag} >/dev/null 2>&1; then verify_ref ${base}/slsa-provenance:${tag}; else echo "No slsa-provenance ref found"; fi
          echo "OCI reference verification complete."
      - name: Push OCI Artifacts (attestation & integrity)
        env:
          GHCR_USER: ${{ github.actor }}
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          repoLower="${GITHUB_REPOSITORY,,}" # lowercase
          base="ghcr.io/${repoLower}"
          echo "Logging into ghcr.io as $GHCR_USER"
          echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
          # Pack simple OCI images using tar layers (fallback: oras if available)
          mkdir -p oci
          cp web/attestation.json oci/attestation.json
          cp web/dist/version-integrity.json oci/version-integrity.json
          if [ -f web/sbom/sbom.json ]; then cp web/sbom/sbom.json oci/sbom.json; fi
          if [ -f web/provenance.json ]; then cp web/provenance.json oci/provenance.json; fi
          if [ -f web/slsa-provenance.json ]; then cp web/slsa-provenance.json oci/slsa-provenance.json; fi
          # Use oras if present, else install
          if ! command -v oras >/dev/null 2>&1; then
            curl -sSL https://github.com/oras-project/oras/releases/download/v1.2.0/oras_1.2.0_linux_amd64.tar.gz | tar -xz oras && sudo mv oras /usr/local/bin/
          fi
          tag="$GITHUB_SHA"
          oras push ${base}/attestation:${tag} oci/attestation.json:application/json
          oras push ${base}/integrity:${tag} oci/version-integrity.json:application/json
          if [ -f oci/sbom.json ]; then oras push ${base}/sbom:${tag} oci/sbom.json:application/json; fi
          if [ -f oci/provenance.json ]; then oras push ${base}/provenance:${tag} oci/provenance.json:application/json; fi
          if [ -f oci/slsa-provenance.json ]; then oras push ${base}/slsa-provenance:${tag} oci/slsa-provenance.json:application/json; fi
      - name: Upload Integrity Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: version-integrity
          path: web/dist/version-integrity.json
          retention-days: 10
      - name: Commit bundle size baseline (fast-forward)
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          if [ ! -f web/dist-size-manifest.json ]; then echo "No dist-size-manifest.json present; skipping baseline commit"; exit 0; fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Only add if changed vs HEAD to avoid noise
          cp web/dist-size-manifest.json web/dist-size-manifest.json
          git add web/dist-size-manifest.json || true
          if git diff --cached --quiet; then echo "No bundle size baseline changes"; exit 0; fi
          git commit -m "chore: update bundle size baseline (ci)" || exit 0
          git pull --ff-only origin main || true
          git push origin HEAD:main || echo "Non-fatal: push failed (race)"
      - name: Append to Transparency Log Issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issueTitle="Deployment Transparency Log"
          bodyLine=$(jq -r '. | "- $(.generatedAt) commit=${{ github.sha }} sha256=" + .sha256' web/dist/version-integrity.json)
          number=$(gh issue list --search "$issueTitle" --state open --json number,title --jq '.[0].number' || true)
          if [ -z "$number" ]; then
            gh issue create --title "$issueTitle" --body "### Transparency Log\n$bodyLine" --label observability || true
          else
            gh issue comment "$number" --body "$bodyLine" || true
          fi
      - name: Dist Diagnostics
        run: |
          echo "Listing dist:"; ls -al web/dist | head -80
          echo "Marker:"; cat web/dist/DEPLOY_MARKER.txt || true
          echo "Health:"; cat web/dist/health.txt || true
          [ -f web/dist/DEPLOY_MARKER.txt ] || { echo "Missing marker"; exit 1; }
          [ -f web/dist/health.txt ] || { echo "Missing health"; exit 1; }
      - name: Inject CNAME (if custom domain)
        run: |
          if [ -n "$CUSTOM_DOMAIN" ]; then echo "$CUSTOM_DOMAIN" > web/dist/CNAME; fi
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: web/dist
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
      - name: Uptime Smoke Test
        run: |
          URL="${{ steps.deployment.outputs.page_url }}"
          echo "Probing $URL ..."
          for i in 1 2 3 4 5; do
            code=$(curl -s -o /dev/null -w '%{http_code}' "$URL" || echo 000)
            echo "Attempt $i -> $code"; [ "$code" = "200" ] && break; sleep 3;
          done
          curl -I "$URL/DEPLOY_MARKER.txt" || true
          curl -I "$URL/health.txt" || true
      - name: (Optional) Webhook Placeholder
        if: ${{ false }}
        run: echo "Add webhook curl here (disabled)"
      - name: Deployment Summary
        run: |
          echo "Deployment URL: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "Commit: $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
          echo "Base Path: ${PUBLIC_BASE_PATH:-/(computed by vite)}" >> $GITHUB_STEP_SUMMARY
          echo "Version JSON: ${{ steps.deployment.outputs.page_url }}/version.json" >> $GITHUB_STEP_SUMMARY
          echo "Integrity Hash: $(jq -r '.sha256' web/dist/version-integrity.json)" >> $GITHUB_STEP_SUMMARY
          echo "SBOM SHA256: ${{ steps.attest.outputs.sbomSha }}" >> $GITHUB_STEP_SUMMARY
          echo "Attestation Integrity SHA256: ${{ steps.attest.outputs.integritySha }}" >> $GITHUB_STEP_SUMMARY
          if [ -f web/bundle-size-result.json ]; then echo "Bundle Size: $(jq -r '.totalBytes // "n/a"' web/bundle-size-result.json) bytes" >> $GITHUB_STEP_SUMMARY; fi
      - name: Slack Notify (optional)
        if: success() && env.SLACK_WEBHOOK_URL != ''
        run: |
          payload=$(jq -n --arg url "${{ steps.deployment.outputs.page_url }}" --arg sha "$GITHUB_SHA" '{text:"Deploy succeeded", url:$url, commit:$sha}')
          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL" || echo "Slack notify failed"
      - name: Slack Notify (Deploy)
        if: always() && env.SLACK_WEBHOOK_URL != ''
        run: |
          status="success"; [ "${{ job.status }}" = "success" ] || status="failure"
          SUMMARY_FILE=web/problem-budget-summary.json
          node .github/scripts/slack-notify.mjs \
            --webhook "$SLACK_WEBHOOK_URL" \
            --event deploy \
            --status "$status" \
            --url "${{ steps.deployment.outputs.page_url }}" \
            --summary-file "$SUMMARY_FILE" \
            --commit "$GITHUB_SHA" \
            --repo "$GITHUB_REPOSITORY" \
            --run-id "$GITHUB_RUN_ID" \
            --workflow "$GITHUB_WORKFLOW" || echo "Slack deploy notify failed"

  verify:
    name: Rebuild & Verify (Determinism)
    needs: deploy
    if: needs.deploy.result == 'success'
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: '20'
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install deps
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Rebuild
        run: |
          cd web
          npm run build
          node scripts/verify-inline-version.mjs --with-hash
      - name: Compare Integrity Hash
        run: |
          set -e
          baseHash=$(jq -r '.sha256' web/version-integrity.json || echo 'none')
          newHash=$(jq -r '.sha256' web/dist/version-integrity.json || echo 'none')
          echo "Baseline: $baseHash"
          echo "Rebuild : $newHash"
          if [ "$baseHash" != "$newHash" ]; then
            echo "Integrity hash mismatch (non-deterministic build?)"; exit 1; fi
      - name: SBOM Recompute & Compare (best-effort)
        run: |
          cd web
            mkdir -p sbom
          npx @cyclonedx/cyclonedx-npm --spec-version 1.5 --output-format json --output-file sbom/sbom-verify.json || true
          newSbomSha=$(sha256sum sbom/sbom-verify.json | awk '{print $1}' || echo 'none')
          if [ -f sbom/sbom.json ]; then baseSbomSha=$(sha256sum sbom/sbom.json | awk '{print $1}'); else baseSbomSha='unknown'; fi
          echo "SBOM baseline: $baseSbomSha"; echo "SBOM rebuild : $newSbomSha";
          if [ "$baseSbomSha" != "unknown" ] && [ "$baseSbomSha" != "$newSbomSha" ]; then
            enforceDate=${SBOM_ENFORCE_DATE:-2099-12-31}
            now=$(date -u +%Y-%m-%d)
            if [ "$now" \> "$enforceDate" ] || [ "$now" = "$enforceDate" ]; then
              echo "ERROR: SBOM hash mismatch after enforcement date ($enforceDate)."; exit 55
            else
              echo "::warning::SBOM hash differs (transitive changes?) - will become fatal after $enforceDate";
            fi
          fi
      - name: Verification Summary
        run: |
          echo "Integrity hash reproduced successfully." >> $GITHUB_STEP_SUMMARY
          echo "Baseline hash: $(jq -r '.sha256' web/version-integrity.json)" >> $GITHUB_STEP_SUMMARY
          echo "Rebuild  hash: $(jq -r '.sha256' web/dist/version-integrity.json)" >> $GITHUB_STEP_SUMMARY
          echo "SBOM enforcement date: ${SBOM_ENFORCE_DATE:-2025-10-15}" >> $GITHUB_STEP_SUMMARY
      - name: Slack Notify (Verify)
        if: always() && env.SLACK_WEBHOOK_URL != ''
        run: |
          status="success"; [ "${{ job.status }}" = "success" ] || status="failure"
          node .github/scripts/slack-notify.mjs \
            --webhook "$SLACK_WEBHOOK_URL" \
            --event verify \
            --status "$status" \
            --commit "$GITHUB_SHA" \
            --repo "$GITHUB_REPOSITORY" \
            --run-id "$GITHUB_RUN_ID" \
            --workflow "$GITHUB_WORKFLOW" || echo "Slack verify notify failed"


  lighthouse:
    name: Lighthouse & Perf (gradual)
    needs: quality
    # Only run on main; internal first step will short-circuit if no relevant path changes
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: '20'
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Detect relevant path changes
        id: path_filter
        run: |
          set -e
          # Determine diff range: for push compare with prev commit; for workflow_dispatch just proceed
          if [ "${{ github.event_name }}" = "push" ]; then
            prev=$(git rev-parse HEAD^ || echo '')
          else
            prev="" # will cause run
          fi
          echo "Previous commit: $prev"
          runLh="false"
          if [ -z "$prev" ]; then
            runLh="true"
          else
            # List changed files
            changed=$(git diff --name-only "$prev" HEAD || true)
            echo "Changed files:\n$changed"
            # Iterate through changed file list
            printf '%s\n' "$changed" | while IFS= read -r f; do
              case "$f" in
                web/src/*|web/public/*|web/vite.config.*|web/package.json|web/tsconfig.*) runLh="true"; break;;
              esac
            done || true
          fi
          echo "run-lh=$runLh" >> $GITHUB_OUTPUT
          if [ "$runLh" != "true" ]; then echo "No relevant frontend changes detected; skipping Lighthouse job early."; fi
      - name: Skip if not needed
        if: steps.path_filter.outputs.run-lh != 'true'
        run: echo "Skipping remaining steps." && exit 0
      - uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install deps (web)
        run: |
          npm --workspace web ci || (cd web && npm install)
      - name: Build preview server
        working-directory: web
        run: npm run build
      - name: Run Lighthouse (if script exists)
        working-directory: web
        run: |
          if npm run | grep -q 'lhci'; then npm run lhci || echo 'Lighthouse run had issues'; else echo 'No lhci script'; fi
      - name: Perf budget (if script exists)
        working-directory: web
        run: |
          # Enforce gradually: allow failure but capture status; future: remove '|| true'
          if npm run | grep -q 'perf:check'; then npm run perf:check || echo 'Perf check failed (non-fatal)'; else echo 'No perf:check script'; fi
      - name: Upload Lighthouse Artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: lighthouse-gradual
          path: web/.lighthouseci
          if-no-files-found: ignore
      - name: Lighthouse Threshold Gate (future enforcement)
        if: always()
        run: |
          # Soft gate: read perf scores if available and emit warnings; enforce after target date
          TARGET_DATE=${LIGHTHOUSE_ENFORCE_DATE:-2025-11-01}
          today=$(date -u +%Y-%m-%d)
          if [ -d web/.lighthouseci ]; then
            SUMMARY=$(grep -h '"performance"' web/.lighthouseci/*report.json 2>/dev/null | head -1 || true)
            if [ -n "$SUMMARY" ]; then echo "Perf snippet: $SUMMARY"; fi
            # Look for numeric score lines
            perf=$(jq -r '.categories.performance.score*100|floor' web/.lighthouseci/*report.json 2>/dev/null | head -1 || echo 0)
            acc=$(jq -r '.categories.accessibility.score*100|floor' web/.lighthouseci/*report.json 2>/dev/null | head -1 || echo 0)
            best=$(jq -r '.categories["best-practices"].score*100|floor' web/.lighthouseci/*report.json 2>/dev/null | head -1 || echo 0)
            seo=$(jq -r '.categories.seo.score*100|floor' web/.lighthouseci/*report.json 2>/dev/null | head -1 || echo 0)
            echo "Perf: $perf Acc: $acc Best: $best SEO: $seo" >> $GITHUB_STEP_SUMMARY
            minPerf=${MIN_PERF_SCORE:-90}
            minAcc=${MIN_ACC_SCORE:-95}
            if [ "$today" \> "$TARGET_DATE" ] || [ "$today" = "$TARGET_DATE" ]; then
              if [ "$perf" -lt "$minPerf" ] || [ "$acc" -lt "$minAcc" ]; then
                echo "Lighthouse thresholds not met after enforcement date ($TARGET_DATE)."; exit 64; fi
            else
              if [ "$perf" -lt "$minPerf" ]; then echo "::warning::Performance score $perf below $minPerf (will enforce after $TARGET_DATE)"; fi
              if [ "$acc" -lt "$minAcc" ]; then echo "::warning::Accessibility score $acc below $minAcc (will enforce after $TARGET_DATE)"; fi
            fi
          else
            echo "No lighthouse data; skipping gate.";
          fi
      - name: Slack Notify (Lighthouse Warning)
        if: always() && env.SLACK_WEBHOOK_URL != ''
        run: |
          # Only send warning if performance or accessibility below thresholds pre-enforcement
          TARGET_DATE=${LIGHTHOUSE_ENFORCE_DATE:-2025-11-01}
          today=$(date -u +%Y-%m-%d)
          if [ -d web/.lighthouseci ]; then
            perf=$(jq -r '.categories.performance.score*100|floor' web/.lighthouseci/*report.json 2>/dev/null | head -1 || echo 0)
            acc=$(jq -r '.categories.accessibility.score*100|floor' web/.lighthouseci/*report.json 2>/dev/null | head -1 || echo 0)
            minPerf=${MIN_PERF_SCORE:-90}
            minAcc=${MIN_ACC_SCORE:-95}
            if { [ "$today" \< "$TARGET_DATE" ] && { [ "$perf" -lt "$minPerf" ] || [ "$acc" -lt "$minAcc" ]; }; } || { [ "$today" \> "$TARGET_DATE" ] && [ "${{ job.status }}" != "success" ]; }; then
              node .github/scripts/slack-notify.mjs \
                --webhook "$SLACK_WEBHOOK_URL" \
                --event lighthouse-warning \
                --status warning \
                --commit "$GITHUB_SHA" \
                --repo "$GITHUB_REPOSITORY" \
                --run-id "$GITHUB_RUN_ID" \
                --workflow "$GITHUB_WORKFLOW" || echo "Slack lighthouse notify failed"
            else
              echo "No Lighthouse warning to send.";
            fi
          else
            echo "No Lighthouse artifacts; skipping Slack.";
          fi

  pr-preview:
    name: PR Ephemeral Preview
    if: github.event_name == 'pull_request'
    needs: quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: 20
          cache: npm
      - name: Install deps
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Build (PR preview base)
        env:
          PREVIEW_PASSWORD: ${{ env.PREVIEW_PASSWORD_SECRET }}
        run: |
          cd web
          export PUBLIC_BASE_PATH="/pr-${{ github.event.pull_request.number }}"
            echo "Preview base: $PUBLIC_BASE_PATH"
          PUBLIC_BASE_PATH=$PUBLIC_BASE_PATH npm run build
          echo "Commit: $GITHUB_SHA" > dist/DEPLOY_MARKER.txt
          echo "OK" > dist/health.txt
          echo "PR Preview for #${{ github.event.pull_request.number }}" > dist/preview-info.txt
      - name: Preview protection & report
        uses: ./.github/actions/preview-protect
        with:
          dist: dist/index.html
          password: ${{ env.PREVIEW_PASSWORD_SECRET }}
          require-password: true
          min-length: 10
          require-classes: upper,lower,digit
          report-path: dist/preview-lock-report.json
          working-directory: web
          sign-report: true
      - name: Upload Preview Artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: web/dist
      - name: Deploy Preview
        id: pr_deploy
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
      - name: Comment Preview URL
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ðŸ§ª PR Preview Ready
            URL: ${{ steps.pr_deploy.outputs.page_url }}pr-${{ github.event.pull_request.number }}/
            Commit: `${{ github.sha }}`
            (Base: /pr-${{ github.event.pull_request.number }})

  preview-comment:
    name: PR Preview Note
    if: github.event_name == 'pull_request'
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - name: Comment (no deploy for PR)
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            âœ… Quality checks completed.
            This PR does not auto-deploy; merge to main to publish.

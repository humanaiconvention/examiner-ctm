name: deploy-observability

on:
  workflow_dispatch:
    inputs:
      resourceGroup:
        description: "Azure Resource Group"
        required: true
      location:
        description: "Azure region for workbook (e.g. eastus)"
        required: false
        default: eastus
      appInsightsName:
        description: "Existing Application Insights resource name"
        required: true
      actionGroupResourceId:
        description: "Full resourceId of an existing Action Group (for alerts). Leave blank to skip alerts."
        required: false
      workbookName:
        description: "Workbook display name"
        required: false
        default: "HAIC Observability"
      deployWorkbook:
        description: "Set to 'false' to skip workbook deployment"
        required: false
        default: 'true'
      deployAlerts:
        description: "Set to 'false' to skip alerts deployment"
        required: false
        default: 'true'
      enableDiagnostics:
        description: "Set to 'true' to configure diagnostic settings export (requires workspace or storage)"
        required: false
        default: 'false'
      logAnalyticsWorkspaceId:
        description: "Full resource ID of Log Analytics workspace (if diagnostics enabled)"
        required: false
      storageAccountId:
        description: "Full resource ID of Storage Account (alternative to workspace)"
        required: false
  push:
    paths:
      - 'alerts.bicep'
      - 'workbook.bicep'
      - 'azure-workbook.json'
      - '.github/workflows/deploy-observability.yml'

permissions:
  id-token: write
  contents: read

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      has_creds: ${{ steps.check.outputs.has_creds }}
    steps:
      - name: Check Azure credential secrets
        id: check
        run: |
          set -e
          missing=0
          [ -z "${{ secrets.AZURE_CLIENT_ID }}" ] && echo "::warning::Secret AZURE_CLIENT_ID is not set" && missing=1 || true
          [ -z "${{ secrets.AZURE_TENANT_ID }}" ] && echo "::warning::Secret AZURE_TENANT_ID is not set" && missing=1 || true
            [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ] && echo "::warning::Secret AZURE_SUBSCRIPTION_ID is not set" && missing=1 || true
          if [ $missing -eq 0 ]; then echo "has_creds=true" >> $GITHUB_OUTPUT; else echo "has_creds=false" >> $GITHUB_OUTPUT; fi
  deploy:
    name: Deploy Observability Assets
    needs: preflight
    if: needs.preflight.outputs.has_creds == 'true'
    runs-on: ubuntu-latest
    env:
      AZURE_RESOURCE_GROUP: ${{ inputs.resourceGroup }}
      AZURE_LOCATION: ${{ inputs.location }}
      AI_NAME: ${{ inputs.appInsightsName }}
      ACTION_GROUP_ID: ${{ inputs.actionGroupResourceId }}
      WORKBOOK_NAME: ${{ inputs.workbookName }}
      DO_WORKBOOK: ${{ inputs.deployWorkbook }}
      DO_ALERTS: ${{ inputs.deployAlerts }}
      ENABLE_DIAG: ${{ inputs.enableDiagnostics }}
      LAW_ID: ${{ inputs.logAnalyticsWorkspaceId }}
      STORAGE_ID: ${{ inputs.storageAccountId }}
    steps:
      - name: Inputs (push default)
        if: github.event_name == 'push'
        run: |
          echo "AZURE_RESOURCE_GROUP=${{ env.AZURE_RESOURCE_GROUP || 'SET_ME' }}" >> $GITHUB_ENV
          echo "AI_NAME=${{ env.AI_NAME || 'SET_ME' }}" >> $GITHUB_ENV
          echo "ACTION_GROUP_ID=${{ env.ACTION_GROUP_ID || 'SET_ME' }}" >> $GITHUB_ENV
      - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4.1.0

      - name: Validate required inputs
        run: |
          missing=0
          for v in AZURE_RESOURCE_GROUP AI_NAME; do
            if [ -z "${!v}" ] || [ "${!v}" = "SET_ME" ]; then
              echo "::error title=Missing Input::Environment variable $v is not set"; missing=1; fi; done
          if [ $missing -eq 1 ]; then exit 1; fi
          if [ "$DO_ALERTS" != 'false' ] && [ -z "$ACTION_GROUP_ID" ]; then
            echo "::notice title=Alerts Skipped::ACTION_GROUP_ID not provided; skipping alerts"; echo "DO_ALERTS=false" >> $GITHUB_ENV; fi
          if [ "$ENABLE_DIAG" = 'true' ]; then
            if [ -z "$LAW_ID" ] && [ -z "$STORAGE_ID" ]; then
              echo "::error title=Diagnostics Config Error::Diagnostics enabled but neither logAnalyticsWorkspaceId nor storageAccountId provided"; exit 1; fi
          fi

      - name: Azure Login (OIDC)
        # Pinned azure/login@v2.3.0 commit for supply-chain integrity
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Resolve App Insights Resource Id
        id: resolve_ai
        run: |
          set -e
          ID=$(az monitor app-insights component show -g "$AZURE_RESOURCE_GROUP" -a "$AI_NAME" --query id -o tsv)
          if [ -z "$ID" ]; then echo "::error::Could not resolve App Insights component"; exit 1; fi
          echo "id=$ID" >> $GITHUB_OUTPUT

      - name: Configure Diagnostic Settings
        if: env.ENABLE_DIAG == 'true'
        run: |
          set -e
          DEST=""
          if [ -n "$LAW_ID" ]; then DEST="--workspace $LAW_ID"; fi
          if [ -n "$STORAGE_ID" ]; then DEST="--storage-account $STORAGE_ID"; fi
          NAME="haic-ai-diag"
          # Create or update diagnostic setting (logs: all categories, metrics)
          az monitor diagnostic-settings create \
            --name $NAME \
            --resource "${{ steps.resolve_ai.outputs.id }}" \
            $DEST \
            --logs '[{"category":"AppRequests","enabled":true},{"category":"AppDependencies","enabled":true},{"category":"AppTraces","enabled":true},{"category":"AppEvents","enabled":true},{"category":"AppMetrics","enabled":true},{"category":"AppAvailabilityResults","enabled":true}]' \
            --metrics '[{"category":"AllMetrics","enabled":true}]' || az monitor diagnostic-settings update --name $NAME --resource "${{ steps.resolve_ai.outputs.id }}" $DEST --set logs='[{"category":"AppRequests","enabled":true},{"category":"AppDependencies","enabled":true},{"category":"AppTraces","enabled":true},{"category":"AppEvents","enabled":true},{"category":"AppMetrics","enabled":true},{"category":"AppAvailabilityResults","enabled":true}]' metrics='[{"category":"AllMetrics","enabled":true}]'
          echo "Configured diagnostic settings $NAME"

      - name: Deploy Alerts (Bicep)
        if: env.DO_ALERTS != 'false' && env.ACTION_GROUP_ID != ''
        run: |
          az deployment group create \
            -g "$AZURE_RESOURCE_GROUP" \
            -f alerts.bicep \
            -p appInsightsId="${{ steps.resolve_ai.outputs.id }}" actionGroupId="$ACTION_GROUP_ID"

      - name: Deploy Workbook (Bicep)
        if: env.DO_WORKBOOK != 'false'
        run: |
          CONTENT=$(cat azure-workbook.json | jq -c .)
          az deployment group create \
            -g "$AZURE_RESOURCE_GROUP" \
            -f workbook.bicep \
            -p workbookName="$WORKBOOK_NAME" location="$AZURE_LOCATION" appInsightsId="${{ steps.resolve_ai.outputs.id }}" workbookContent="$CONTENT"

      - name: Workbook Integrity Attestation
        if: env.DO_WORKBOOK != 'false'
        run: |
          set -e
          SHA=$(sha256sum azure-workbook.json | awk '{print $1}')
          cat > workbook-integrity.json <<EOF
          {
            "schemaVersion": 1,
            "file": "azure-workbook.json",
            "sha256": "$SHA",
            "generatedAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workbookName": "${WORKBOOK_NAME}",
            "commit": "${GITHUB_SHA}" ,
            "appInsightsId": "${{ steps.resolve_ai.outputs.id }}"
          }
          EOF
          echo "Workbook SHA256: $SHA"
          echo "Created workbook-integrity.json"

      - name: Sign Workbook Integrity (Optional)
        if: env.DO_WORKBOOK != 'false' && env.COSIGN_EXPERIMENTAL == 'true'
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          if ! command -v cosign >/dev/null; then
            echo "Installing cosign (pinned version)"; COSIGN_VERSION=2.2.4; curl -sSL -o cosign.tgz "https://github.com/sigstore/cosign/releases/download/v${COSIGN_VERSION}/cosign-linux-amd64.tgz" && tar -xzf cosign.tgz && sudo mv cosign /usr/local/bin/cosign && cosign version || true; fi
          cosign sign-blob --yes workbook-integrity.json > workbook-integrity.sig
          echo "Signed workbook-integrity.json"

      - name: Summary
        run: |
          echo "### Observability Deployment" >> $GITHUB_STEP_SUMMARY
          echo "App Insights: ${{ steps.resolve_ai.outputs.id }}" >> $GITHUB_STEP_SUMMARY
          echo "Alerts: $([[ "$DO_ALERTS" == 'false' ]] && echo 'skipped' || echo 'deployed')" >> $GITHUB_STEP_SUMMARY
          echo "Workbook: $([[ "$DO_WORKBOOK" == 'false' ]] && echo 'skipped' || echo 'deployed')" >> $GITHUB_STEP_SUMMARY
          echo "Diagnostics: $([[ "$ENABLE_DIAG" == 'true' ]] && echo 'configured' || echo 'disabled')" >> $GITHUB_STEP_SUMMARY
          if [ -f workbook-integrity.json ]; then
            echo '\n#### Workbook Integrity' >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            jq . workbook-integrity.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
  skipped:
    name: Skipped (No Azure Creds)
    needs: preflight
    if: needs.preflight.outputs.has_creds != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "### Observability Deployment" >> $GITHUB_STEP_SUMMARY
          echo "Skipped: Azure credential secrets missing (AZURE_CLIENT_ID / AZURE_TENANT_ID / AZURE_SUBSCRIPTION_ID)" >> $GITHUB_STEP_SUMMARY

name: Deploy Pages

################################################################################
# Action Pin Table (Generated 2025-09-28)
# Format: <action> <tag> <commit-sha>
# actions/checkout v5.0.0 08c6903cd8c0fde910a37f88322edcfb5dd907a8
# actions/setup-node v5.0.0 a0853c24544627f65ddf259abe73b1d18a591444
# actions/upload-pages-artifact v4.0.0 7b1f4a764d45c48632c6b24a0339c27f5614fb0b
# actions/deploy-pages v4.0.5 d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e
# peter-evans/create-or-update-comment v4.0.0 71345be0265236311c031f5c7866368bd1eff043
################################################################################

on:
  # Converted to manual-only after unified workflow introduction
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: pages-deploy
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    environment: github-pages
    env:
      NODE_VERSION: '20'
      # CUSTOM_DOMAIN: set this as a repository variable (Settings -> Variables -> Actions)
      # We can't directly reference an unset var in an expression safely; resolve base in a step.
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install Dependencies
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Build
        run: |
          cd web
          if [ -n "$CUSTOM_DOMAIN" ]; then
            export PUBLIC_BASE_PATH='/'
            echo "Custom domain detected: $CUSTOM_DOMAIN (base=/)"
          else
            export PUBLIC_BASE_PATH="/${{ github.event.repository.name }}"
            echo "No custom domain; using base $PUBLIC_BASE_PATH"
          fi
          PUBLIC_BASE_PATH=$PUBLIC_BASE_PATH npm run build
          # Marker & health files (always create)
          echo "Commit: $GITHUB_SHA" > dist/DEPLOY_MARKER.txt
          if [ -f public/health.txt ]; then
            cp public/health.txt dist/health.txt
          else
            echo "OK" > dist/health.txt
          fi
          # Sanity check for alias import resolution (VoicesSection expects quotes module)
          if grep -R "@/config/quotes" -n src/sections/VoicesSection.tsx >/dev/null 2>&1; then
            echo "Alias reference '@/config/quotes' present in VoicesSection.tsx"
          fi
      - name: Compute Integrity Hash
        run: |
          cd web
            node scripts/verify-inline-version.mjs --with-hash || exit 1
          cat dist/version-integrity.json || { echo "Integrity artifact missing"; exit 1; }
      - name: Upload Integrity Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: version-integrity
          path: web/dist/version-integrity.json
          retention-days: 10
      - name: Debug Dist Contents
        run: |
          echo "Listing built dist files:" 
          ls -R web/dist | head -100
          echo "Dist index.html preview:" 
          sed -n '1,120p' web/dist/index.html || true
          echo "Deploy marker:"; cat web/dist/DEPLOY_MARKER.txt || echo "(missing)"
          echo "Health file:"; cat web/dist/health.txt || echo "(missing)"
          # Enforce presence (fail early if not there)
          [ -f web/dist/DEPLOY_MARKER.txt ] || { echo "ERROR: DEPLOY_MARKER.txt missing"; exit 1; }
          [ -f web/dist/health.txt ] || { echo "ERROR: health.txt missing"; exit 1; }
      - name: Inject CNAME (main only, if custom domain)
        if: github.ref == 'refs/heads/main'
        run: |
          if [ -n "$CUSTOM_DOMAIN" ]; then echo "$CUSTOM_DOMAIN" > web/dist/CNAME; fi
      - name: Prepare Pages root directory
        run: |
          # Ensure artifact root contains site files (avoid nested 'dist/' in archive)
          rm -rf pages_site || true
          mkdir -p pages_site
          cp -a web/dist/. pages_site/
      - name: Upload artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: pages_site
      - name: Show artifact file list (post-upload)
        run: |
          echo "(Re)listing dist for sanity before deploy stage:" 
          find web/dist -maxdepth 2 -type f -print
      - name: Append to Transparency Log Issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issueTitle="Deployment Transparency Log"
          bodyLine=$(jq -r '. | "- $(.generatedAt) commit=${{ github.sha }} sha256=" + .sha256' web/dist/version-integrity.json)
          number=$(gh issue list --search "$issueTitle" --state open --json number,title --jq '.[0].number' || true)
          if [ -z "$number" ]; then
            gh issue create --title "$issueTitle" --body "### Transparency Log\n$bodyLine" --label observability || true
          else
            gh issue comment "$number" --body "$bodyLine" || true
          fi
  deploy:
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'github-pages' || 'preview' }}
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    # Needed for PR comment (write)
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
      - name: Extract PR Number
        if: ${{ github.event_name == 'pull_request' }}
        id: pr
        run: |
          # GITHUB_REF format: refs/pull/<pr-number>/merge
          ref_parts="${GITHUB_REF}"; echo "Ref: $ref_parts"
          pr_number=$(echo "$GITHUB_REF" | awk -F'/' '{print $3}')
          if [[ "$pr_number" =~ ^[0-9]+$ ]]; then echo "PR_NUMBER=$pr_number" >> $GITHUB_ENV; else echo "Unable to parse PR number"; exit 1; fi
      - name: Comment Preview URL (PR only)
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          set -e
          pr_number=$(echo "$GITHUB_REF" | awk -F'/' '{print $3}')
          echo "Parsed PR number: $pr_number"
          body="Preview environment deployed.%0AURL: ${PAGE_URL}%0ACommit: ${GITHUB_SHA}%0ABase path auto-detected"
          if command -v gh >/dev/null 2>&1; then
            gh api repos/${GITHUB_REPOSITORY}/issues/$pr_number/comments -f body="$body"
          else
            echo "Posting via curl fallback"
            curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
              -X POST https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/$pr_number/comments \
              -d "{\"body\":\"${body}\"}"
          fi
        env:
          PAGE_URL: ${{ steps.deployment.outputs.page_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

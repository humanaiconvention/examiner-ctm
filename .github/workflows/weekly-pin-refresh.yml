name: weekly-pin-refresh

on:
  schedule:
    - cron: '0 5 * * 1' # 05:00 UTC every Monday
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: read

jobs:
  pin-refresh-reminder:
    runs-on: ubuntu-latest
    steps:
      # Action Pin Table
      # | Action | Version | Commit SHA |
      # |--------|---------|------------|
      # | actions/checkout | v5.0.0 | 08c6903c... |
      # | actions/setup-node | v5.0.0 | a0853c24... |
      # | actions/cache | v4.3.0 | 0057852b... |
      # | actions/upload-artifact | v4.6.2 | ea165f8d... |
      # | actions/download-artifact | v5.0.0 | 634f93cb... |
      # | github/codeql-action | v3.30.5 | 3599b3ba... |
      # | actions/configure-pages | v5.0.0 | 983d7736... |
      # | actions/upload-pages-artifact | v4.0.0 | 7b1f4a76... |
      # | actions/deploy-pages | v4.0.5 | d6db9016... |
      # | peaceiris/actions-gh-pages | v4.0.0 | 4f9cc660... |
      # | Azure/static-web-apps-deploy | v1 | 1a947af9... |
      # | softprops/action-gh-release | v2.3.3 | 6cbd405e... |

      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Compile pin summary
        id: pins
        run: |
          echo 'PINS<<EOF' >> $GITHUB_OUTPUT
          echo '# Action Pin Summary' >> $GITHUB_OUTPUT
          echo '' >> $GITHUB_OUTPUT
          echo 'Collected from workflow headers. Refresh any that have newer majors:' >> $GITHUB_OUTPUT
          echo '' >> $GITHUB_OUTPUT
          grep -R "^# Action Pin Table" -n .github/workflows | cut -d: -f1 | while read f; do
            echo "## $(basename $f)" >> $GITHUB_OUTPUT
            # Print subsequent commented table lines until blank or non-comment
            awk '/^# Action Pin Table/{flag=1;next} /^$/ {flag=0} /^jobs:/ {flag=0} {if(flag){print}}' "$f" >> $GITHUB_OUTPUT
            echo '' >> $GITHUB_OUTPUT
          done
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Create or update issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TITLE="Weekly: Review & Refresh Action Pins"
          BODY_FILE="issue.md"
          printf "%s\n\nGenerated: %s\n\n%s" "$TITLE" "$(date -u +%Y-%m-%dT%H:%M:%SZ)" "${{ steps.pins.outputs.PINS }}" > "$BODY_FILE"
          EXISTING=$(gh issue list --search "$TITLE in:title state:open" --limit 1 --json number --jq '.[0].number' || true)
          if [ -n "$EXISTING" ]; then
            gh issue comment "$EXISTING" -F "$BODY_FILE"
            echo "Updated existing issue #$EXISTING"
          else
            gh issue create --title "$TITLE" --body-file "$BODY_FILE" --label maintenance
          fi

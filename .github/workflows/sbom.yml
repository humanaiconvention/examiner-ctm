name: sbom

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: '13 3 * * *' # daily 03:13 UTC for slight staggering
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: write
  id-token: write
  # artifact upload implicitly allowed

jobs:
  generate-sbom:
    runs-on: ubuntu-latest
    steps:
      # Action Pin Table
      # | Action | Version | Commit SHA |
      # |--------|---------|------------|
      # | actions/checkout | v5.0.0 | 08c6903c... |
      # | actions/setup-node | v5.0.0 | a0853c24... |
      # | actions/upload-artifact | v4.6.2 | ea165f8d... |

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Use Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci --no-audit --no-fund

      - name: Generate CycloneDX (JSON)
        working-directory: web
        run: npx @cyclonedx/cyclonedx-npm --spec-version 1.5 --output-format json --output-file sbom/sbom.json

      - name: Generate CycloneDX (XML)
        working-directory: web
        run: npx @cyclonedx/cyclonedx-npm --spec-version 1.5 --output-format xml --output-file sbom/sbom.xml

      - name: Summarize SBOM components
        id: summary
        working-directory: web
        run: |
          COUNT=$(jq '.components | length' sbom/sbom.json)
          echo "component_count=$COUNT" >> $GITHUB_OUTPUT
          echo "First 5 components:" >> $GITHUB_STEP_SUMMARY
          jq -r '.components[0:5][] | "- \(.name)@\(.version)"' sbom/sbom.json >> $GITHUB_STEP_SUMMARY || true
          echo "\nTotal components: $COUNT" >> $GITHUB_STEP_SUMMARY

      - name: Upload SBOM JSON
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
            name: sbom-json
            path: web/sbom/sbom.json
            if-no-files-found: error

      - name: Upload SBOM XML
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
            name: sbom-xml
            path: web/sbom/sbom.xml
            if-no-files-found: error

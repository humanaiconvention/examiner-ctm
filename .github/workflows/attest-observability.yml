name: attest-observability

on:
  schedule:
    - cron: '42 4 * * 1' # Weekly Monday 04:42 UTC
  workflow_dispatch:
    inputs:
      resourceGroup:
        description: 'Azure Resource Group'
        required: true
      appInsightsName:
        description: 'Application Insights resource name'
        required: true
      workbookName:
        description: 'Workbook resource name (Bicep workbookName)'
        required: true
      signAttestation:
        description: 'Set to true to sign attestation with cosign'
        required: false
        default: 'false'

permissions:
  id-token: write
  contents: read

jobs:
  attest:
    runs-on: ubuntu-latest
    env:
      RG: ${{ inputs.resourceGroup }}
      AI_NAME: ${{ inputs.appInsightsName }}
      WORKBOOK_NAME: ${{ inputs.workbookName }}
      SIGN: ${{ inputs.signAttestation }}
    steps:
      - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4.1.0

      - name: Azure Login (OIDC)
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Resolve Workbook Id
        id: wb
        run: |
          ID=$(az resource show -g "$RG" -n "$WORKBOOK_NAME" --resource-type microsoft.insights/workbooks --query id -o tsv || true)
          if [ -z "$ID" ]; then echo "::error::Workbook $WORKBOOK_NAME not found"; exit 1; fi
          echo "id=$ID" >> $GITHUB_OUTPUT

      - name: Hash Sources
        id: hashes
        run: |
          set -e
          WB_SHA=$(sha256sum azure-workbook.json | awk '{print $1}')
          ALERTS_SHA=$(sha256sum alerts.bicep | awk '{print $1}')
          WORKBOOK_BICEP_SHA=$(sha256sum workbook.bicep | awk '{print $1}')
          echo "wb_sha=$WB_SHA" >> $GITHUB_OUTPUT
          echo "alerts_sha=$ALERTS_SHA" >> $GITHUB_OUTPUT
          echo "workbook_bicep_sha=$WORKBOOK_BICEP_SHA" >> $GITHUB_OUTPUT
          echo "Computed local hashes"

      - name: Extract Threshold Defaults
        id: thresh
        run: |
          # naive grep+awk parse of parameter default values (robust enough for controlled file)
          LCP=$(grep -E 'param lcpP75Threshold int' alerts.bicep | awk -F'= ' '{print $2}')
          FETCH=$(grep -E 'param fetchFailureThreshold float' alerts.bicep | awk -F'= ' '{print $2}')
          INP=$(grep -E 'param inpP75Threshold int' alerts.bicep | awk -F'= ' '{print $2}')
          echo "lcp=$LCP" >> $GITHUB_OUTPUT
          echo "fetch=$FETCH" >> $GITHUB_OUTPUT
          echo "inp=$INP" >> $GITHUB_OUTPUT
          echo "Parsed thresholds: LCP=$LCP INP=$INP FETCH_FAIL_RATE=$FETCH"

      - name: Fetch Live Workbook
        id: live
        run: |
          RAW=$(az resource show --ids "${{ steps.wb.outputs.id }}" -o json)
          DEPLOYED=$(echo "$RAW" | jq -r '.properties.serializedData' | jq -c .)
          echo "$DEPLOYED" > deployed-workbook.json
          DEPLOYED_SHA=$(sha256sum deployed-workbook.json | awk '{print $1}')
          echo "deployed_sha=$DEPLOYED_SHA" >> $GITHUB_OUTPUT

      - name: Capture Alert Catalog
        id: catalog
        run: |
          LIST=$(az monitor scheduled-query list -g "$RG" -o json)
          echo "$LIST" | jq '[.[] | select(.tags["haic.observability"]=="true") | {metric: .tags["haic.metric"], resourceId: .id, threshold: .properties.criteria.allOf[0].threshold}]' > alert-catalog.json
          echo "catalog_path=alert-catalog.json" >> $GITHUB_OUTPUT

      - name: Determine Schema Version
        id: schema
        run: |
          BASE=$(cat observability-thresholds-baseline.json)
          LCP_BASE=$(echo $BASE | jq -r '.lcpP75Ms')
          INP_BASE=$(echo $BASE | jq -r '.inpP75Ms')
          FETCH_BASE=$(echo $BASE | jq -r '.fetchFailureRate')
          LCP=${{ steps.thresh.outputs.lcp }}
          INP=${{ steps.thresh.outputs.inp }}
          FETCH=${{ steps.thresh.outputs.fetch }}
          SCHEMA_BASE=1
          BUMP=0
          [ "$LCP_BASE" != "$LCP" ] && BUMP=1
          [ "$INP_BASE" != "$INP" ] && BUMP=1
            # Compare floats with epsilon
          awk -v a=$FETCH_BASE -v b=$FETCH 'BEGIN { d=a-b; if (d<0) d=-d; if (d>1e-9) exit 1 }' || BUMP=1
          if [ $BUMP -eq 1 ]; then VER=$((SCHEMA_BASE+1)); else VER=$SCHEMA_BASE; fi
          echo "version=$VER" >> $GITHUB_OUTPUT
          echo "schema_version=$VER" >> $GITHUB_OUTPUT
          echo "Chosen schemaVersion=$VER (bump=$BUMP)"

      - name: Generate Attestation
        run: |
          TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          cat > observability-attestation.json <<EOF
          {
            "schemaVersion": ${{ steps.schema.outputs.version }},
            "generatedAt": "$TS",
            "commit": "${GITHUB_SHA}",
            "workbook": {
              "sourceSha": "${{ steps.hashes.outputs.wb_sha }}",
              "deployedSha": "${{ steps.live.outputs.deployed_sha }}",
              "bicepSha": "${{ steps.hashes.outputs.workbook_bicep_sha }}"
            },
            "alerts": {
              "bicepSha": "${{ steps.hashes.outputs.alerts_sha }}",
              "thresholds": {
                "lcpP75Ms": ${{ steps.thresh.outputs.lcp }},
                "inpP75Ms": ${{ steps.thresh.outputs.inp }},
                "fetchFailureRate": ${{ steps.thresh.outputs.fetch }}
              },
              "catalog": $(cat alert-catalog.json)
            }
          }
          EOF
          echo "Attestation written"

      - name: Validate Attestation Schema
        run: |
          npm init -y >/dev/null 2>&1 || true
          npm install ajv-cli@5.0.0 --no-audit --no-fund >/dev/null 2>&1
          npx ajv validate -s observability-attestation.schema.json -d observability-attestation.json --spec=draft2020 || { echo '::error::Schema validation failed'; exit 1; }

      - name: Sign Attestation (Optional)
        if: env.SIGN == 'true'
        run: |
          if ! command -v cosign >/dev/null; then
            COSIGN_VERSION=2.2.4; curl -sSL -o cosign.tgz "https://github.com/sigstore/cosign/releases/download/v${COSIGN_VERSION}/cosign-linux-amd64.tgz" && tar -xzf cosign.tgz && sudo mv cosign /usr/local/bin/cosign; fi
          cosign version || true
          cosign sign-blob --yes observability-attestation.json > observability-attestation.sig
          echo "Signed attestation"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: observability-attestation
          path: |
            observability-attestation.json
            observability-attestation.sig

      - name: Summary
        run: |
          echo "### Observability Attestation" >> $GITHUB_STEP_SUMMARY
          echo "Workbook source SHA: ${{ steps.hashes.outputs.wb_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "Workbook deployed SHA: ${{ steps.live.outputs.deployed_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "Alerts bicep SHA: ${{ steps.hashes.outputs.alerts_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "Schema Version: ${{ steps.schema.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "Catalog entries: $(jq length alert-catalog.json)" >> $GITHUB_STEP_SUMMARY
          echo "Thresholds: LCP=${{ steps.thresh.outputs.lcp }} INP=${{ steps.thresh.outputs.inp }} FetchFailRate=${{ steps.thresh.outputs.fetch }}" >> $GITHUB_STEP_SUMMARY
          echo "Signing: $([[ "$SIGN" == 'true' ]] && echo 'enabled' || echo 'disabled')" >> $GITHUB_STEP_SUMMARY

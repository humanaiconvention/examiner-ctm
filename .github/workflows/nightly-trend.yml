name: Nightly Quality Trend

on:
  schedule:
    - cron: '15 2 * * *' # 02:15 UTC nightly
  workflow_dispatch:

permissions:
  contents: write
  actions: read

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  MIN_COVERAGE: 70

jobs:
  trend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: 20
          cache: npm
      - name: Install deps (root + web)
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Run Lint/Test/Coverage (subset)
        run: |
          npm run lint:report --workspace web || echo '{}' > web/eslint-report.json
          npm run test:coverage --workspace web || echo '{}' > web/coverage/coverage-summary.json
          npm run test:report --workspace web || echo '{}' > web/test-report/results.json
      - name: Aggregate Problem Budget (trend)
        run: node web/scripts/problem-budget.mjs || true
      - name: Append Trend History
        run: |
          set -e
          mkdir -p metrics
          out=metrics/trend-history.json
          summary=web/problem-budget-summary.json
          today=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          entry=$(jq -n --arg date "$today" --slurpfile s $summary '{date:$date, summary:$s[0]}')
          if [ -f $out ]; then
            tmp=$(mktemp)
            jq --argjson entry "$entry" '. + [$entry]' --slurpfile entry <(echo $entry) $out > $tmp || true
            # Simpler append to array
            jq '. + [$entry]' --argjson entry "$entry" $out > $tmp || echo '['$entry']' > $tmp
            mv $tmp $out
          else
            echo "[$entry]" > $out
          fi
          echo "Trend points: $(jq 'length' $out)"
      - name: Commit Trend History
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name 'github-actions[bot]'
            git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add metrics/trend-history.json
          if git diff --cached --quiet; then echo 'No trend changes'; exit 0; fi
          git commit -m 'chore: update trend history (ci)' || exit 0
          git pull --ff-only origin main || true
          git push origin HEAD:main || echo 'Push failed (race)'
      - name: Slack Notify (Trend)
        if: env.SLACK_WEBHOOK_URL != ''
        run: |
          node .github/scripts/slack-notify.mjs \
            --webhook "$SLACK_WEBHOOK_URL" \
            --event trend \
            --status info \
            --summary-file web/problem-budget-summary.json \
            --commit "$GITHUB_SHA" \
            --repo "$GITHUB_REPOSITORY" \
            --run-id "$GITHUB_RUN_ID" \
            --workflow "$GITHUB_WORKFLOW" || echo 'Slack trend notify failed'

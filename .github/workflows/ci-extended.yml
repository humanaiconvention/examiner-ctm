name: CI Extended

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  checks: write

env:
  NODE_VERSION: '20'

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install (root + workspace)
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Lint
        run: npm run lint
      - name: Type Check
        run: npm run typecheck
      - name: Unit Tests + Coverage
        run: |
          npm run test:coverage
          npm --workspace web run coverage:badge || echo "badge skipped"
      - name: Build (web)
        run: npm --workspace web run build
      - name: Analytics Chunk Size Budget
        run: npm --workspace web run size:analytics || (echo "Analytics size budget failed" && exit 1)
      - name: Asset Manifest Diff (snapshot on main)
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            npm --workspace web run manifest:snapshot
          else
            npm --workspace web run manifest:diff || true
          fi
      - name: Enforce Asset Size Budget
        run: |
          npm --workspace web run size:budget
      - name: Save manifest diff report
        if: always()
        run: |
          npm --workspace web run manifest:diff > web/asset-manifest-report.json || echo '{}' > web/asset-manifest-report.json
      - name: Upload Asset Manifest Report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: asset-manifest-report
          path: web/asset-manifest-report.json
          retention-days: 14
      - name: Upload Coverage Artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: coverage
          path: web/coverage
          retention-days: 14
      - name: Upload Coverage Badge
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: coverage-badge
          path: web/coverage/badge-coverage.svg
          retention-days: 14

  playwright:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install
        run: |
          npm ci
          npx playwright install --with-deps
      - name: Build
        run: npm run build --workspace web
      - name: Playwright Tests
        run: npm run test:playwright --workspace web
      - name: Upload Playwright Report (if exists)
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: playwright-report
          path: web/playwright-report
          retention-days: 7

  lighthouse:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install
        run: |
          npm ci
      - name: Build Web
        run: npm run build --workspace web
      - name: Lighthouse CI
        working-directory: web
        run: npx lhci autorun --config=lighthouserc.json || echo "Lighthouse failures (budget)"
      - name: Upload Lighthouse Artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: lighthouse-report
          path: web/lhci-report
          retention-days: 7

  lighthouse-mobile:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install
        run: npm ci
      - name: Build Web
        run: npm run build --workspace web
      - name: Lighthouse CI (mobile)
        working-directory: web
        run: npx lhci autorun --config=lighthouserc.mobile.json || echo "Mobile Lighthouse failures (budget)"
      - name: Upload Lighthouse Mobile Artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: lighthouse-report-mobile
          path: web/lhci-report-mobile
          retention-days: 7

  publish-badge:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [build-test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install root and web
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Recreate Coverage Badge (defense-in-depth)
        run: |
          npm --workspace web run test:coverage -- --reporter=json-summary --coverage=false || true
          npm --workspace web run coverage:badge || true
          # Build to produce latest dist and manifest snapshot
          npm --workspace web run build || true
          node web/scripts/asset-manifest-diff.mjs --snapshot || true
      - name: Publish badge to gh-pages
        run: |
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          BADGE_DIR=web/coverage
          TARGET_BRANCH=gh-pages
          mkdir -p badge-tmp
          cp $BADGE_DIR/badge-coverage.svg badge-tmp/ || true
          cp $BADGE_DIR/coverage-summary.json badge-tmp/ || true
          # Copy manifest snapshot
          cp web/.asset-manifest.json badge-tmp/asset-manifest.json || true
          git fetch origin $TARGET_BRANCH || echo "no gh-pages yet"
          if git rev-parse --verify origin/$TARGET_BRANCH; then
            git checkout $TARGET_BRANCH
          else
            git checkout --orphan $TARGET_BRANCH
          fi
          mkdir -p coverage
          mv badge-tmp/badge-coverage.svg coverage/ 2>/dev/null || true
          mv badge-tmp/coverage-summary.json coverage/ 2>/dev/null || true
          mkdir -p assets
          mv badge-tmp/asset-manifest.json assets/ 2>/dev/null || true
          rm -rf badge-tmp
          git add coverage/badge-coverage.svg coverage/coverage-summary.json assets/asset-manifest.json
          if git diff --cached --quiet; then
            echo "No badge changes to commit";
          else
            git commit -m "chore: update coverage badge [skip ci]" || true
            git push origin $TARGET_BRANCH
          fi
          # Return to main (not strictly necessary in CI)
          git checkout -

  pr-report:
    if: github.event_name == 'pull_request'
    needs: [build-test, lighthouse, lighthouse-mobile]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install web workspace (dev deps optional)
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Download coverage artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: coverage
          path: coverage-artifact
      - name: Download lighthouse artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: lighthouse-report
          path: lighthouse-artifact
      - name: Download lighthouse mobile artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: lighthouse-report-mobile
          path: lighthouse-artifact-mobile
      - name: Download asset manifest artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: asset-manifest-report
          path: asset-manifest-artifact
      - name: Fetch baseline coverage from gh-pages
        run: |
          git fetch origin gh-pages || true
          if git rev-parse --verify origin/gh-pages; then
            git show origin/gh-pages:coverage/coverage-summary.json > baseline-coverage.json || echo '{}' > baseline-coverage.json
          else
            echo '{}' > baseline-coverage.json
          fi
          if git rev-parse --verify origin/gh-pages; then
            git show origin/gh-pages:assets/asset-manifest.json > baseline-asset-manifest.json || echo '{}' > baseline-asset-manifest.json
          else
            echo '{}' > baseline-asset-manifest.json
          fi
      - name: Compute coverage delta
        id: coverage
        run: |
          node web/scripts/coverage-delta.mjs --base baseline-coverage.json > coverage-delta.json
          echo "delta=$(cat coverage-delta.json | jq -r '.')" >> $GITHUB_OUTPUT
      - name: Run asset manifest diff for PR comment
        run: |
          npm --workspace web run manifest:diff > asset-manifest-diff.json || echo '{}' > asset-manifest-diff.json
      - name: Extract Lighthouse key metrics
        id: lh
        run: |
          REPORT_JSON=$(ls lighthouse-artifact/*.json | head -n 1 || echo '')
          REPORT_JSON_MOBILE=$(ls lighthouse-artifact-mobile/*.json | head -n 1 || echo '')
          if [ -f "$REPORT_JSON" ]; then
            SCORE_PERF=$(jq '.categories.performance.score' "$REPORT_JSON")
            SCORE_ACC=$(jq '.categories.accessibility.score' "$REPORT_JSON")
            FCP=$(jq '.audits["first-contentful-paint"].numericValue' "$REPORT_JSON")
            LCP=$(jq '.audits["largest-contentful-paint"].numericValue' "$REPORT_JSON")
            TBT=$(jq '.audits["total-blocking-time"].numericValue' "$REPORT_JSON")
            CLS=$(jq '.audits["cumulative-layout-shift"].numericValue' "$REPORT_JSON")
          else
            SCORE_PERF=; SCORE_ACC=; FCP=; LCP=; TBT=; CLS=;
          fi
          if [ -f "$REPORT_JSON_MOBILE" ]; then
            SCORE_PERF_M=$(jq '.categories.performance.score' "$REPORT_JSON_MOBILE")
            SCORE_ACC_M=$(jq '.categories.accessibility.score' "$REPORT_JSON_MOBILE")
            FCP_M=$(jq '.audits["first-contentful-paint"].numericValue' "$REPORT_JSON_MOBILE")
            LCP_M=$(jq '.audits["largest-contentful-paint"].numericValue' "$REPORT_JSON_MOBILE")
            TBT_M=$(jq '.audits["total-blocking-time"].numericValue' "$REPORT_JSON_MOBILE")
            CLS_M=$(jq '.audits["cumulative-layout-shift"].numericValue' "$REPORT_JSON_MOBILE")
          else
            SCORE_PERF_M=; SCORE_ACC_M=; FCP_M=; LCP_M=; TBT_M=; CLS_M=;
          fi
          {
            echo "scorePerf=$SCORE_PERF";
            echo "scoreAcc=$SCORE_ACC";
            echo "fcp=$FCP";
            echo "lcp=$LCP";
            echo "tbt=$TBT";
            echo "cls=$CLS";
            echo "scorePerfMobile=$SCORE_PERF_M";
            echo "scoreAccMobile=$SCORE_ACC_M";
            echo "fcpMobile=$FCP_M";
            echo "lcpMobile=$LCP_M";
            echo "tbtMobile=$TBT_M";
            echo "clsMobile=$CLS_M";
          } >> $GITHUB_OUTPUT
      - name: Post / Update PR comment
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const core = require('@actions/core');
            const {context, github} = require('@actions/github');
            const pr = context.payload.pull_request;
            if (!pr) { core.info('No PR context'); return; }
            const number = pr.number;
            // Build coverage delta summary
            const fs = require('fs');
            let coverageDelta = {};
            try { coverageDelta = JSON.parse(fs.readFileSync('coverage-delta.json','utf8')); } catch {}
            let assetDiff = {};
            let baselineManifest = {};
            try { assetDiff = JSON.parse(fs.readFileSync('asset-manifest-artifact/asset-manifest-report.json','utf8')); } catch {}
            try { baselineManifest = JSON.parse(fs.readFileSync('baseline-asset-manifest.json','utf8')); } catch {}
            const currentManifest = assetDiff.manifest || {};
            const SOFT_RAW_WARN = 250*1024; // 250 KB
            function fmt(b){ if(b==null) return '—'; if (b>1024*1024) return (b/1024/1024).toFixed(2)+'MB'; if (b>1024) return (b/1024).toFixed(1)+'KB'; return b+'B'; }
            function rawOf(v){ return typeof v === 'number' ? v : v?.raw; }
            function gzipOf(v){ return typeof v === 'object' ? v?.gzip : null; }
            function brOf(v){ return typeof v === 'object' ? v?.brotli : null; }
            const allFiles = Array.from(new Set([...Object.keys(baselineManifest), ...Object.keys(currentManifest)]));
            const annotated = allFiles.map(f => {
              const prev = baselineManifest[f];
              const cur = currentManifest[f];
              if (!cur) return { file: f, status: 'REMOVED', prevRaw: rawOf(prev) };
              if (!prev) return { file: f, status: 'ADDED', curRaw: rawOf(cur), curGzip: gzipOf(cur), curBr: brOf(cur) };
              const prevRaw = rawOf(prev); const curRaw = rawOf(cur);
              const delta = curRaw - prevRaw;
              const prevGzip = gzipOf(prev); const curGzip = gzipOf(cur);
              const prevBr = brOf(prev); const curBr = brOf(cur);
              const gzDelta = (curGzip!=null && prevGzip!=null) ? curGzip - prevGzip : null;
              return { file: f, status: delta===0 ? 'SAME' : 'CHANGED', prevRaw, curRaw, delta, prevGzip, curGzip, gzDelta, prevBr, curBr };
            });
            // Filter out unchanged for table brevity except top size offenders
            const interesting = annotated.filter(r => r.status !== 'SAME' || rawOf(currentManifest[r.file]) > 80*1024);
            interesting.sort((a,b)=> (b.curRaw || b.prevRaw || 0) - (a.curRaw || a.prevRaw || 0));
            const rows = interesting.slice(0,25);
            const assetLines = rows.length ? [
              '| File | Status | Raw (prev→curr) | Δ | Gzip (prev→curr) | Raw Warn |',
              '|------|--------|-----------------|----|------------------|---------|',
              ...rows.map(r => {
                if (r.status === 'REMOVED') return `| ${r.file} | REMOVED | ${fmt(r.prevRaw)}→— | — | — | — |`;
                if (r.status === 'ADDED') {
                  const warn = r.curRaw > SOFT_RAW_WARN ? '⚠️' : '';
                  return `| ${r.file} | ADDED | —→${fmt(r.curRaw)} | +${fmt(r.curRaw)} | —→${fmt(r.curGzip)} | ${warn} |`;
                }
                const warn = r.curRaw > SOFT_RAW_WARN ? '⚠️' : '';
                const deltaStr = r.delta === 0 ? '0' : (r.delta>0? '+'+fmt(r.delta) : fmt(r.delta));
                const rawCol = `${fmt(r.prevRaw)}→${fmt(r.curRaw)}`;
                const gzipCol = (r.prevGzip!=null||r.curGzip!=null) ? `${fmt(r.prevGzip)}→${fmt(r.curGzip)}` : '—';
                return `| ${r.file} | ${r.status} | ${rawCol} | ${deltaStr} | ${gzipCol} | ${warn} |`;
              })
            ] : ['No asset changes'];
            const lines = [];
            if (coverageDelta.metrics) {
              lines.push('| Metric | Previous | Current | Δ |');
              lines.push('|--------|----------|---------|---|');
              for (const [k,v] of Object.entries(coverageDelta.metrics)) {
                lines.push(`| ${k} | ${v.previous ?? '—'} | ${v.current?.toFixed?.(1) ?? v.current} | ${v.delta == null ? '—' : (v.delta >= 0 ? '+'+v.delta : v.delta)} |`);
              }
              if (coverageDelta.averageDelta != null) lines.push(`\nAverage Δ: ${coverageDelta.averageDelta >=0 ? '+' : ''}${coverageDelta.averageDelta}`);
            } else {
              lines.push('Coverage data unavailable.');
            }
            const perfScore = core.getInput('scorePerf'); // not available via inputs, using env fallback
            const bodyHeader = '### QA Automation Summary';
            const lh = {
              perf: process.env.SCORE_PERF || '${{ steps.lh.outputs.scorePerf }}',
              acc: process.env.SCORE_ACC || '${{ steps.lh.outputs.scoreAcc }}',
              fcp: '${{ steps.lh.outputs.fcp }}',
              lcp: '${{ steps.lh.outputs.lcp }}',
              tbt: '${{ steps.lh.outputs.tbt }}',
              cls: '${{ steps.lh.outputs.cls }}',
              perfM: '${{ steps.lh.outputs.scorePerfMobile }}',
              accM: '${{ steps.lh.outputs.scoreAccMobile }}',
              fcpM: '${{ steps.lh.outputs.fcpMobile }}',
              lcpM: '${{ steps.lh.outputs.lcpMobile }}',
              tbtM: '${{ steps.lh.outputs.tbtMobile }}',
              clsM: '${{ steps.lh.outputs.clsMobile }}'
            };
            function grade(score, target){ if (score===''||score==null) return '—'; return (parseFloat(score) >= target ? '✅' : '❌') + ' ' + score; }
            const desktopLine = `Perf: ${grade(lh.perf,0.9)} | Acc: ${grade(lh.acc,0.9)} | FCP: ${lh.fcp}ms | LCP: ${lh.lcp}ms | TBT: ${lh.tbt}ms | CLS: ${lh.cls}`;
            const mobileLine = `Perf: ${grade(lh.perfM,0.85)} | Acc: ${grade(lh.accM,0.9)} | FCP: ${lh.fcpM}ms | LCP: ${lh.lcpM}ms | TBT: ${lh.tbtM}ms | CLS: ${lh.clsM}`;
            const body = `${bodyHeader}\n\n**Coverage**\n\n${lines.join('\n')}\n\n**Lighthouse**\n\nDesktop: ${desktopLine}\n\nMobile: ${mobileLine}\n\n**Asset Changes (filtered)**\n\n${assetLines.join('\n')}`;
            const tag = '<!-- qa-automation-summary -->';
            const finalBody = body + '\n' + tag;
            const {data: comments} = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              per_page: 100
            });
            const existing = comments.find(c => c.body && c.body.includes(tag));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: finalBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                body: finalBody
              });
            }

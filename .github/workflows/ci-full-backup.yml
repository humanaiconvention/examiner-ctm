# Full CI workflow backup (preserved while CI is paused)
# Restore by renaming to ci.yml and removing the paused stub.

name: CI
################################################################################
# Action Pin Table (Generated 2025-09-28)
# actions/checkout v5.0.0 08c6903cd8c0fde910a37f88322edcfb5dd907a8
# actions/setup-node v5.0.0 a0853c24544627f65ddf259abe73b1d18a591444
# actions/upload-artifact v4.6.2 ea165f8d65b6e75b540449e92b4886f43607fa02
# actions/download-artifact v5.0.0 634f93cb2916e3fdff6788551b99b062d0335ce0
# actions/cache v4.3.0 0057852bfaa89a56745cba8c7296529d2fc39830
# peter-evans/find-comment v3.1.0 3eae4d37986fb5a8592848f6a574fdf654e61f9e
# peter-evans/create-or-update-comment v4.0.0 71345be0265236311c031f5c7866368bd1eff043
################################################################################

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup-and-build:
    name: Build Artifact
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: '20'
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install Dependencies (root + workspace)
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Lint
        run: npm run lint
      - name: Type Check
        run: npm run typecheck
      - name: Unit Tests
        run: npm test
      - name: Coverage
        run: |
          echo "Running coverage (non-blocking if script absent)" 
          npm run test:coverage || echo "Coverage script failed or missing; continuing"
      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-report
          path: web/coverage
          if-no-files-found: ignore
          retention-days: 5
      - name: Build
        run: npm run build
      - name: Bundle Size Check
        working-directory: web
        run: |
          set -e
          if npm run | grep -q "size:check"; then
            npm run size:check | tee ../size-status.txt || echo "Size check failed";
          else
            echo "No size:check script present" | tee ../size-status.txt
          fi
      - name: Upload Size Status
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: size-status
          path: size-status.txt
          if-no-files-found: ignore
          retention-days: 3
      - name: Upload Dist Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: dist-build
          path: web/dist
          retention-days: 5

  e2e:
    name: E2E & Accessibility
    runs-on: ubuntu-latest
    needs: setup-and-build
    env:
      NODE_VERSION: '20'
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install Dependencies (root + workspace)
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Compute Week Key
        id: week
        run: |
          WEEK_KEY=$(date +%G-%V)
          echo "CACHE_WEEK=$WEEK_KEY" >> $GITHUB_ENV
          echo "week=$WEEK_KEY" >> $GITHUB_OUTPUT
      - name: Restore Previous Snapshots Cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: web/previous-snapshots
          key: visual-snapshots-${{ steps.week.outputs.week }}-${{ github.run_id }}
          restore-keys: |
            visual-snapshots-${{ steps.week.outputs.week }}-
            visual-snapshots-
      - name: Restore Previous Perf Marks Cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: web/previous-perf
          key: perf-marks-${{ steps.week.outputs.week }}-${{ github.run_id }}
          restore-keys: |
            perf-marks-${{ steps.week.outputs.week }}-
            perf-marks-
      - name: Prepare Historical Assets
        working-directory: web
        run: |
          mkdir -p previous-snapshots
          if [ -d previous-snapshots ] && [ "$(ls -A previous-snapshots 2>/dev/null)" ]; then echo "Previous snapshots present"; fi
          if [ -f previous-perf/perf-marks.json ]; then cp previous-perf/perf-marks.json prev-perf-marks.json || true; fi
      - name: Run Playwright Tests
        run: npm run test:e2e
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
            name: playwright-report
            path: web/playwright-report
            retention-days: 5
      - name: Accessibility Audit
        working-directory: web
        run: |
          npm run preview &
          npx wait-on http://localhost:4173 || sleep 5
          node scripts/a11y-check.mjs || (echo "A11Y check failed" && exit 1)
      - name: Upload Accessibility Report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: accessibility-report
          path: web/a11y-report.json
          retention-days: 5
      - name: Visual Regression Snapshots
        working-directory: web
        run: |
          npm run preview &
          npx wait-on http://localhost:4173 || sleep 5
          npm run test:visual || echo "Visual tests failed (will rely on diff gating)"
      - name: Visual Diff Report
        working-directory: web
        run: |
          node scripts/visual-diff-report.mjs
      - name: Collect Performance Marks
        working-directory: web
        run: |
          PERF_URL=http://localhost:4173 npm run perf:marks
      - name: Perf Mark Governance (main only)
        if: github.ref == 'refs/heads/main'
        working-directory: web
        run: |
          node scripts/check-perf-marks.mjs
      - name: Upload Visual & Perf Artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: visual-perf-artifacts
          path: |
            web/perf-marks.json
            web/visual-diff-summary.json
            web/visual-diff
            web/tests/visual.spec.ts-snapshots
          retention-days: 5
      - name: Save Current Snapshots to Cache (main only)
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p web/previous-snapshots
          cp -r web/tests/visual.spec.ts-snapshots/* web/previous-snapshots/ || true
      - name: Save Current Perf Marks to Cache (main only)
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p web/previous-perf
          cp web/perf-marks.json web/previous-perf/perf-marks.json || true

  lighthouse:
    name: Lighthouse Audits
    runs-on: ubuntu-latest
    needs: setup-and-build
    if: github.ref == 'refs/heads/main'
    env:
      NODE_VERSION: '20'
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
            node-version: ${{ env.NODE_VERSION }}
            cache: npm
      - name: Install Dependencies (root + workspace)
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Run Lighthouse CI
        working-directory: web
        run: |
          if [ -f lighthouse-budgets.json ]; then echo 'Using performance budgets'; else echo 'No budgets file'; fi
          npm run lhci -- --budgetsPath=./lighthouse-budgets.json || (echo "Lighthouse run failed" && exit 1)
      - name: Enforce Performance Budget
        working-directory: web
        run: npm run perf:check
      - name: Enforce Lighthouse Category Thresholds
        working-directory: web
        run: node scripts/check-lighthouse-thresholds.mjs
      - name: Compute Week Key (for baseline cache)
        id: week_lh
        run: echo "WEEK_KEY=$(date +%G-%V)" >> $GITHUB_ENV && echo "week=$WEEK_KEY" >> $GITHUB_OUTPUT
      - name: Prepare Baseline Copy
        working-directory: web
        run: |
          cp -r .lighthouseci .lighthouseci-baseline || true
      - name: Cache Lighthouse Baseline (week scoped)
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: web/.lighthouseci-baseline
          key: lighthouse-baseline-${{ steps.week_lh.outputs.week }}-${{ github.run_id }}
          restore-keys: |
            lighthouse-baseline-${{ steps.week_lh.outputs.week }}-
            lighthouse-baseline-
      - name: Upload LHCI Results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: lighthouse-results
          path: web/.lighthouseci
          retention-days: 5
  badge-metrics:
    name: Badge Metrics
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [setup-and-build, lighthouse]
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: 20
          cache: npm
      - name: Install Dependencies (web only)
        run: cd web && npm ci
      - name: Rebuild (ensure dist present)
        working-directory: web
        run: npm run build
      - name: Download Lighthouse results
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: lighthouse-results
          path: web/.lighthouseci
        continue-on-error: true
      - name: Include Last Successful Lighthouse Thresholds (if present)
        run: |
          if [ -f badges/lighthouse-last-success.json ]; then cp badges/lighthouse-last-success.json badges/lighthouse-last-success.json; fi || true
      - name: Download Visual & Perf Artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: visual-perf-artifacts
          path: web
        continue-on-error: true
      - name: Download Accessibility Report
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: accessibility-report
          path: web
        continue-on-error: true
      - name: Download Coverage Report
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: coverage-report
          path: web/coverage
        continue-on-error: true
      - name: Generate Metrics JSON
        working-directory: web
        run: node scripts/generate-badge-metrics.mjs
      - name: Generate Aggregate Metrics
        working-directory: web
        run: node scripts/generate-aggregate-metrics.mjs || echo "aggregate generation failed"
      - name: Update History
        working-directory: web
        run: node scripts/update-history.mjs || echo "history update failed"
      - name: Prepare badge public path
        run: |
          mkdir -p badges
          cp web/badge-metrics.json badges/metrics.json
          cp web/aggregate-metrics.json badges/aggregate.json || true
          cp badges/aggregate-history.json badges/aggregate-history.json 2>/dev/null || true
          if [ -f badges/lighthouse-last-success.json ]; then git add badges/lighthouse-last-success.json; fi
          git add badges/metrics.json || true
          git add badges/aggregate.json || true
          if [ -f badges/aggregate-history.json ]; then git add badges/aggregate-history.json; fi
      - name: Commit Metrics
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add web/badge-metrics.json web/aggregate-metrics.json || true
          git diff --cached --quiet || git commit -m "chore(ci): update badge & aggregate metrics"
          git push

  analyze:
    name: Bundle Analyze (manual)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    env:
      NODE_VERSION: '20'
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install Dependencies (root + workspace)
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Build with Analyzer
        working-directory: web
        run: npm run analyze
      - name: Upload Bundle Stats
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: bundle-stats
          path: web/dist/stats.html
          retention-days: 5

  pr-summary:
    name: PR Quality Summary
    runs-on: ubuntu-latest
  if: ${{ github.event_name == 'pull_request' }}
    needs: [setup-and-build, e2e]
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: 20
          cache: npm
      - name: Install Dependencies (web only)
        run: cd web && npm ci
      - name: Compute Week Key (baseline restore)
        id: week_pr
        run: echo "WEEK_KEY=$(date +%G-%V)" >> $GITHUB_ENV && echo "week=$WEEK_KEY" >> $GITHUB_OUTPUT
      - name: Restore Lighthouse Baseline Cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: web/.lighthouseci-baseline
          key: lighthouse-baseline-${{ steps.week_pr.outputs.week }}-${{ github.run_id }}
          restore-keys: |
            lighthouse-baseline-${{ steps.week_pr.outputs.week }}-
            lighthouse-baseline-
      - name: Reuse Coverage Artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: coverage-report
          path: web/coverage
      - name: Reuse Size Status Artifact
        if: always()
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: size-status
          path: web
      - name: Reuse Accessibility Artifact
        if: always()
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: accessibility-report
          path: web
        continue-on-error: true
      - name: Reuse Visual & Perf Artifacts
        if: always()
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: visual-perf-artifacts
          path: web
        continue-on-error: true
      - name: Optional Lighthouse (main) Artifact
        if: always()
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: lighthouse-results
          path: web/.lighthouseci
        continue-on-error: true
      - name: Optional Lighthouse PR Artifact
        if: always()
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: lighthouse-pr
          path: web/.lighthouseci
        continue-on-error: true
      - name: Generate Aggregate Metrics
        working-directory: web
        run: node scripts/generate-aggregate-metrics.mjs || echo "aggregate generation failed"
      - name: Upload Aggregate Metrics
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: aggregate-metrics
          path: web/aggregate-metrics.json
          retention-days: 5
      - name: Generate Summary Markdown
        working-directory: web
        id: gen
        run: |
          node scripts/pr-summary.mjs > ../pr-comment.md
          echo "comment<<EOF" >> $GITHUB_OUTPUT
          cat ../pr-comment.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Post PR Quality Comment
        if: github.event_name == 'pull_request'
        run: |
          set -e
          pr_number=$(echo "$GITHUB_REF" | awk -F'/' '{print $3}')
          echo "PR number parsed: $pr_number"
          body_file=pr-comment.md
          printf "%s" "${COMMENT_BODY}" > "$body_file"
          # Try gh first for update-or-create behavior
          if command -v gh >/dev/null 2>&1; then
            # Find existing
            existing_id=$(gh api repos/${GITHUB_REPOSITORY}/issues/$pr_number/comments --paginate -q \
              '.[] | select(.user.login=="github-actions[bot]" and (.body|contains("### QA Summary"))) | .id' | head -n1 || true)
            if [ -n "$existing_id" ]; then
              echo "Updating existing comment $existing_id"
              gh api repos/${GITHUB_REPOSITORY}/issues/comments/$existing_id -X PATCH -f body=@$body_file
            else
              echo "Creating new comment"
              gh api repos/${GITHUB_REPOSITORY}/issues/$pr_number/comments -f body=@$body_file
            fi
          else
            echo "gh not available; creating new comment via curl"
            escaped=$(jq -Rs . < "$body_file")
            curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
              -X POST https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/$pr_number/comments \
              -d "{\"body\":${escaped}}" >/dev/null
          fi
        env:
          COMMENT_BODY: ${{ steps.gen.outputs.comment }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  lighthouse-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: setup-and-build
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: web/package-lock.json
      - name: Install deps
        working-directory: web
        run: npm ci
      - name: Build (web)
        working-directory: web
        run: npm run build --if-present
      - name: Run Lighthouse (PR)
        working-directory: web
        run: npm run lhci || echo "(non-blocking) Lighthouse collection failed; continuing"
      - name: Check Performance Budget
        working-directory: web
        run: npm run perf:check
      - name: Upload Lighthouse Artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: lighthouse-pr
          path: web/.lighthouseci
          if-no-files-found: warn

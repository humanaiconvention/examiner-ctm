<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Features | humanaiconvention</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Features" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A reproducible and scalable framework for ethical AI design, grounded in human data and public-benefit insfrastructure" />
<meta property="og:description" content="A reproducible and scalable framework for ethical AI design, grounded in human data and public-benefit insfrastructure" />
<link rel="canonical" href="http://www.humanaiconvention.com/" />
<meta property="og:url" content="http://www.humanaiconvention.com/" />
<meta property="og:site_name" content="humanaiconvention" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Features" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebSite","description":"A reproducible and scalable framework for ethical AI design, grounded in human data and public-benefit insfrastructure","headline":"Features","name":"humanaiconvention","url":"http://www.humanaiconvention.com/"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=ac911d5e2014ccbc1508ce3794f0fc5048fdb5f6">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://www.humanaiconvention.com/">humanaiconvention</a></h1>
      

      <h2 id="features">Features</h2>
<ul>
  <li>License-aware SBOM component diff with add/remove/version/license change tracking.</li>
  <li>Lightweight Sigstore policy (audit mode) &amp; verification step.</li>
  <li>Optional PR Preview Password Lock (client-side) for ephemeral deployments.</li>
  <li>Strict quality gating: lint (zero warnings), typecheck, unit tests must pass before any build/deploy job executes.</li>
  <li>Secret preflight gating: production / preview deploys only run when required secrets are present (explicit skip vs silent failure).</li>
</ul>

<h2 id="taglines">Taglines</h2>
<p><strong>Primary:</strong> We will know — together.<br />
<strong>Secondary (epistemic anchor):</strong> Trust isn’t a feeling. It’s evidence.</p>

<p>Primary expresses collaborative epistemic purpose. Secondary frames our verification philosophy—evidence over sentiment. Both are intentionally un-trademarked; usage is non-commercial, public-benefit, remixable.</p>

<h2 id="attribution--usage">Attribution &amp; Usage</h2>
<p>Taglines may be reused or remixed under the project license with attribution, provided usage aligns with public-benefit and participatory principles.</p>

<h2 id="live-site--verification">Live Site &amp; Verification</h2>

<p><img src="https://img.shields.io/github/actions/workflow/status/humanaiconvention/humanaiconvention/deployed-integrity-check.yml?label=deployed%20integrity&amp;logo=github" alt="Deployed Integrity Status" />
<img src="https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/humanaiconvention/humanaiconvention/badges/attestation-badge.json&amp;logo=trust&amp;label=attestation" alt="Attestation Freshness" />
<img src="https://img.shields.io/github/actions/workflow/status/humanaiconvention/humanaiconvention/verify-latest-attestations.yml?label=verification%20oob&amp;logo=github" alt="Out-of-Band Verification" />
<img src="https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/humanaiconvention/humanaiconvention/badges/verification-badge.json&amp;label=attestations&amp;logo=trust" alt="Verification Health" />
<img src="https://img.shields.io/github/actions/workflow/status/humanaiconvention/humanaiconvention/e2e.yml?label=e2e%20tests&amp;logo=playwright" alt="E2E (Playwright)" /></p>

<p>Live URL (pending DNS propagation): https://www.humanaiconvention.com/</p>

<p>Integrity &amp; Provenance:</p>
<ul>
  <li>Version JSON: https://www.humanaiconvention.com/version.json</li>
  <li>HTML Integrity (hash embedded in <code class="language-plaintext highlighter-rouge">version-integrity.json</code> once published)</li>
  <li>Hourly Integrity Report + Predicate Attestation: ephemeral OCI image <code class="language-plaintext highlighter-rouge">ghcr.io/&lt;owner&gt;/&lt;repo&gt;-integrity-report:&lt;run_id&gt;</code> receives a real in-toto style attestation via <code class="language-plaintext highlighter-rouge">cosign attest</code> (custom type <code class="language-plaintext highlighter-rouge">https://humanaiconvention.com/attestation/integrity-report@v1</code>).</li>
  <li>Transparency Log (attestation digests): Issue labeled <code class="language-plaintext highlighter-rouge">integrity-attestation</code> (auto-created, one comment per run)</li>
  <li>(Historical) Prior to 2025-09-28 predicate was “simulated” by signing the JSON blob directly; this has been replaced with true <code class="language-plaintext highlighter-rouge">cosign attest</code> bound to an OCI subject.</li>
</ul>

<p>Attestation Freshness Badge:</p>
<ul>
  <li>The badge above consumes <code class="language-plaintext highlighter-rouge">badges/attestation-badge.json</code> (pushed each run by the integrity workflow)</li>
  <li>Schema: Shields endpoint (<code class="language-plaintext highlighter-rouge">{schemaVersion:1,label,message,color}</code>)</li>
  <li>Message states <code class="language-plaintext highlighter-rouge">ok @ &lt;UTC&gt;</code> for match; <code class="language-plaintext highlighter-rouge">drift @ &lt;UTC&gt;</code> if mismatch detected.</li>
  <li>Color: brightgreen (match) / red (drift).</li>
</ul>

<p>Quick Local Verification (after a release commit <code class="language-plaintext highlighter-rouge">COMMIT_SHA</code>):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> https://www.humanaiconvention.com/version.json | jq
curl <span class="nt">-s</span> https://www.humanaiconvention.com/version-integrity.json | jq <span class="nt">-r</span> .sha256
curl <span class="nt">-s</span> https://www.humanaiconvention.com/index.html | <span class="nb">sha256sum</span>
</code></pre></div></div>
<p>Compare the two SHA-256 values; they should match. (If post-build injection differs, consult the signed report artifacts in the release.)</p>

<p>If DNS is not yet active, GitHub Pages fallback URL: <code class="language-plaintext highlighter-rouge">https://&lt;github-username&gt;.github.io/&lt;repo-name&gt;/</code>.</p>

<h2 id="deployment-options">Deployment Options</h2>

<p>This project supports multiple deployment targets:</p>

<ul>
  <li><strong>Azure Static Web Apps</strong> (Primary) - See <a href="/DEPLOY_AZURE.html"><code class="language-plaintext highlighter-rouge">DEPLOY_AZURE.md</code></a>
    <ul>
      <li>Fast provisioning, free SSL, GitHub Actions integration</li>
      <li>Best for: Static sites, SPAs, global edge distribution</li>
    </ul>
  </li>
  <li><strong>Microsoft Power Platform (Power Pages)</strong> (Enterprise) - See <a href="/DEPLOY_POWERPLATFORM.html"><code class="language-plaintext highlighter-rouge">DEPLOY_POWERPLATFORM.md</code></a>
    <ul>
      <li>Native Dataverse integration, enterprise authentication</li>
      <li>Target Environment: <code class="language-plaintext highlighter-rouge">HumanAI-Pages-Dev</code></li>
      <li>Best for: Enterprise portals, Dynamics 365 integration</li>
    </ul>
  </li>
  <li><strong>GitHub Pages</strong> (Fallback) - Automatically deployed from <code class="language-plaintext highlighter-rouge">main</code> branch
    <ul>
      <li>Free hosting, simple setup</li>
      <li>Best for: Public documentation, previews</li>
    </ul>
  </li>
</ul>

<p>Choose the deployment target that best fits your infrastructure and integration needs.</p>

<h2 id="usage">Usage</h2>
<p>### Development
Ensure you are using Node.js 20+ (see <code class="language-plaintext highlighter-rouge">engines</code> in <code class="language-plaintext highlighter-rouge">web/package.json</code>). A recommended workflow:</p>

<p>Common scripts (run from <code class="language-plaintext highlighter-rouge">web/</code>):</p>

<table>
  <thead>
    <tr>
      <th>Script</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">npm run dev</code></td>
      <td>Start Vite dev server.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">npm run build</code></td>
      <td>Generate version file, typecheck via project references, build production bundle.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">npm run lint</code></td>
      <td>ESLint over all source (React + TS).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">npm run typecheck</code></td>
      <td>Strict TypeScript check with additional invariants (<code class="language-plaintext highlighter-rouge">noImplicitOverride</code>, <code class="language-plaintext highlighter-rouge">exactOptionalPropertyTypes</code>).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">npm run test:e2e</code></td>
      <td>Builds app with drift harness enabled (env flag) then runs Playwright tests.</td>
    </tr>
  </tbody>
</table>

<h3 id="hybrid-local--azure-pipeline-python">Hybrid Local + Azure Pipeline (Python)</h3>
<p>The <code class="language-plaintext highlighter-rouge">python/hybrid_pipeline/</code> package implements a modular workflow that keeps preprocessing on your workstation while delegating heavy inference to Azure AI Foundry deployments.</p>

<p><strong>Dependencies</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> venv .venv
<span class="nb">.</span> .venv/Scripts/activate  <span class="c"># Windows PowerShell: .venv\Scripts\Activate.ps1</span>
pip <span class="nb">install</span> <span class="nt">--upgrade</span> pip
pip <span class="nb">install </span>transformers sentence-transformers torch openai python-dotenv duckdb numpy
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">transformers</code> / <code class="language-plaintext highlighter-rouge">torch</code>: local Phi-3 or LLaMA-style summarization.</li>
  <li><code class="language-plaintext highlighter-rouge">sentence-transformers</code>: local embedding generation.</li>
  <li><code class="language-plaintext highlighter-rouge">openai</code>: async Azure OpenAI SDK.</li>
  <li><code class="language-plaintext highlighter-rouge">duckdb</code> (optional): alternate cache backend; SQLite is default.</li>
  <li><code class="language-plaintext highlighter-rouge">python-dotenv</code>: loads secrets from <code class="language-plaintext highlighter-rouge">.env</code>.</li>
</ul>

<p><strong>Configuration</strong></p>

<p>Update <code class="language-plaintext highlighter-rouge">.env</code> (already present in the repo) with the following keys:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AZURE_OPENAI_KEY=
AZURE_OPENAI_ENDPOINT=
AZURE_OPENAI_GLOBAL_ENDPOINT=
HYBRID_CACHE_BACKEND=sqlite  # or duckdb
LOCAL_LLM_MODEL=phi3
LOCAL_EMBEDDING_MODEL=all-MiniLM-L6-v2
LOCAL_USE_OLLAMA=false
</code></pre></div></div>

<p>If you run Ollama locally, set <code class="language-plaintext highlighter-rouge">LOCAL_USE_OLLAMA=true</code> and ensure the requested model is pulled (<code class="language-plaintext highlighter-rouge">ollama pull phi3</code>).</p>

<p><strong>Running the pipeline</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">hybrid_pipeline</span> <span class="kn">import</span> <span class="n">build_default_pipeline</span>
<span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">demo</span><span class="p">():</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">build_default_pipeline</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">pipeline</span><span class="p">.</span><span class="n">run</span><span class="p">(</span>
        <span class="s">"Sample text about HumanAI Convention."</span><span class="p">,</span>
        <span class="n">deployment</span><span class="o">=</span><span class="s">"gpt5"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">output_text</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">pipeline</span><span class="p">.</span><span class="n">azure</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">demo</span><span class="p">())</span>
</code></pre></div></div>

<p><strong>Testing connectivity</strong></p>

<p>Run the harness to validate each configured Azure deployment:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> hybrid_pipeline.test_harness
</code></pre></div></div>

<p>The script prints timings, token usage, and any errors for quick diagnostics.</p>

<h3 id="drift-harness--e2e-telemetry-capture-dev-only">Drift Harness &amp; E2E Telemetry Capture (Dev Only)</h3>
<p>To simulate configuration drift during E2E runs a gated harness is exposed when <code class="language-plaintext highlighter-rouge">VITE_ENABLE_DRIFT_HARNESS=true</code> at build and runtime. It adds globals:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">window.__testMutatePreviewQuestionsConfig(patch)</code></li>
  <li><code class="language-plaintext highlighter-rouge">window.__testMutateSwConfig(patch)</code></li>
</ul>

<p>Both recompute a config hash, emit <code class="language-plaintext highlighter-rouge">config/drift</code> if changed, and refresh corresponding meta tags. The default CI E2E workflow sets the enabling env var. In production builds the harness code is tree-shaken (flag absent).</p>

<p>For deeper assertions you can supply a mock analytics endpoint: run a tiny HTTP server capturing POST bodies, then start Playwright with <code class="language-plaintext highlighter-rouge">VITE_ANALYTICS_ENDPOINT=http://localhost:&lt;port&gt;/ingest</code> to assert received drift payloads. (Server not bundled—left to test harness scripts.)
| <code class="language-plaintext highlighter-rouge">npm run format</code> | Apply Prettier formatting to repo files. |
| <code class="language-plaintext highlighter-rouge">npm run format:check</code> | Verify formatting (CI friendly). |
| <code class="language-plaintext highlighter-rouge">npm run verify</code> | Aggregate: lint + typecheck + build + security audit. Fails fast on any error. |
| <code class="language-plaintext highlighter-rouge">npm run security:audit</code> | Production dependency vulnerability scan, JSON output to <code class="language-plaintext highlighter-rouge">audit.json</code>. |
| <code class="language-plaintext highlighter-rouge">npm run verify:deployed</code> | Compare deployed site hash vs baseline (see integrity section). |</p>

<h3 id="navigation--pages">Navigation &amp; Pages</h3>

<p>The web app now includes a dedicated <code class="language-plaintext highlighter-rouge">Learn More</code> page (<code class="language-plaintext highlighter-rouge">/learn-more</code>) which centralizes the formerly home‑page Mission and Vision content.</p>

<p>Routing is handled client‑side via <code class="language-plaintext highlighter-rouge">react-router-dom@6</code>:</p>

<p>Routes:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">/</code> – Landing experience (hero, dynamic quotes, participation &amp; coming soon sections).</li>
  <li><code class="language-plaintext highlighter-rouge">/learn-more</code> – Mission, Vision narrative, and pillars (Ethical Infrastructure, Participatory Data, Science- &amp; Culture- informed Research).</li>
  <li><code class="language-plaintext highlighter-rouge">/preview</code> – Restored Preview Questions page: an ephemeral (non-persisted) question intake form logging locally + analytics (shapes upcoming FAQ and onboarding flow). Future: backend or email integration.</li>
</ul>

<p>The home hero includes a “Learn more” call‑to‑action that performs client navigation without a full reload. When adding new sections that warrant deeper explanation, prefer expanding the <code class="language-plaintext highlighter-rouge">/learn-more</code> page rather than bloating the landing screen; keep initial interaction fast and focused.</p>

<p>Styling: Reuses the global hero background treatment with a leaner height and glass‑elevated pillar cards. Classes defined at the bottom of <code class="language-plaintext highlighter-rouge">web/src/App.css</code> under the <code class="language-plaintext highlighter-rouge">/* === Learn More Page Styles === */</code> marker.</p>

<p>If you introduce additional pages:</p>
<ol>
  <li>Create a component in <code class="language-plaintext highlighter-rouge">web/src/pages/</code>.</li>
  <li>Add a <code class="language-plaintext highlighter-rouge">&lt;Route path="/new" element={&lt;NewPage/&gt;} /&gt;</code> to <code class="language-plaintext highlighter-rouge">web/src/main.tsx</code>.</li>
  <li>Add a CTA or navigation element in the hero or footer.</li>
  <li>Track a <code class="language-plaintext highlighter-rouge">page_view</code> event manually if the component triggers significant lazy content (current initialization already fires a page_view on load &amp; navigation change events can be wired similarly).</li>
</ol>

<p>Analytics: The existing <code class="language-plaintext highlighter-rouge">page_view</code> event on initial load covers the root route. For future SSR or route-change tracking, consider adding a <code class="language-plaintext highlighter-rouge">useEffect</code> in each page component to emit <code class="language-plaintext highlighter-rouge">trackEvent({ category:'navigation', action:'page_view', label: location.pathname })</code>.</p>

<p>Formatting: Prettier config lives at <code class="language-plaintext highlighter-rouge">.prettierrc.json</code>; keep stylistic overrides minimal to reduce churn. CI should use <code class="language-plaintext highlighter-rouge">npm run format:check</code> to enforce consistency without auto-committing.</p>

<p>TypeScript Strictness: We’ve enabled <code class="language-plaintext highlighter-rouge">noImplicitOverride</code>, <code class="language-plaintext highlighter-rouge">exactOptionalPropertyTypes</code>, and <code class="language-plaintext highlighter-rouge">forceConsistentCasingInFileNames</code> to catch subtle correctness issues early. <code class="language-plaintext highlighter-rouge">skipLibCheck</code> remains enabled to keep build latency low; revisit if third‑party type drift becomes a concern.</p>

<p>Node Tooling Parity: GitHub Actions currently pins Node 20.x for build &amp; attestation steps. Local development on Node 22 is acceptable but may show an engines warning until workflows migrate. Prefer testing critical predicate generation paths under Node 20 prior to release tagging.</p>

<p>### Deployment Pipeline Overview</p>
<ol>
  <li>Policy Enforcement: A lightweight step evaluates the Sigstore policy (currently in audit mode) for required artifacts.</li>
  <li>SBOM Diff: Compares prior baseline to detect added/removed/version-changed components (and license changes) before proceeding.</li>
  <li>Preview Protection (PR builds only): If configured, injects a minimal client-side password prompt into the built <code class="language-plaintext highlighter-rouge">index.html</code> for PR preview environments.</li>
  <li>Secret Preflight (other workflows): A lightweight job determines if required secrets exist and exposes boolean outputs; deploy jobs fail fast or skip gracefully based on presence.</li>
  <li>Quality Reports: ESLint JSON and test runner JSON (Vitest / Jest) are uploaded as artifacts (<code class="language-plaintext highlighter-rouge">quality-reports</code>) for post‑run inspection.</li>
</ol>

<h3 id="quality--secret-gating-pattern">Quality &amp; Secret Gating Pattern</h3>

<p>All primary workflows now use a layered gate sequence:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">quality</code> job: Installs dependencies, enforces ESLint with <code class="language-plaintext highlighter-rouge">--max-warnings=0</code>, runs typecheck and tests. Uploads:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">web/eslint-report.json</code> (placeholder if no reporter script).</li>
      <li><code class="language-plaintext highlighter-rouge">web/test-report/results.json</code> (Vitest/Jest JSON or a note object).</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">secrets-preflight</code> job (where relevant): Emits an output <code class="language-plaintext highlighter-rouge">has_token</code> (or future additional flags) so downstream jobs use conditions instead of re-evaluating secrets inline.</li>
  <li>Build / Deploy jobs declare <code class="language-plaintext highlighter-rouge">needs: [quality, secrets-preflight]</code> and gate each deploy step with <code class="language-plaintext highlighter-rouge">if: needs.secrets-preflight.outputs.has_token == 'true'</code> (or fail early in production if absent).</li>
</ol>

<p>Benefits:</p>
<ul>
  <li>Deterministic order: no wasted build minutes if lint/test fail.</li>
  <li>Reduced false-positive secret linter noise: secret references centralized.</li>
  <li>Transparent skip semantics for forked PRs lacking repository secrets.</li>
</ul>

<p>Adding Another Secret Gate Example:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">jobs</span><span class="pi">:</span>
<span class="err">	</span><span class="na">secrets-preflight</span><span class="pi">:</span>
<span class="err">		</span><span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
<span class="na">		outputs</span><span class="pi">:</span>
<span class="err">			</span><span class="na">has_third_party</span><span class="pi">:</span> <span class="s">$</span>
<span class="na">		steps</span><span class="pi">:</span>
<span class="err">			</span><span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s">detect</span>
<span class="na">				run</span><span class="pi">:</span> <span class="pi">|</span>
<span class="err">	</span><span class="s">				if [ -n "$" ]; then</span>
<span class="err">	</span><span class="s">					echo "has_third_party=true" &gt;&gt; "$GITHUB_OUTPUT"</span>
<span class="err">	</span><span class="s">				else</span>
<span class="err">	</span><span class="s">					echo "has_third_party=false" &gt;&gt; "$GITHUB_OUTPUT"</span>
<span class="err">	</span><span class="s">				fi</span>
<span class="err">	</span><span class="s">deploy:</span>
<span class="err">	</span><span class="s">	needs: [quality, secrets-preflight]</span>
<span class="err">	</span><span class="s">	steps:</span>
<span class="err">	</span><span class="s">		- name: Use API</span>
<span class="err">	</span><span class="s">			if: needs.secrets-preflight.outputs.has_third_party == 'true'</span>
<span class="err">	</span><span class="s">			run: node scripts/call-api.mjs</span>
</code></pre></div></div>

<p>Quality Report Consumption:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gh run download &lt;run-id&gt; <span class="nt">-n</span> quality-reports
jq <span class="nb">.</span> web/eslint-report.json
jq <span class="nb">.</span> web/test-report/results.json
</code></pre></div></div>

<p>If you add a dedicated ESLint JSON reporter script, place it under <code class="language-plaintext highlighter-rouge">"lint:report": "eslint -f json -o web/eslint-report.json ."</code> in <code class="language-plaintext highlighter-rouge">web/package.json</code>.</p>
<h2 id="security--supply-chain-hardening">Security &amp; Supply Chain Hardening</h2>
<ul>
  <li>SBOM license drift reporting.</li>
  <li>Policy enforcement (audit mode) with Sigstore policy file.</li>
  <li>Optional preview password injection (non-cryptographic guard) to deter casual discovery of PR previews.</li>
  <li>Bundle size governance (baseline manifest + delta &amp; budget enforcement).</li>
  <li>Performance (Lighthouse) gradual enforcement with future hard gate date.</li>
  <li>Unified problem budget (lint/test/size) aggregation &amp; Slack notification.</li>
</ul>

<h2 id="bundle-size-governance">Bundle Size Governance</h2>
<p>The deploy pipeline generates <code class="language-plaintext highlighter-rouge">web/dist-size-manifest.json</code> (committed to <code class="language-plaintext highlighter-rouge">main</code> on successful deploy) and enforces:</p>
<ul>
  <li>Total budget (default <code class="language-plaintext highlighter-rouge">SIZE_TOTAL_BUDGET=550000</code> bytes ~ 550 KB)</li>
  <li>Max growth delta vs baseline (<code class="language-plaintext highlighter-rouge">SIZE_MAX_DELTA=30000</code> bytes)</li>
  <li>Per-file soft cap (&gt;150 KB for a single non-map asset triggers failure)</li>
</ul>

<p>Script: <code class="language-plaintext highlighter-rouge">web/scripts/bundle-size.mjs</code></p>

<p>Modes:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node scripts/bundle-size.mjs manifest   # produce manifest json
node scripts/bundle-size.mjs check      # enforce budgets vs baseline
</code></pre></div></div>

<p>Baseline logic: The workflow attempts to read the previously committed <code class="language-plaintext highlighter-rouge">web/dist-size-manifest.json</code> from <code class="language-plaintext highlighter-rouge">HEAD</code> as the baseline. After a successful deploy, the new manifest is auto-committed (fast‑forward) if it changed.</p>

<p>Adjusting Budgets (per-run overrides):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SIZE_TOTAL_BUDGET=600000 SIZE_MAX_DELTA=25000 node scripts/bundle-size.mjs check
</code></pre></div></div>

<h2 id="problem-budget-aggregation">Problem Budget Aggregation</h2>
<p><code class="language-plaintext highlighter-rouge">web/scripts/problem-budget.mjs</code> consumes ESLint JSON, test summary, and bundle size result to produce <code class="language-plaintext highlighter-rouge">web/problem-budget-summary.json</code> with fields:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
	"lintErrors": &lt;number&gt;,
	"lintWarnings": &lt;number&gt;,
	"testFailures": &lt;number&gt;,
	"testsTotal": &lt;number&gt;,
	"bundle": { "totalBytes": &lt;number&gt; },
	"exceeded": ["lintErrors", ...],
	"ok": true|false
}
</code></pre></div></div>
<p>CI fails the quality job if <em>any</em> budget is exceeded. Budgets are intentionally strict (zero lint warnings allowed) to bias toward authentic reduction over suppression.</p>

<h3 id="coverage-floor">Coverage Floor</h3>
<p>Added in schema <code class="language-plaintext highlighter-rouge">2</code> of the summary: if a <code class="language-plaintext highlighter-rouge">coverage/coverage-summary.json</code> (Istanbul style) exists, the script extracts <code class="language-plaintext highlighter-rouge">statements.pct</code> (fallback <code class="language-plaintext highlighter-rouge">lines.pct</code>). Set <code class="language-plaintext highlighter-rouge">MIN_COVERAGE</code> (or legacy <code class="language-plaintext highlighter-rouge">PB_MIN_COVERAGE</code>) env to enforce a minimum percentage. Example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MIN_COVERAGE=75 node web/scripts/problem-budget.mjs
</code></pre></div></div>

<p>Status key <code class="language-plaintext highlighter-rouge">coverage</code> will be <code class="language-plaintext highlighter-rouge">false</code> if coverage <code class="language-plaintext highlighter-rouge">&lt; MIN_COVERAGE</code>. The overall gate fails when any status is false.</p>

<h3 id="nightly-trend-history--slack">Nightly Trend History &amp; Slack</h3>
<p>A scheduled workflow (<code class="language-plaintext highlighter-rouge">nightly-trend.yml</code>) runs a lightweight lint/test/coverage pass, aggregates the problem budget, appends an entry to <code class="language-plaintext highlighter-rouge">metrics/trend-history.json</code>, commits it, and posts a Slack <code class="language-plaintext highlighter-rouge">trend</code> event. This allows tracking reduction or regression over time without waiting for ad‑hoc pushes.</p>

<p>Early structure (each array entry):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[
	{
		"date": "2025-09-29T02:15:09Z",
		"summary": { ... problem-budget-summary.json contents ... }
	}
]
</code></pre></div></div>

<p>Future enhancements may compress history (rolling window) or derive derived metrics (e.g., moving averages, burn-down to zero-warn state).</p>

<h2 id="performance-lighthouse-gradual-enforcement">Performance (Lighthouse) Gradual Enforcement</h2>
<p>The <code class="language-plaintext highlighter-rouge">lighthouse</code> job runs on <code class="language-plaintext highlighter-rouge">main</code> builds and records category scores (Performance, Accessibility, Best Practices, SEO). Current soft thresholds:</p>
<ul>
  <li>Performance ≥ 90</li>
  <li>Accessibility ≥ 95</li>
</ul>

<p>Before enforcement date (<code class="language-plaintext highlighter-rouge">LIGHTHOUSE_ENFORCE_DATE</code>, default <code class="language-plaintext highlighter-rouge">2025-11-01</code>): sub-threshold scores emit warnings and (optionally) Slack notifications but do not fail the pipeline. On or after the enforcement date, failing scores cause the job to exit non‑zero.</p>

<p>Environment Overrides:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MIN_PERF_SCORE=92 MIN_ACC_SCORE=96 LIGHTHOUSE_ENFORCE_DATE=2025-10-20
</code></pre></div></div>

<h2 id="progressive-intro--content-reveal">Progressive Intro &amp; Content Reveal</h2>
<p>To prevent initial layout flash and create a smoother perceived load, a two‑phase intro gating + reveal system is implemented.</p>

<p>Classes &amp; Attributes:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">intro-pending</code>: Added to <code class="language-plaintext highlighter-rouge">&lt;body&gt;</code> pre‑React if the dual preview intro has not yet been completed. While present, main structural regions (<code class="language-plaintext highlighter-rouge">.page</code>, <code class="language-plaintext highlighter-rouge">.hero</code>, <code class="language-plaintext highlighter-rouge">main</code>, <code class="language-plaintext highlighter-rouge">footer</code>) are <code class="language-plaintext highlighter-rouge">visibility:hidden</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">reveal-ready</code>: Added when the intro finishes (or immediately if previously completed). Enables opacity/translate transitions on staged elements.</li>
  <li><code class="language-plaintext highlighter-rouge">no-attr-delay</code>: Feature‑detection fallback toggled when the browser does not support <code class="language-plaintext highlighter-rouge">attr()</code> inside <code class="language-plaintext highlighter-rouge">calc()</code> for <code class="language-plaintext highlighter-rouge">transition-delay</code>. Inline JS then assigns explicit <code class="language-plaintext highlighter-rouge">transitionDelay</code> values.</li>
  <li><code class="language-plaintext highlighter-rouge">[data-reveal]</code>: Marks an element as part of the progressive reveal choreography.</li>
  <li><code class="language-plaintext highlighter-rouge">data-reveal-order="&lt;n&gt;</code>: Integer sequence index. Stagger interval currently 60ms per step.</li>
</ul>

<p>Flow:</p>
<ol>
  <li>Early script (<code class="language-plaintext highlighter-rouge">main.tsx</code> top) inspects <code class="language-plaintext highlighter-rouge">localStorage['hq:introComplete']</code> and sets <code class="language-plaintext highlighter-rouge">intro-pending</code> vs <code class="language-plaintext highlighter-rouge">reveal-ready</code>.</li>
  <li>User progresses through <code class="language-plaintext highlighter-rouge">PreviewIntroGate</code>; on completion <code class="language-plaintext highlighter-rouge">handleIntroComplete</code> sets the storage flag, swaps classes, and dispatches a custom <code class="language-plaintext highlighter-rouge">reveal:ready</code> event.</li>
  <li>CSS in <code class="language-plaintext highlighter-rouge">src/reveal.css</code> transitions each <code class="language-plaintext highlighter-rouge">[data-reveal]</code> from <code class="language-plaintext highlighter-rouge">opacity:0; translateY(12px)</code> to visible state with a stagger.</li>
  <li>Reduced motion users skip vertical translation (respecting <code class="language-plaintext highlighter-rouge">prefers-reduced-motion</code> media query).</li>
  <li>Unsupported <code class="language-plaintext highlighter-rouge">attr()</code> fallback: JS applies inline <code class="language-plaintext highlighter-rouge">transitionDelay</code> based on <code class="language-plaintext highlighter-rouge">data-reveal-order</code>.</li>
</ol>

<p>Customization knobs (future):</p>
<ul>
  <li>Change base stagger: adjust multiplier in <code class="language-plaintext highlighter-rouge">reveal.css</code> or inline JS fallback (60ms).</li>
  <li>Global delay offset: add a <code class="language-plaintext highlighter-rouge">--reveal-delay</code> CSS variable on <code class="language-plaintext highlighter-rouge">body</code> or any container.</li>
  <li>Disable reveal for diagnostics: manually add <code class="language-plaintext highlighter-rouge">reveal-ready</code> and remove <code class="language-plaintext highlighter-rouge">intro-pending</code> in dev tools, or set <code class="language-plaintext highlighter-rouge">localStorage['hq:introComplete']='true'</code> before reload.</li>
</ul>

<p>Testing:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">revealReady.test.tsx</code> ensures immediate <code class="language-plaintext highlighter-rouge">reveal-ready</code> application when intro previously completed.</li>
  <li>Additional e2e tests could verify no layout shift spikes (CLS) by measuring bounding boxes pre/post reveal (placeholder).</li>
</ul>

<p>Telemetry Considerations:</p>
<ul>
  <li>The reveal is intentionally silent (no analytics events) to keep intro taxonomy lean; if sequencing metrics are later needed, instrument a single timing event referencing the total reveal duration instead of per‑element events.</li>
</ul>

<p>Artifacts: Raw Lighthouse reports are stored under <code class="language-plaintext highlighter-rouge">web/.lighthouseci</code> and uploaded as <code class="language-plaintext highlighter-rouge">lighthouse-gradual</code> artifact.</p>

<h2 id="slack-notifications">Slack Notifications</h2>
<p>Slack integration uses an <strong>Incoming Webhook</strong> (<code class="language-plaintext highlighter-rouge">SLACK_WEBHOOK_URL</code> secret). Script: <code class="language-plaintext highlighter-rouge">.github/scripts/slack-notify.mjs</code>.</p>

<p>Events sent:</p>
<ul>
  <li>Quality Gate (pass/fail; includes lint/test/bundle/coverage metrics)</li>
  <li>Deploy (includes bundle size, commit, URL)</li>
  <li>Deterministic Verify (pass/fail)</li>
  <li>Lighthouse Warning (only when below thresholds pre‑enforcement or failure post‑enforcement)</li>
  <li>Trend (nightly scheduled summary snapshot)</li>
</ul>

<p>Message Format: Block Kit header + field grid; color codes (green, red, orange) derived from status.</p>

<p>To enable:</p>
<ol>
  <li>Create a Slack App or use Incoming Webhooks feature → add webhook to target channel.</li>
  <li>Add repo secret: <code class="language-plaintext highlighter-rouge">SLACK_WEBHOOK_URL=&lt;https://hooks.slack.com/services/...&gt;</code></li>
  <li>(Optional) Adjust emojis or fields in <code class="language-plaintext highlighter-rouge">.github/scripts/slack-notify.mjs</code>.</li>
</ol>

<p>Security Notes:</p>
<ul>
  <li>Secret never echoed; curl fallback removed in favor of node script.</li>
  <li>Notifications skipped automatically if secret absent.</li>
  <li>Forked PR events do not run deploy path → no leakage.</li>
</ul>

<p>Extensibility:</p>
<ul>
  <li>Add bot token (chat:write) for threads or message updates (planned; script includes placeholder comment).</li>
  <li>Extend trend workflow to compute deltas vs previous N days.</li>
  <li>Add signed nightly trend attestation referencing problem budget + size metrics.</li>
</ul>

<h2 id="future-hardening-roadmap-quality--observability">Future Hardening Roadmap (Quality &amp; Observability)</h2>
<ul>
  <li>Introduce size per‑entrypoint budgets (initial vs lazy chunk segmentation).</li>
  <li>Enforce Lighthouse Perf/Acc after date with remediation suggestions (largest contentful paint / time to interactive deltas).</li>
  <li>Expand problem budget to include coverage floor and bundle composition entropy (e.g., number of JS chunks, third‑party bytes, license risk score).</li>
</ul>

<h2 id="brand-geometry--asset-export">Brand Geometry &amp; Asset Export</h2>

<p>The HumanAI logomark + wordmark is generated parametrically (React + TypeScript) and exported reproducibly. Geometry is locked (variant pruning complete) to ensure a stable visual identity with documented mathematical provenance.</p>

<h3 id="design-constraints-locked">Design Constraints (Locked)</h3>
<ul>
  <li>Inner arc span: 132° (empirically balanced for negative space &amp; pillar rhythm).</li>
  <li>Golden ratio (φ ≈ 1.618) governs: head gap, taper ratio (end:mid thickness ≈ φ), and proportional clearance.</li>
  <li>Taper: strictly inward-only (no outward bulge) to keep vertical seams truly vertical while creating subtle mid-line tension.</li>
  <li>Analytic outer start: arcs begin from computed outer solution; removed experimental circle-unification and cap variants (A1 baseline retained).</li>
  <li>Wordmark alignment: “HumanAI” + “Convention” centered on pillar midpoint; dynamic spacing derived from measured head gap unless locked or embedded.</li>
</ul>

<h3 id="export-script">Export Script</h3>
<p>Location: <code class="language-plaintext highlighter-rouge">web/scripts/export-logo.tsx</code></p>

<p>Runs a server-side render of <code class="language-plaintext highlighter-rouge">&lt;LogoHumanAI&gt;</code> with the wordmark embedded inside the SVG, injects a metadata comment, and rasterizes multi-size PNGs using <code class="language-plaintext highlighter-rouge">@resvg/resvg-js</code> (WASM). Two monochrome variants are produced: light (<code class="language-plaintext highlighter-rouge">mono-light</code>) and dark (<code class="language-plaintext highlighter-rouge">mono-dark</code>).</p>

<p>Command (run inside <code class="language-plaintext highlighter-rouge">web/</code>):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm run logo:export
</code></pre></div></div>

<h3 id="output-directory">Output Directory</h3>
<p><code class="language-plaintext highlighter-rouge">web/dist/brand/</code></p>

<p>Generated files (base set now includes added sizes + favicon + manifest):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>humanai-logo.svg
humanai-logo-256.png
humanai-logo-512.png
humanai-logo-1024.png
humanai-logo-2048.png
humanai-logo-4096.png
humanai-logo-dark.svg
humanai-logo-dark-256.png
humanai-logo-dark-512.png
humanai-logo-dark-1024.png
humanai-logo-dark-2048.png
humanai-logo-dark-4096.png
favicon.ico   (composed from 16,32,48,64,128,256 PNG sub-images)
brand-assets-manifest.json (SHA-256 + size inventory)
</code></pre></div></div>

<p>Optional outlined variants (generated only when font file present and outline flag used):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>humanai-logo-outline.svg
humanai-logo-outline-256.png ... 4096.png
humanai-logo-dark-outline.svg
humanai-logo-dark-outline-256.png ... 4096.png
</code></pre></div></div>

<h3 id="embedded-metadata-comment">Embedded Metadata Comment</h3>
<p>Each SVG includes a leading comment block immediately after the <code class="language-plaintext highlighter-rouge">&lt;svg&gt;</code> tag. Example (light variant):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!--
HumanAI Logo Export
UIVariant: mono-light
Geometry: analytic-locked
φ: 1.618033988749895
InnerSpanDeg: 132
Taper: inward-only (end:mid ≈ φ)
HeadGap: &lt;numeric if metrics captured&gt;
PillarWidthEnd: &lt;numeric&gt;
PillarWidthMid: &lt;numeric&gt;
ArcMinThickness: &lt;numeric&gt;
OverallWidthEstimate: &lt;numeric&gt;
OverallHeightEstimate: &lt;numeric&gt;
Generated: &lt;ISO timestamp&gt;
Commit: &lt;optional commit SHA if GIT_COMMIT env is set&gt;
--&gt;
</code></pre></div></div>
<p>Values are emitted only when available; absent metrics are omitted to keep the block concise.</p>

<h3 id="variant-usage-guidance">Variant Usage Guidance</h3>
<ul>
  <li>Use light variant on dark backgrounds (#000 / near-black) and dark variant on light backgrounds (#fff / near-white).</li>
  <li>Do not recolor individual internal elements independently; treat the mark as a single-tone asset for clarity and accessibility at small sizes.</li>
  <li>Preserve aspect ratio; never horizontally stretch the SVG.</li>
</ul>

<h3 id="regeneration--reproducibility">Regeneration &amp; Reproducibility</h3>
<p>Because the geometry is code-defined and metrics are embedded, any future redistribution can be verified by re-running <code class="language-plaintext highlighter-rouge">npm run logo:export</code> at a given commit and diffing SVG path data &amp; metadata lines. Differences beyond timestamp should be considered drift.</p>

<h3 id="implementation-notes">Implementation Notes</h3>
<ul>
  <li>The export script strips the outer wrapping <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code> (used in client layout) and isolates the root <code class="language-plaintext highlighter-rouge">&lt;svg&gt;</code> (injecting <code class="language-plaintext highlighter-rouge">xmlns</code> if missing) to satisfy the resvg parser.</li>
  <li>Resize-based spacing logic is disabled (<code class="language-plaintext highlighter-rouge">lockWordmarkSpacing</code>) during export for deterministic layout.</li>
  <li>Wordmark is embedded via <code class="language-plaintext highlighter-rouge">&lt;text&gt;</code> elements with responsive font sizes derived from measured head radius; this preserves proportionality when rasterized at multiple discrete widths.</li>
  <li>Favicon generation: a multi-resolution <code class="language-plaintext highlighter-rouge">favicon.ico</code> is synthesized from the light variant PNGs at 16, 32, 48, 64, 128, 256.</li>
  <li>Checksum manifest: <code class="language-plaintext highlighter-rouge">brand-assets-manifest.json</code> lists each asset with SHA-256 + byte size. Field <code class="language-plaintext highlighter-rouge">outlineIncluded</code> indicates whether outlined variants were part of the export run.</li>
  <li>Outlined text mode (font independence): run with <code class="language-plaintext highlighter-rouge">npm run logo:export -- --outline</code> and provide an Inter font file at <code class="language-plaintext highlighter-rouge">web/assets/fonts/Inter-Regular.ttf</code> (or set <code class="language-plaintext highlighter-rouge">LOGO_OUTLINE_FONT</code> env). If the font file is absent, the script logs a warning and skips outline generation.</li>
</ul>

<p>Example verification of a single asset against manifest:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd web/dist/brand
shasum -a 256 humanai-logo.svg  # macOS / *nix (use certUtil -hashfile on Windows)
</code></pre></div></div>
<p>Compare the printed hash with the corresponding entry in <code class="language-plaintext highlighter-rouge">brand-assets-manifest.json</code>.</p>

<h3 id="potential-future-enhancements">Potential Future Enhancements</h3>
<ul>
  <li>Add a vector source variant with outline-converted text for environments lacking Inter font.</li>
  <li>Generate additional sizes (256, 4096) or an adaptive favicon set.</li>
  <li>Provide a JSON manifest enumerating exported files and hashing them (SHA-256) for tamper-evident distribution.
 (The above three have been implemented: sizes expanded, favicon + manifest generated, outline mode scaffolded. Update list with new forward-looking items.)</li>
  <li>Add SVG symbol sprite with both light/dark (and outlined) for easy embedding.</li>
  <li>Provide monochrome accent variant with adjustable primary fill token.</li>
</ul>

<hr />
<ul>
  <li>Add signed aggregate QA attestation referencing problem budget + size + perf results.</li>
</ul>

<h2 id="service-worker-updates--asset-integrity">Service Worker Updates &amp; Asset Integrity</h2>

<p>The frontend includes an advanced service worker (<code class="language-plaintext highlighter-rouge">web/src/sw.ts</code>) with the following capabilities:</p>

<ul>
  <li>Versioned precache using an injected <code class="language-plaintext highlighter-rouge">BUILD_REV</code> (git short hash + build timestamp).</li>
  <li>Precise asset diffing: the previous manifest asset list is persisted (<code class="language-plaintext highlighter-rouge">haic-meta</code> cache keys <code class="language-plaintext highlighter-rouge">manifest-hash</code> &amp; <code class="language-plaintext highlighter-rouge">manifest-list</code>). On refresh, the SW computes added/removed assets and a change ratio; if the ratio exceeds 40% it performs a hard rebuild else an incremental update.</li>
  <li>Background refresh: periodic background sync tag <code class="language-plaintext highlighter-rouge">refresh-precache</code> (daily) plus a 6‑hour fallback interval message to trim runtime caches.</li>
  <li>Pattern-based API TTL caching (<code class="language-plaintext highlighter-rouge">API_TTL_PATTERNS</code>) supporting <code class="language-plaintext highlighter-rouge">prefix</code>, <code class="language-plaintext highlighter-rouge">regex</code>, and <code class="language-plaintext highlighter-rouge">exact</code> patterns; cached responses embed <code class="language-plaintext highlighter-rouge">x-sw-cached-at</code> for TTL enforcement and return <code class="language-plaintext highlighter-rouge">504</code> when stale and offline.</li>
  <li>Runtime cache bounding (<code class="language-plaintext highlighter-rouge">MAX_RUNTIME_ENTRIES</code>) and lazy cleanup via <code class="language-plaintext highlighter-rouge">trim-runtime</code> message.</li>
  <li>Lightweight Workbox‑style <code class="language-plaintext highlighter-rouge">registerRoute</code> abstraction (initial image cache-first example) enabling incremental strategy growth without importing Workbox.</li>
  <li>Forced update path: UI sends <code class="language-plaintext highlighter-rouge">postMessage('force-reload')</code>; SW runs <code class="language-plaintext highlighter-rouge">skipWaiting</code> + <code class="language-plaintext highlighter-rouge">clients.claim</code> then broadcasts <code class="language-plaintext highlighter-rouge">{type:'force-reload'}</code> prompting a window reload.</li>
  <li>Update notifications: when a manifest update is applied the SW posts <code class="language-plaintext highlighter-rouge">{type:'update-available', added, removed, ratio}</code>; the React <code class="language-plaintext highlighter-rouge">UpdateToast</code> component displays a refresh button and expandable details.</li>
  <li>Subresource Integrity injection: build pipeline generates <code class="language-plaintext highlighter-rouge">dist/sri-manifest.json</code> (via <code class="language-plaintext highlighter-rouge">npm run generate:sri</code>). A custom Vite plugin (<code class="language-plaintext highlighter-rouge">sri-inject</code>) adds <code class="language-plaintext highlighter-rouge">integrity</code> + <code class="language-plaintext highlighter-rouge">crossorigin="anonymous"</code> to <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> and stylesheet <code class="language-plaintext highlighter-rouge">&lt;link&gt;</code> tags during production build.</li>
</ul>

<p>Manual debug helper (production console):</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">__forceSWUpdate</span><span class="p">();</span> <span class="c1">// triggers manifest refresh check</span>
</code></pre></div></div>

<p>Planned enhancements:</p>
<ul>
  <li>CSP header generation referencing SRI manifest.</li>
  <li>User preference to auto-refresh on minor updates.</li>
  <li>Additional TTL patterns loaded from a served JSON config.</li>
  <li>Offline analytics queue persistence (currently in-memory only pre‑consent/backlog).</li>
</ul>

<h3 id="content-security-policy-csp--sri-guidance">Content Security Policy (CSP) &amp; SRI Guidance</h3>

<p>The current HTML sets a baseline CSP meta tag primarily for local/reference usage. For robust production enforcement you should deliver a strict CSP header from your CDN / hosting platform. Because we inject Subresource Integrity attributes (<code class="language-plaintext highlighter-rouge">integrity</code> + <code class="language-plaintext highlighter-rouge">crossorigin="anonymous"</code>) for JS and CSS, you can safely use hash or nonce based script policies while mitigating risk of asset tampering.</p>

<p>Recommended starting header (adjust domains as needed):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Content-Security-Policy:
	default-src 'self';
	base-uri 'self';
	script-src 'self' 'strict-dynamic' 'nonce-{NONCE}' 'unsafe-inline';
	style-src 'self' 'unsafe-inline';
	img-src 'self' data:; 
	font-src 'self' data:; 
	connect-src 'self' https://api.yourdomain.example; 
	object-src 'none';
	frame-ancestors 'none';
	upgrade-insecure-requests;
</code></pre></div></div>

<p>Then tighten once you confirm no inline scripts are needed:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>script-src 'self' 'strict-dynamic' 'nonce-{NONCE}';
style-src 'self';
</code></pre></div></div>

<p>Where to integrate SRI:</p>
<ol>
  <li>Build generates <code class="language-plaintext highlighter-rouge">dist/sri-manifest.json</code>.</li>
  <li>Vite plugin injects integrity attributes into <code class="language-plaintext highlighter-rouge">index.html</code> for all <code class="language-plaintext highlighter-rouge">&lt;script type="module"&gt;</code> and stylesheet links.</li>
  <li>CDN header can include <code class="language-plaintext highlighter-rouge">require-sri-for script style</code> (deprecated in some browsers; test before adopting) or rely on enforcement-by-failure if an integrity mismatch occurs.</li>
</ol>

<p>If you adopt a nonce-based CSP (recommended for defense-in-depth) remove <code class="language-plaintext highlighter-rouge">unsafe-inline</code> and dynamically nonce any critical inline bootstrap (e.g., analytics consent priming) or move it into external JS so SRI covers it.</p>

<p>Reporting:
Add a <code class="language-plaintext highlighter-rouge">report-to</code> / <code class="language-plaintext highlighter-rouge">report-uri</code> directive and configure a reporting endpoint for CSP violation collection to detect unexpected script/style evaluations.</p>

<p>Example hardened CSP (simplified):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>default-src 'self';
script-src 'self' 'strict-dynamic' 'nonce-{NONCE}';
style-src 'self';
img-src 'self' data:; 
font-src 'self' data:; 
connect-src 'self' https://api.humanaiconvention.com; 
object-src 'none';
frame-ancestors 'none';
base-uri 'self';
upgrade-insecure-requests;
</code></pre></div></div>

<p>Operational Tips:</p>
<ul>
  <li>Rotate nonces per response; never reuse across requests.</li>
  <li>Monitor violation reports for a probation period before blocking third-party additions.</li>
  <li>If integrating analytics tags or third-party scripts, prefer self-hosted trusted copies with SRI instead of broad wildcard origins.</li>
</ul>

<h2 id="pr-preview-password-lock">PR Preview Password Lock</h2>

<p>This feature adds a very lightweight password gate to pull request preview deployments. It is intended only to discourage casual access or indexing—not to provide real security. The protection is entirely client-side JavaScript injected into <code class="language-plaintext highlighter-rouge">dist/index.html</code> by <code class="language-plaintext highlighter-rouge">web/scripts/preview-protect.mjs</code>.</p>

<h3 id="how-it-works">How It Works</h3>
<ol>
  <li>During the PR preview build job, if a password value is available (via the <code class="language-plaintext highlighter-rouge">PREVIEW_PASSWORD</code> environment variable), the script injects a <code class="language-plaintext highlighter-rouge">&lt;script id="__PREVIEW_LOCK__"&gt;</code> block.</li>
  <li>On first visit, the script prompts the user for the password (blocking render until correct).</li>
  <li>A successful entry is stored in <code class="language-plaintext highlighter-rouge">localStorage</code> (namespace key: <code class="language-plaintext highlighter-rouge">__preview_lock__</code>). Subsequent loads skip the prompt.</li>
</ol>

<h3 id="limitations">Limitations</h3>
<ul>
  <li>Client-side only: Users can view source, retrieve the password prompt logic, or bypass with dev tools.</li>
  <li>No rate limiting, no server involvement.</li>
  <li>Not a substitute for authentication, secrets management, or authorization.</li>
  <li>Should not be used for anything sensitive (PII, proprietary data, pre-release confidential features, etc.).</li>
</ul>

<h3 id="enabling-the-password-lock">Enabling the Password Lock</h3>
<ol>
  <li>Create a GitHub Actions secret named <code class="language-plaintext highlighter-rouge">PREVIEW_PASSWORD</code> (recommended) or an environment-level secret.</li>
  <li>Open or update a pull request; the pipeline will inject the gate only if the secret is non-empty.</li>
  <li>If the secret is absent or empty, NO password is applied (there is no automatic fallback or pseudo-random generation to avoid a false sense of protection).</li>
</ol>

<h4 id="creating-the-secret-github-ui">Creating the Secret (GitHub UI)</h4>
<ol>
  <li>Navigate: Repository Settings → Security → Secrets and variables → Actions.</li>
  <li>Click “New repository secret”.</li>
  <li>Name: <code class="language-plaintext highlighter-rouge">PREVIEW_PASSWORD</code></li>
  <li>Value: (choose a non-trivial phrase; avoid quotes or leading/trailing spaces).</li>
  <li>Save.</li>
</ol>

<h4 id="creating-the-secret-cli-via-gh">Creating the Secret (CLI via <code class="language-plaintext highlighter-rouge">gh</code>)</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gh secret <span class="nb">set </span>PREVIEW_PASSWORD <span class="nt">--body</span> <span class="s2">"your-secret-password"</span>
</code></pre></div></div>

<h3 id="verifying-injection">Verifying Injection</h3>
<ul>
  <li>The workflow now generates a signed JSON report (<code class="language-plaintext highlighter-rouge">preview-lock-report.json</code>) containing: schemaVersion, script hash, index HTML hash, password presence flags, and status.</li>
  <li>The composite action also produces a GitHub Actions summary table for quick review.</li>
  <li>Manual spot check:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">grep</span> <span class="s1">'__PREVIEW_LOCK__'</span> web/dist/index.html
jq <span class="nb">.</span> web/dist/preview-lock-report.json
<span class="nb">sha256sum </span>web/dist/index.html
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="direct-secret-reference">Direct Secret Reference</h3>
<p>The workflow calls a composite action <code class="language-plaintext highlighter-rouge">./.github/actions/preview-protect</code> with <code class="language-plaintext highlighter-rouge">password: $</code>. If your linter flags direct secret mapping, options:</p>
<ol>
  <li>Remove/empty the secret (unprotected preview) or set <code class="language-plaintext highlighter-rouge">__DISABLED__</code>.</li>
  <li>Move password into an environment-level secret scoped to a protected environment.</li>
  <li>Introduce an allowlist entry in the workflow linter config.</li>
</ol>

<h3 id="disabling">Disabling</h3>
<p>Remove/unset the secret, set it empty, or set <code class="language-plaintext highlighter-rouge">PREVIEW_PASSWORD=__DISABLED__</code>; the composite action terminates early (unlocked) and still emits a JSON report with reason <code class="language-plaintext highlighter-rouge">no_password_unprotected</code>.</p>

<h3 id="threat-model-note">Threat Model Note</h3>
<p>This is strictly a deterrent for casual browsing or automated indexing. For authentic access control, integrate an authenticated preview proxy, short-lived signed URLs, or environment-level basic auth (e.g., via reverse proxy) outside the scope of this script.</p>

<h3 id="entropy--policy">Entropy &amp; Policy</h3>
<p>Passwords must satisfy:</p>
<ul>
  <li>Minimum length (default 10; configurable <code class="language-plaintext highlighter-rouge">min-length</code> input to composite action)</li>
  <li>Required character classes (default: upper, lower, digit; optional addition: symbol)</li>
</ul>

<h2 id="ethical-streaming-limits--transparency">Ethical Streaming Limits &amp; Transparency</h2>

<p>Purpose: Prevent runaway token usage, promote equitable resource sharing, and provide users with clear, in‑band rationale when a streamed response is truncated for policy—not silently. The system favors usefulness (enough context to be actionable) while limiting over‑generation that increases cost, energy use, or hallucination risk.</p>

<h3 id="how-it-works-1">How It Works</h3>
<p>When a streaming invocation begins, the agent evaluates a heuristic via <code class="language-plaintext highlighter-rouge">evaluateStreamingLimit()</code> using:</p>
<ol>
  <li>Prompt length (short prompts usually require fewer tokens in reply)</li>
  <li>Presence of research / exploratory keywords (“analysis”, “compare”, “research”, etc.)</li>
  <li>Environment ceilings for absolute and maximum allowed caps</li>
  <li>A floor (minimum) to avoid pathological under‑limits</li>
</ol>

<p>The resulting <code class="language-plaintext highlighter-rouge">limit</code> (surrogate token count) and <code class="language-plaintext highlighter-rouge">rationale</code> are emitted immediately as the first streaming chunk with <code class="language-plaintext highlighter-rouge">event: "limit_info"</code>.</p>

<p>During streaming each partial delta increments a surrogate token counter (currently 1 per received text delta; this is an approximation and not a true tokenizer). If the counter reaches the enforced limit, the stream ends early and emits a <code class="language-plaintext highlighter-rouge">limit_notice</code> event carrying:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{ event: 'limit_notice', limit, tokens, rationale }
</code></pre></div></div>
<p>The final aggregated object returned by the streaming helper is marked <code class="language-plaintext highlighter-rouge">truncated: true</code> with the same limit metadata.</p>

<h3 id="transparency-events">Transparency Events</h3>
<p>| Event | Meaning |
|——-|———|
| <code class="language-plaintext highlighter-rouge">limit_info</code> | Discloses the applied limit and rationale before any content. |
| <code class="language-plaintext highlighter-rouge">limit_notice</code> | Indicates the limit was reached; stream stops afterward. |</p>

<p>All normal delta chunks may also include auxiliary fields: <code class="language-plaintext highlighter-rouge">tokens</code> (surrogate count so far) and <code class="language-plaintext highlighter-rouge">limit</code> for UI progress indicators.</p>

<h3 id="environment-variables">Environment Variables</h3>
<p>| Variable | Purpose | Example Default |
|———-|———|—————–|
| <code class="language-plaintext highlighter-rouge">AZURE_STREAM_MAX_TOKENS</code> | Legacy hard cap override (takes precedence if lower than heuristic). | unset / 0 (no legacy cap) |
| <code class="language-plaintext highlighter-rouge">STREAM_TOKEN_LIMIT_BASE</code> | Base heuristic limit starting point. | 400 |
| <code class="language-plaintext highlighter-rouge">STREAM_TOKEN_LIMIT_MAX</code> | Hard upper bound the heuristic will not exceed. | 1200 |
| <code class="language-plaintext highlighter-rouge">STREAM_TOKEN_LIMIT_MIN</code> | Minimum floor to ensure useful replies. | 60 |</p>

<p>Unset values fall back to internal defaults. Adjust cautiously; overly high maxima reduce governance benefits.</p>

<h3 id="ethical-rationale">Ethical Rationale</h3>
<ol>
  <li>Cost &amp; Energy Stewardship: Truncating early prevents unnecessary compute expenditure and carbon impact for low‑value extra verbosity.</li>
  <li>Hallucination Reduction: Very long generations, especially after the core answer is provided, correlate with increased tangential / fabricated content.</li>
  <li>Fair Share: In multi‑tenant or rapid iteration scenarios, moderate caps reduce latency spikes and queuing for other users.</li>
  <li>User Agency: Immediate disclosure lets a user decide to reformulate or request an extended run (future enhancement) rather than silently receiving a shorter answer.</li>
</ol>

<h3 id="approximate-counting-caveat">Approximate Counting Caveat</h3>
<p>Current counting treats each textual SSE delta as one “surrogate token”. This is NOT an exact tokenization and may under/over estimate actual model tokens. The limit thus reflects an <em>approximate verbosity budget</em>, not a billing‑grade token number. Future improvement: integrate a lightweight tokenizer (e.g., tiktoken compatible) when available without large bundle cost.</p>

<h3 id="extensibility-roadmap">Extensibility Roadmap</h3>
<ul>
  <li>Adaptive Re‑request: Allow user to request +N additional tokens with explicit justification (logged for audit).</li>
  <li>Dynamic Risk Modulation: Increase strictness when system detects elevated hallucination risk patterns (e.g., multiple speculative follow‑on deltas without new user input).</li>
  <li>Per‑User Budget Pools: Combine with a refillable quota to ensure fair distribution under load.</li>
</ul>

<h3 id="ui-integration-guidance">UI Integration Guidance</h3>
<ul>
  <li>Display an unobtrusive progress indicator (tokens / limit) when <code class="language-plaintext highlighter-rouge">limit_info</code> arrives.</li>
  <li>On <code class="language-plaintext highlighter-rouge">limit_notice</code>, show a concise banner: “Response truncated at governance limit (X tokens). Rationale: <rationale>." Offer a button to "Request continuation" (disabled until feature implemented).</rationale></li>
  <li>Provide a tooltip or help icon linking to this README section for clarity.</li>
</ul>

<h3 id="api-contract-streamingdeltachunk-additions">API Contract (StreamingDeltaChunk Additions)</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>interface StreamingDeltaChunk {
	delta?: string;
	tokens?: number;      // surrogate count
	limit?: number;       // enforced limit
	rationale?: string;   // explanation
	event?: 'limit_info' | 'limit_notice' | string;
	truncated?: boolean;  // final object if truncated
}
</code></pre></div></div>

<p>If you build tooling consuming the stream, treat unknown <code class="language-plaintext highlighter-rouge">event</code> values as forward‑compatible signals and ignore if unrecognized.</p>

<h3 id="failure--edge-handling">Failure &amp; Edge Handling</h3>
<ul>
  <li>If the heuristic throws, the system silently falls back to legacy env cap or unlimited (with a logged warning) to avoid breaking UX.</li>
  <li>If legacy <code class="language-plaintext highlighter-rouge">AZURE_STREAM_MAX_TOKENS</code> is set lower than heuristic result, a parenthetical note <code class="language-plaintext highlighter-rouge">(legacy cap override)</code> is appended to the rationale for transparency.</li>
</ul>

<h3 id="auditing">Auditing</h3>
<p>Future: Limit decisions (prompt length, keywords, chosen cap) can be appended to provenance JSONL with a sanitized prompt hash rather than raw text to preserve privacy while enabling aggregate analysis of truncation fairness.</p>

<hr />
<h2 id="accurate-token-counting">Accurate Token Counting</h2>

<h3 id="resolution-order">Resolution Order</h3>
<ol>
  <li>Attempt dynamic load of <code class="language-plaintext highlighter-rouge">@dqbd/tiktoken</code> (if installed).</li>
  <li>If unavailable or disabled (<code class="language-plaintext highlighter-rouge">TOKENIZER_DISABLED=1</code>), fall back to a naive splitter (whitespace + punctuation segmentation).</li>
  <li>Streaming path recalculates token count from the full accumulated text each delta; when real tokenizer is absent the count is approximate.</li>
  <li>Once the real tokenizer loads asynchronously, subsequent chunks use the accurate encoder (no retroactive recomputation of earlier counts).</li>
</ol>

<h3 id="environment-variables-1">Environment Variables</h3>
<p>| Variable | Purpose |
|———-|———|
| <code class="language-plaintext highlighter-rouge">TOKENIZER_DISABLED</code> | Force naive counting even if tokenizer library is present. |</p>

<h3 id="caveats">Caveats</h3>
<p>Naive counting may diverge from billing tokens (especially with multi-byte or BPE merges). The governance limit should therefore be considered a <em>semantic budget</em> until the real tokenizer is active.</p>

<h2 id="continuation-streaming-ux">Continuation Streaming UX</h2>

<p>When a stream truncates due to a limit policy, the <code class="language-plaintext highlighter-rouge">limit_notice</code> chunk contains <code class="language-plaintext highlighter-rouge">continuationId</code>. Clients can call <code class="language-plaintext highlighter-rouge">agent.continueStream({ continuationId, extraDirective })</code> to resume generation with context (tail of prior output plus original prompt). A new <code class="language-plaintext highlighter-rouge">limit_info</code> event begins the continuation stream (it may pick a different limit based on updated prompt context).</p>

<h3 id="continuation-constraints">Continuation Constraints</h3>
<p>| Env | Purpose | Default |
|—–|———|———|
| <code class="language-plaintext highlighter-rouge">CONTINUATION_TTL_MS</code> | Time a continuation remains valid. | 900000 (15 min) |
| <code class="language-plaintext highlighter-rouge">CONTINUATION_MAX</code> | Max stored continuation contexts (oldest evicted). | 200 |</p>

<p>Expired continuation IDs throw <code class="language-plaintext highlighter-rouge">Continuation expired</code>.</p>

<h3 id="ui-guidance">UI Guidance</h3>
<ul>
  <li>Offer a “Continue” button immediately on <code class="language-plaintext highlighter-rouge">limit_notice</code>.</li>
  <li>Optionally prompt user for an additional directive (e.g., “focus on examples”).</li>
  <li>Display a chain indicator (e.g., “(2/3 continuation)” if multiple truncations occur).</li>
</ul>

<h2 id="provenance-fields-extended-glossary">Provenance Fields (Extended Glossary)</h2>
<p>| Field | Meaning |
|——-|———|
| <code class="language-plaintext highlighter-rouge">limit</code> | Applied streaming token limit for the invocation. |
| <code class="language-plaintext highlighter-rouge">limitRationale</code> | Human-readable reason heuristic produced. |
| <code class="language-plaintext highlighter-rouge">truncated</code> | Boolean, true if the final result was cut early by policy. |
| <code class="language-plaintext highlighter-rouge">continuationOf</code> | If present, provenance ID of the prior truncated invocation this one continues. (Reserved for future wiring). |</p>

<p>These additions enable aggregate fairness analysis without logging raw prompts (only hashed via <code class="language-plaintext highlighter-rouge">promptHash</code>).</p>

<hr />
<p>Missing any required class or length threshold fails the preview job before artifact publication.</p>

<h3 id="signed-report">Signed Report</h3>
<p><code class="language-plaintext highlighter-rouge">preview-lock-report.json</code> is signed keylessly with Cosign (Fulcio + Rekor). Artifacts:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">preview-lock-report.json</code></li>
  <li><code class="language-plaintext highlighter-rouge">preview-lock-report.json.sig</code></li>
  <li><code class="language-plaintext highlighter-rouge">preview-lock-report.json.cert</code>
These can be verified offline:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cosign verify-blob <span class="se">\</span>
  <span class="nt">--certificate-oidc-issuer</span> https://token.actions.githubusercontent.com <span class="se">\</span>
  <span class="nt">--certificate-identity-regexp</span> <span class="s2">".*/deploy-unified.yml@refs/heads/main"</span> <span class="se">\</span>
  <span class="nt">--signature</span> web/dist/preview-lock-report.json.sig <span class="se">\</span>
  web/dist/preview-lock-report.json
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="index-html-hash-pairing">Index HTML Hash Pairing</h3>
<p>The report includes <code class="language-plaintext highlighter-rouge">indexHtmlSha256</code> which may differ from the earlier build-time integrity hash if post-build injection mutates the file. This allows you to:</p>
<ol>
  <li>Detect tampering between build and injection phases.</li>
  <li>Correlate script hash + index hash for reproducible diffing.</li>
</ol>

<p>If you need to assert that injection did not modify unrelated regions, you can store and diff a pre-injection integrity hash (future enhancement: dual-hash baseline).</p>

<h2 id="-humanai-convention"># HumanAI Convention</h2>

<p><strong>A reproducible, human-centered framework for ethical AI governance, grounded in human data and public-benefit infrastructure.</strong></p>

<h2 id="-vision">🌍 Vision</h2>
<p>HumanAI Convention is building a universal, participatory framework for AI governance—anchored in transparency, reproducibility, and human-centered design. Our goal is to ensure that AI systems evolve in ways that respect human dignity, cultural diversity, and long-term resilience.</p>

<h2 id="-whats-inside">🚀 What’s Inside</h2>

<h2 id="-roadmap">📖 Roadmap</h2>

<h2 id="-contributing">🤝 Contributing</h2>
<p>We welcome collaborators across disciplines—law, ethics, technical design, and community governance.<br />
See <a href="CONTRIBUTING.md"><code class="language-plaintext highlighter-rouge">CONTRIBUTING.md</code></a> for guidelines.</p>

<h2 id="-license">📜 License</h2>

<h2 id="-contact">📬 Contact</h2>

<h2 id="humanai-convention-is-a-public-benefit-initiative-together-we-can-build-ai-governance-that-belongs-to-everyone"><em>HumanAI Convention is a public-benefit initiative. Together, we can build AI governance that belongs to everyone.</em></h2>

<h2 id="observability--telemetry-summary">Observability &amp; Telemetry (Summary)</h2>

<p>Frontend telemetry blends a privacy-conscious custom analytics layer with optional Azure Application Insights forwarding. Core principles: explicit consent gating, minimal PII, consistent correlation, infrastructure-as-code for dashboards/alerts, and tunable sampling.</p>

<p>Key Components:</p>
<ul>
  <li>Custom analytics queue (consent gated, sampling, batching, circuit breaker, LRU dedupe).</li>
  <li>Web Vitals collection (LCP, INP, CLS, TTFB, FCP) → normalized <code class="language-plaintext highlighter-rouge">perf_metric</code> events (can disable).</li>
  <li>Service Worker + Preview config drift events (<code class="language-plaintext highlighter-rouge">config/drift</code>), update strategy events (<code class="language-plaintext highlighter-rouge">sw_hard_bust_complete</code>, etc.).</li>
  <li>Fetch dependency instrumentation (<code class="language-plaintext highlighter-rouge">fetch_dependency</code>) with duration + status + correlation trace id.</li>
  <li>Azure Application Insights integration (connection string or key) with telemetry initializer adding <code class="language-plaintext highlighter-rouge">sessionId</code> and <code class="language-plaintext highlighter-rouge">buildCommit</code>.</li>
  <li>Correlation header injection: <code class="language-plaintext highlighter-rouge">x-trace-id</code> per page load across all fetches.</li>
  <li>Infrastructure as Code: <code class="language-plaintext highlighter-rouge">alerts.bicep</code> (LCP p75, Fetch failure %, INP p75) and <code class="language-plaintext highlighter-rouge">workbook.bicep</code> + <code class="language-plaintext highlighter-rouge">azure-workbook.json</code> for dashboards.</li>
</ul>

<p>Environment Variables (build-time):
| Variable | Purpose |
|———-|———|
| <code class="language-plaintext highlighter-rouge">VITE_APPINSIGHTS_CONNECTION_STRING</code> | Preferred AI configuration (wins over key). |
| <code class="language-plaintext highlighter-rouge">VITE_APPINSIGHTS_KEY</code> | Legacy instrumentation key fallback. |
| <code class="language-plaintext highlighter-rouge">VITE_APPINSIGHTS_SAMPLE</code> | Override AI sampling percentage (default 50). |
| <code class="language-plaintext highlighter-rouge">VITE_DISABLE_VITALS</code> | <code class="language-plaintext highlighter-rouge">true</code> disables Web Vitals capture. |
| <code class="language-plaintext highlighter-rouge">VITE_ANALYTICS_ENDPOINT</code> | Optional backend batching endpoint for custom analytics. |
| <code class="language-plaintext highlighter-rouge">VITE_SW_EXPOSE_META</code> | Force SW config meta exposure in prod for diagnostics. |</p>

<p>Correlation Strategy:</p>
<ul>
  <li>Client generates a single UUID trace id per session (lifetime = page lifecycle / soft navigation cluster).</li>
  <li>Added to every fetch as <code class="language-plaintext highlighter-rouge">x-trace-id</code> and included in AI event dimensions enabling KQL joins with backend logs.</li>
  <li>Recommended backend: echo header, log it, and set AI <code class="language-plaintext highlighter-rouge">operation_Id</code> or custom dimension to enable distributed trace grouping.</li>
</ul>

<p>Sample KQL (Tuning &amp; Diagnosis):</p>

<ol>
  <li>Web Vitals Percentiles (adjust alert thresholds):
    <pre><code class="language-kusto">customEvents
| where name == 'perf_metric'
| extend metric=tostring(customDimensions.metric), value=toreal(customMeasurements.value)
| where metric in ('LCP','INP','CLS')
| summarize p50=percentile(value,50), p75=percentile(value,75), p90=percentile(value,90), p95=percentile(value,95) by metric
| order by metric asc
</code></pre>
  </li>
  <li>Fetch Dependency Failure Rate (exclude client aborts):
    <pre><code class="language-kusto">let deps = customEvents | where name == 'fetch_dependency';
deps
| extend status=toint(customMeasurements.status)
| summarize total=count(), failures=countif(status &gt;= 500 or status == 0) by bin(timestamp, 5m)
| extend failureRate = failures * 100.0 / max(total,1)
| order by timestamp desc
</code></pre>
  </li>
  <li>INP Distribution Bucketization:
    <pre><code class="language-kusto">customEvents
| where name == 'perf_metric' and tostring(customDimensions.metric) == 'INP'
| extend v=toint(customMeasurements.value)
| summarize count() by bucket = case(v &lt;= 200,'good', v &lt;= 500,'ni','poor')
</code></pre>
  </li>
  <li>Correlate Client Fetch Failures with Server Exceptions (needs backend propagation):
    <pre><code class="language-kusto">let client = customEvents
 | where name == 'fetch_dependency'
 | project traceId=tostring(customDimensions.traceId), clientTs=timestamp, url=tostring(customDimensions.url), status=toint(customMeasurements.status);
exceptions
 | extend traceId=tostring(customDimensions['x-trace-id'])
 | join kind=inner client on traceId
 | project clientTs, traceId, url, status, type, message
 | order by clientTs desc
</code></pre>
  </li>
</ol>

<p>Alert Threshold Tuning Workflow:</p>
<ol>
  <li>Run percentile query over last 7 days.</li>
  <li>Target p75 thresholds to sit 10–15% above rolling median to avoid noisy flips.</li>
  <li>Re-deploy alerts by updating <code class="language-plaintext highlighter-rouge">alerts.bicep</code> if sustained improvements permit tightening.</li>
  <li>Observe SLO error budget consumption (future addition) before lowering aggressively.</li>
</ol>

<p>Deploying Alerts &amp; Workbook (Azure CLI examples):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Acquire IDs</span>
<span class="nv">AI_ID</span><span class="o">=</span><span class="si">$(</span>az monitor app-insights component show <span class="nt">-g</span> &lt;rg&gt; <span class="nt">-a</span> &lt;aiName&gt; <span class="nt">--query</span> <span class="nb">id</span> <span class="nt">-o</span> tsv<span class="si">)</span>
<span class="nv">AG_ID</span><span class="o">=</span><span class="s2">"/subscriptions/&lt;sub&gt;/resourceGroups/&lt;rg&gt;/providers/microsoft.insights/actionGroups/&lt;actionGroupName&gt;"</span>

<span class="c"># Alerts</span>
az deployment group create <span class="nt">-g</span> &lt;rg&gt; <span class="nt">-f</span> alerts.bicep <span class="nt">-p</span> <span class="nv">appInsightsId</span><span class="o">=</span><span class="s2">"</span><span class="nv">$AI_ID</span><span class="s2">"</span> <span class="nv">actionGroupId</span><span class="o">=</span><span class="s2">"</span><span class="nv">$AG_ID</span><span class="s2">"</span>

<span class="c"># Workbook (inline JSON compact)</span>
az deployment group create <span class="nt">-g</span> &lt;rg&gt; <span class="nt">-f</span> workbook.bicep <span class="se">\</span>
	<span class="nt">-p</span> <span class="nv">workbookName</span><span class="o">=</span><span class="s2">"HAIC Observability"</span> <span class="nv">location</span><span class="o">=</span><span class="s2">"eastus"</span> <span class="nv">appInsightsId</span><span class="o">=</span><span class="s2">"</span><span class="nv">$AI_ID</span><span class="s2">"</span> <span class="se">\</span>
		 <span class="nv">workbookContent</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">cat </span>azure-workbook.json | jq <span class="nt">-c</span> .<span class="si">)</span><span class="s2">"</span>
</code></pre></div></div>

<p>Consent &amp; Privacy:</p>
<ul>
  <li>No telemetry leaves the browser until consent is granted (banner component).</li>
  <li>Pre-consent events are queued in-memory only (not persisted) and flushed retroactively on acceptance.</li>
  <li>Minimal metadata; opportunistic redaction of email-like strings in arbitrary fields.</li>
</ul>

<p>Disabling / Hardening:</p>
<ul>
  <li>Set <code class="language-plaintext highlighter-rouge">VITE_DISABLE_VITALS=true</code> to avoid capturing user-centric performance metrics.</li>
  <li>Omit AI env vars to run purely local analytics (useful for testing privacy posture).</li>
  <li>Adjust sampling via <code class="language-plaintext highlighter-rouge">VITE_APPINSIGHTS_SAMPLE</code>; for high-volume production consider 20–30% then raise during incident investigation.</li>
</ul>

<p>Future Enhancements (Telemetry):</p>
<ul>
  <li>Distributed trace propagation to backend OpenTelemetry spans.</li>
  <li>User timing mark aggregation for custom interaction instrumentation.</li>
  <li>Synthetic monitor ingestion panel in workbook.</li>
</ul>

<hr />

<h2 id="-build-version--reproducibility">🔢 Build Version &amp; Reproducibility</h2>
<p>Every build embeds a verifiable version object:</p>

<p>Sources of truth (all consistent):</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">public/version.json</code> (served statically)</li>
  <li><code class="language-plaintext highlighter-rouge">window.__APP_VERSION__</code> (attached early in runtime)</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;meta name="x-app-version" content="&lt;semver&gt;+&lt;shortSha&gt;"&gt;</code></li>
  <li>Generated module: <code class="language-plaintext highlighter-rouge">src/generated/appVersion.ts</code> for direct imports</li>
</ol>

<p>Structure:</p>
<div class="language-jsonc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"web"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.1.0"</span><span class="p">,</span><span class="w">        </span><span class="c1">// from package.json (first public preview)</span><span class="w">
	</span><span class="nl">"commit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"e598d45"</span><span class="p">,</span><span class="w">       </span><span class="c1">// short 12-char hash (build context)</span><span class="w">
	</span><span class="nl">"fullCommit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;40-char&gt;"</span><span class="p">,</span><span class="w">  </span><span class="c1">// full git SHA</span><span class="w">
	</span><span class="nl">"buildTime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-09-28T22:27:51.995Z"</span><span class="w"> </span><span class="c1">// ISO 8601 UTC</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Regeneration happens automatically inside <code class="language-plaintext highlighter-rouge">npm run build</code> via <code class="language-plaintext highlighter-rouge">scripts/generate-version.mjs</code>.
If you need to refresh locally (without full build):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm run version:gen
</code></pre></div></div>

<h3 id="integrity-hash-tamper-evident">Integrity Hash (Tamper-Evident)</h3>
<p>Each deploy and daily security audit generates a SHA-256 hash over the final <code class="language-plaintext highlighter-rouge">dist/index.html</code> and stores it in <code class="language-plaintext highlighter-rouge">version-integrity.json</code>:</p>

<div class="language-jsonc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="nl">"file"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dist/index.html"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"sha256"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;hex256&gt;"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;semver&gt;"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"commit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;shortCommit&gt;"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"generatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;ISO-UTC&gt;"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Surfacing &amp; Logging:</p>
<ol>
  <li>Deploy Workflows append an entry to a long‑lived GitHub Issue titled <code class="language-plaintext highlighter-rouge">Deployment Transparency Log</code> (auto‑created if missing).</li>
  <li>The hash appears in the GitHub Actions job summary for quick verification.</li>
  <li>Daily security audit rebuilds and recomputes the hash, comparing it with the last committed version to flag unexpected drift.</li>
</ol>

<p>Drift Meaning:</p>
<ul>
  <li>Expected: hash changes when code / dependencies / build config change.</li>
  <li>Suspicious: hash changes without a corresponding commit explanation (investigate diff in built artifact, dependency tree, or build toolchain changes).</li>
</ul>

<p>Manual Verification:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>web
<span class="nb">sha256sum </span>dist/index.html  <span class="c"># or certutil -hashfile dist/index.html SHA256 (Windows)</span>
<span class="nb">cat </span>dist/version-integrity.json | jq <span class="nt">-r</span> .sha256
</code></pre></div></div>

<p>Roadmap Enhancements (future):</p>
<ul>
  <li>Optional signed transparency log (Sigstore / Rekor integration).</li>
  <li>Attestations referencing SBOM + integrity hash (in-toto style chain).</li>
  <li>Public CDN hash disclosure for independent monitors.</li>
</ul>

<h3 id="continuous-deployed-integrity-monitoring">Continuous Deployed Integrity Monitoring</h3>
<p>An automated workflow (<code class="language-plaintext highlighter-rouge">deployed-integrity-check.yml</code>) runs hourly (and can be triggered manually) to fetch the deployed <code class="language-plaintext highlighter-rouge">index.html</code>, compute its SHA-256, and compare it to the committed baseline (<code class="language-plaintext highlighter-rouge">web/version-integrity.json</code>).</p>

<p>Script: <code class="language-plaintext highlighter-rouge">web/scripts/verify-deployed-integrity.mjs</code></p>

<p>Direct usage examples:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Baseline compare (uses committed web/version-integrity.json)</span>
node web/scripts/verify-deployed-integrity.mjs <span class="nt">--url</span> https://www.humanaiconvention.com/ <span class="nt">--json</span>

<span class="c"># Force a local rebuild before comparison</span>
node web/scripts/verify-deployed-integrity.mjs <span class="nt">--url</span> https://www.humanaiconvention.com/ <span class="nt">--rebuild</span> <span class="nt">--json</span>

<span class="c"># Save report to file with index preview</span>
node web/scripts/verify-deployed-integrity.mjs <span class="nt">--url</span> https://www.humanaiconvention.com/ <span class="nt">--json</span> <span class="nt">--out</span> integrity-report.json <span class="nt">--show-index</span>
</code></pre></div></div>

<p>Exit codes:</p>
<ul>
  <li>0: success (match)</li>
  <li>1: network / file error</li>
  <li>2: mismatch</li>
</ul>

<p>JSON report fields:
<code class="language-plaintext highlighter-rouge">schemaVersion, url, baselineSha256, remoteSha256, match, timestamp, mode, httpStatus, error, elapsedMs</code></p>

<p>The GH Actions job uploads <code class="language-plaintext highlighter-rouge">integrity-report.json</code> artifact and fails the run if a mismatch is detected. This provides early warning of unexpected production drift (e.g., CDN mutation, untracked manual changes, or compromised artifact).</p>

<h3 id="dual-integrity-predicate-versions-transition-v1--v2">Dual Integrity Predicate Versions (Transition: v1 ➜ v2)</h3>
<p>The hourly workflow emits BOTH <code class="language-plaintext highlighter-rouge">@v1</code> and <code class="language-plaintext highlighter-rouge">@v2</code> integrity predicates (matrix build) during a managed migration window.</p>

<table>
  <thead>
    <tr>
      <th>Version</th>
      <th>Predicate Type URL</th>
      <th>Shape (core fields)</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>v1</td>
      <td><code class="language-plaintext highlighter-rouge">https://humanaiconvention.com/attestation/integrity-report@v1</code></td>
      <td><code class="language-plaintext highlighter-rouge">{ _type, subject[], timestamp, description, reportFields:{ match, baselineSha256, remoteSha256, url, elapsedMs, error } }</code></td>
      <td>Legacy structure. Flat <code class="language-plaintext highlighter-rouge">reportFields</code> bag.</td>
    </tr>
    <tr>
      <td>v2</td>
      <td><code class="language-plaintext highlighter-rouge">https://humanaiconvention.com/attestation/integrity-report@v2</code></td>
      <td><code class="language-plaintext highlighter-rouge">{ _type, predicateVersion:"2.0", subject[], timestamp, description, report:{ status, hashes:{baseline,remote}, metrics:{elapsedMs}, url, error } }</code></td>
      <td>Normalized grouping + explicit semantic version.</td>
    </tr>
  </tbody>
</table>

<p>Reasons for v2 redesign:</p>
<ol>
  <li>Clarify semantics: distinct <code class="language-plaintext highlighter-rouge">status</code>, <code class="language-plaintext highlighter-rouge">hashes</code>, <code class="language-plaintext highlighter-rouge">metrics</code> domains.</li>
  <li>Provide future-proof grouping for additional metrics (latency breakdown, transport integrity) without field collisions.</li>
  <li>Add explicit <code class="language-plaintext highlighter-rouge">predicateVersion</code> field to support automated selection while keeping <code class="language-plaintext highlighter-rouge">_type</code> constant lineage.</li>
</ol>

<p>Versioning Policy:</p>
<ul>
  <li>Introduce new major predicate versions ONLY for structural / semantic breaking changes.</li>
  <li>Prefer additive optional fields inside an existing version.</li>
  <li>Maintain historical versions for audit; later policy may forbid new emissions of deprecated versions.</li>
</ul>

<h3 id="meta-predicate-aggregation">Meta Predicate Aggregation</h3>
<p>An additional meta-predicate (<code class="language-plaintext highlighter-rouge">https://humanaiconvention.com/attestation/meta-predicate@v1</code>) is emitted for the v1 lane that aggregates the SHA-256 digests of key predicates (integrity, sbom, fulcio-chain, provenance-lite). This allows consumers to retrieve a single attestation and verify referenced predicate digests without enumerating each individually.</p>

<p>Structure (simplified):</p>
<div class="language-jsonc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="nl">"_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://humanaiconvention.com/attestation/meta-predicate@v1"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;ISO-UTC&gt;"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"predicates"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
		</span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integrity"</span><span class="p">,</span><span class="w"> </span><span class="nl">"sha256"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="w"> </span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sbom"</span><span class="p">,</span><span class="w"> </span><span class="nl">"sha256"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="w"> </span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fulcio-chain"</span><span class="p">,</span><span class="w"> </span><span class="nl">"sha256"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="w"> </span><span class="p">},</span><span class="w">
		</span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"provenance-lite"</span><span class="p">,</span><span class="w"> </span><span class="nl">"sha256"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="w"> </span><span class="p">}</span><span class="w">
	</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>The out-of-band verification workflow cross-checks each referenced digest with freshly computed digests and exposes a <code class="language-plaintext highlighter-rouge">metaConsistent</code> flag in <code class="language-plaintext highlighter-rouge">verification-summary.json</code> plus the verification badge. A future v2 meta predicate may adopt a richer shape once integrity v2 fully replaces v1.</p>

<h3 id="sbom-schema-enforcement">SBOM Schema Enforcement</h3>
<p>SBOMs are validated (both in the primary integrity workflow and in the out-of-band verification workflow) against a minimal CycloneDX subset schema (<code class="language-plaintext highlighter-rouge">.github/schemas/sbom-min.schema.json</code>). Rationale:</p>
<ol>
  <li>Early structural sanity (bomFormat/specVersion/components) without requiring full upstream schema hydration.</li>
  <li>Fail-fast detection of truncated or malformed artifact uploads.</li>
  <li>Keeps validation lightweight for hourly cadence.</li>
</ol>

<p>If the SBOM fails schema validation, the integrity workflow fails and the verification badge will report failure (<code class="language-plaintext highlighter-rouge">schemaValid=false</code>). Trend CSV now tracks <code class="language-plaintext highlighter-rouge">sbomPresent</code> and <code class="language-plaintext highlighter-rouge">sbomSchemaValid</code> columns for longitudinal monitoring.</p>

<h3 id="provenance-enrichment">Provenance Enrichment</h3>
<p><code class="language-plaintext highlighter-rouge">provenance-lite@v1</code> now records build tool context and parameters:</p>
<div class="language-jsonc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="nl">"toolVersions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"node"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;x.y.z&gt;"</span><span class="p">,</span><span class="w"> </span><span class="nl">"npm"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;a.b.c&gt;"</span><span class="p">,</span><span class="w"> </span><span class="nl">"cyclonedx"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;ver&gt;"</span><span class="w"> </span><span class="p">},</span><span class="w">
	</span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"targetUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.humanaiconvention.com/"</span><span class="p">,</span><span class="w"> </span><span class="nl">"predicateVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"v1,v2"</span><span class="w"> </span><span class="p">},</span><span class="w">
	</span><span class="c1">// existing minimal provenance fields ...</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>Purpose: reproducibility &amp; traceability (ensuring identical toolchain versions can be reconstructed) and transparent mapping to target deployment URL plus active predicate version matrix.</p>

<h4 id="slsa-style-additions">SLSA-Style Additions</h4>
<p>The provenance predicate has been extended with lightweight SLSA-aligned fields to improve downstream auditability without adopting the full SLSA v1 provenance envelope:</p>

<table>
  <thead>
    <tr>
      <th>Field</th>
      <th>Purpose</th>
      <th>SLSA Analogue</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">invocation.parameters</code></td>
      <td>Inputs influencing the run (target URL, predicate version)</td>
      <td><code class="language-plaintext highlighter-rouge">invocation.parameters</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">invocation.environment</code></td>
      <td>Runtime context (runner OS, arch, git ref/SHA)</td>
      <td><code class="language-plaintext highlighter-rouge">invocation.environment</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">buildConfig</code></td>
      <td>Build orchestration identifiers (workflow, job)</td>
      <td><code class="language-plaintext highlighter-rouge">buildConfig</code> (custom mapping)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">completeness</code></td>
      <td>Declares which sections are fully captured (<code class="language-plaintext highlighter-rouge">parameters/materials/environment</code>)</td>
      <td><code class="language-plaintext highlighter-rouge">completeness</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">buildInvocationId</code></td>
      <td>Stable per-run build ID for correlation</td>
      <td><code class="language-plaintext highlighter-rouge">buildInvocationID</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">environment</code></td>
      <td>Flattened runner environment snapshot (dup convenience)</td>
      <td>(subset of <code class="language-plaintext highlighter-rouge">invocation.environment</code>)</td>
    </tr>
  </tbody>
</table>

<p>Example excerpt:</p>
<div class="language-jsonc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="nl">"buildInvocationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;runId&gt;-v2"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"invocation"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"targetUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.humanaiconvention.com/"</span><span class="p">,</span><span class="w"> </span><span class="nl">"predicateVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"v2"</span><span class="w"> </span><span class="p">},</span><span class="w">
		</span><span class="nl">"environment"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"os"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Linux"</span><span class="p">,</span><span class="w"> </span><span class="nl">"arch"</span><span class="p">:</span><span class="w"> </span><span class="s2">"X64"</span><span class="p">,</span><span class="w"> </span><span class="nl">"gitRef"</span><span class="p">:</span><span class="w"> </span><span class="s2">"refs/heads/main"</span><span class="p">,</span><span class="w"> </span><span class="nl">"gitSha"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;40-sha&gt;"</span><span class="w"> </span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w">
	</span><span class="nl">"buildConfig"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"workflow"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Deployed Integrity Check"</span><span class="p">,</span><span class="w"> </span><span class="nl">"job"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integrity"</span><span class="w"> </span><span class="p">},</span><span class="w">
	</span><span class="nl">"completeness"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nl">"materials"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nl">"environment"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>These fields enhance traceability (uniquely identifying a build invocation), reproducibility (documenting parameters and tool versions), and attest to completeness of captured context. Future work could emit a full SLSA provenance predicate while maintaining backward compatibility with the current <code class="language-plaintext highlighter-rouge">provenance-lite</code> structure.</p>

<h3 id="verification-badge-semantics">Verification Badge Semantics</h3>
<p><code class="language-plaintext highlighter-rouge">badges/verification-badge.json</code> drives the “Verification Health” shield. It turns bright green (<code class="language-plaintext highlighter-rouge">ok</code>) only when all predicate schemas (including SBOM) validate AND the meta predicate digest set matches the recomputed digests (<code class="language-plaintext highlighter-rouge">metaConsistent=true</code>). Any schema failure or digest mismatch flips the badge to red (<code class="language-plaintext highlighter-rouge">fail</code>).</p>

<h3 id="trend-csv">Trend CSV</h3>
<p>Historical verification results are appended to <code class="language-plaintext highlighter-rouge">verification-trend.csv</code> on the <code class="language-plaintext highlighter-rouge">badges</code> branch with columns:
<code class="language-plaintext highlighter-rouge">timestamp,runId,image,schemaValid,metaConsistent,integV1Present,integV2Present,sbomPresent,sbomSchemaValid</code></p>

<p>Consumers can ingest this for external monitoring, alerting, or graphing (e.g., percent success over time, SBOM availability rate). Future enhancements may add per-predicate latency / size metrics.</p>

<h3 id="json-schema-locations--validation">JSON Schema Locations &amp; Validation</h3>
<p>Schemas live under <code class="language-plaintext highlighter-rouge">.github/schemas/</code>:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">integrity-report-predicate.schema.json</code> — v1 integrity predicate.</li>
  <li><code class="language-plaintext highlighter-rouge">integrity-report-predicate.v2.schema.json</code> — v2 integrity predicate.</li>
  <li><code class="language-plaintext highlighter-rouge">fulcio-chain-predicate.schema.json</code> — Fulcio root+intermediate chain predicate.</li>
  <li><code class="language-plaintext highlighter-rouge">provenance-lite-predicate.schema.json</code> — Lightweight provenance (with optional <code class="language-plaintext highlighter-rouge">sbomSha256</code>).</li>
</ul>

<p>Validation is performed in‑pipeline with <code class="language-plaintext highlighter-rouge">ajv-cli@5.0.0</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx <span class="nt">--yes</span> ajv-cli@5.0.0 validate <span class="nt">-s</span> .github/schemas/integrity-report-predicate.v2.schema.json <span class="nt">-d</span> integrity-report.predicate.json
</code></pre></div></div>
<p>Logic: choose v2 schema when <code class="language-plaintext highlighter-rouge">PREDICATE_VERSION=v2</code>, else v1 schema. Chain &amp; provenance schemas validate opportunistically (warn-only if missing) while integrity predicate validation is fail-fast.</p>

<h3 id="predicate-policy-gate-lifecycle-enforcement">Predicate Policy Gate (Lifecycle Enforcement)</h3>
<p>Policy job <code class="language-plaintext highlighter-rouge">policy-gate</code> inspects emitted artifacts every run and applies date‑based rules:</p>

<table>
  <thead>
    <tr>
      <th>Phase</th>
      <th>Date (UTC)</th>
      <th>Behavior</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Dual emission (current)</td>
      <td>&lt; 2025-11-01</td>
      <td>v2 optional (warning if absent), v1 allowed</td>
    </tr>
    <tr>
      <td>Cutover</td>
      <td>≥ 2025-11-01</td>
      <td>v2 REQUIRED (error if missing)</td>
    </tr>
    <tr>
      <td>Deprecation</td>
      <td>≥ 2026-02-01</td>
      <td>v1 FORBIDDEN (error if present)</td>
    </tr>
  </tbody>
</table>

<p>Config (edit via PR in workflow):</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">env</span><span class="pi">:</span>
<span class="err">	</span><span class="na">CUTOFF_ENFORCE_V2</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2025-11-01'</span>
<span class="err">	</span><span class="na">DEPRECATE_V1_AFTER</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2026-02-01'</span>
</code></pre></div></div>
<p>Exit codes: <code class="language-plaintext highlighter-rouge">12</code> (missing required v2), <code class="language-plaintext highlighter-rouge">13</code> (lingering forbidden v1) to enable external monitors.</p>

<h3 id="fulcio-chain-predicate-purpose">Fulcio Chain Predicate Purpose</h3>
<p>Type: <code class="language-plaintext highlighter-rouge">https://humanaiconvention.com/attestation/fulcio-chain@v1</code></p>

<p>Captures the exact Fulcio root + intermediate certificate chain (concatenated PEM) hashed into the predicate <code class="language-plaintext highlighter-rouge">subject[0].digest.sha256</code>. Benefits:</p>
<ol>
  <li>Reproducible verification context if Fulcio rotates intermediates/root later.</li>
  <li>Forensic ability to map historical attestations to the trust anchor state at signing time.</li>
  <li>Defense against silent root replacement (paired with enforced root hash file <code class="language-plaintext highlighter-rouge">.github/fulcio-root.expected.json</code>).</li>
</ol>

<h3 id="provenance-sbomsha256-cross-link">Provenance <code class="language-plaintext highlighter-rouge">sbomSha256</code> Cross-Link</h3>
<p>Lightweight provenance predicate adds (when SBOM present):</p>
<ul>
  <li>Field: <code class="language-plaintext highlighter-rouge">sbomSha256</code></li>
  <li>Matching <code class="language-plaintext highlighter-rouge">materials[]</code> entry: <code class="language-plaintext highlighter-rouge">{uri: "sbom:cyclonedx", digest:{sha256:&lt;same&gt;}}</code></li>
</ul>

<p>Verification Checklist:</p>
<ol>
  <li>Integrity report predicate subject digest matches OCI image digest.</li>
  <li>Provenance <code class="language-plaintext highlighter-rouge">materials</code> includes repository commit (sha1) and SBOM digest (sha256).</li>
  <li><code class="language-plaintext highlighter-rouge">sbomSha256</code> equals digest attested in SBOM predicate.</li>
  <li>Fulcio chain predicate digest matches local concatenated chain used for verification.</li>
</ol>

<h3 id="updated-verification-examples-v1--v2">Updated Verification Examples (v1 + v2)</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">IMAGE_REF</span><span class="o">=</span><span class="s2">"ghcr.io/&lt;org&gt;/&lt;repo&gt;-integrity-report:&lt;run_id&gt;"</span>
<span class="c"># v2 (preferred)</span>
cosign verify-attestation <span class="se">\</span>
	<span class="nt">--type</span> https://humanaiconvention.com/attestation/integrity-report@v2 <span class="se">\</span>
	<span class="nt">--certificate-oidc-issuer</span> https://token.actions.githubusercontent.com <span class="se">\</span>
	<span class="nt">--certificate-identity-regexp</span> <span class="s1">'^https://github.com/&lt;org&gt;/&lt;repo&gt;/.github/workflows/deployed-integrity-check.yml@refs/heads/main$'</span> <span class="se">\</span>
	<span class="s2">"</span><span class="nv">$IMAGE_REF</span><span class="s2">"</span> | jq <span class="s1">'.payload|@base64d|fromjson|.predicate.report.status'</span>

<span class="c"># v1 (legacy)</span>
cosign verify-attestation <span class="se">\</span>
	<span class="nt">--type</span> https://humanaiconvention.com/attestation/integrity-report@v1 <span class="se">\</span>
	<span class="nt">--certificate-oidc-issuer</span> https://token.actions.githubusercontent.com <span class="se">\</span>
	<span class="nt">--certificate-identity-regexp</span> <span class="s1">'^https://github.com/&lt;org&gt;/&lt;repo&gt;/.github/workflows/deployed-integrity-check.yml@refs/heads/main$'</span> <span class="se">\</span>
	<span class="s2">"</span><span class="nv">$IMAGE_REF</span><span class="s2">"</span> | jq <span class="s1">'.payload|@base64d|fromjson|.predicate.reportFields.match'</span>
</code></pre></div></div>

<p>Migration Guidance: switch consumers to v2 before the cutover date; after deprecation v1 emissions halt (historic artifacts remain valid for audit).</p>

<hr />

<h3 id="baseline--reproducibility-gate">Baseline &amp; Reproducibility Gate</h3>
<p><code class="language-plaintext highlighter-rouge">web/version-integrity.json</code> (committed on successful deploy) forms the current baseline. Daily security audits:</p>
<ul>
  <li>Rebuild the app, recompute the hash, and compare against the committed baseline.</li>
  <li>If the Git commit is unchanged but the hash differs, the job fails (non‑reproducible / drift signal).</li>
</ul>

<h3 id="sbom-attestation">SBOM Attestation</h3>
<p>Deploy pipeline emits <code class="language-plaintext highlighter-rouge">web/attestation.json</code> containing:</p>
<div class="language-jsonc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> </span><span class="nl">"commit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;sha&gt;"</span><span class="p">,</span><span class="w"> </span><span class="nl">"time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;UTC&gt;"</span><span class="p">,</span><span class="w"> </span><span class="nl">"integritySha256"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;index.html sha&gt;"</span><span class="p">,</span><span class="w"> </span><span class="nl">"sbomSha256"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;sbom.json sha&gt;"</span><span class="p">,</span><span class="w"> </span><span class="nl">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cyclonedx-1.5"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>This links runtime artifact hash to the exact SBOM hash for provenance.</p>

<h3 id="provenance-slsa-lite-in-toto-statement--optional-slsa-v10-predicate">Provenance (SLSA-lite in-toto Statement &amp; Optional SLSA v1.0 Predicate)</h3>
<p><code class="language-plaintext highlighter-rouge">web/provenance.json</code> is generated post-build linking:</p>
<ul>
  <li>Subject: <code class="language-plaintext highlighter-rouge">dist/index.html</code> (sha256 equals integrity hash)</li>
  <li>Dependencies: <code class="language-plaintext highlighter-rouge">sbom.json</code> + <code class="language-plaintext highlighter-rouge">attestation.json</code> digests</li>
  <li>Builder: workflow reference (URI with commit)</li>
  <li>Predicate Type: <code class="language-plaintext highlighter-rouge">https://slsa.dev/provenance/v1</code></li>
</ul>

<p>This minimal statement traces the build artifact to the exact SBOM + attestation without needing a full build graph expansion.</p>

<p>Provenance &amp; Attestation References:</p>
<ul>
  <li>Integrity Report Blob Signature: artifacts in workflow <code class="language-plaintext highlighter-rouge">deployed-integrity-check</code> (hourly)</li>
  <li>Attestation (predicate) tied to OCI image: <code class="language-plaintext highlighter-rouge">ghcr.io/&lt;org&gt;/&lt;repo&gt;-integrity-report:&lt;run_id&gt;</code></li>
  <li>Transparency Log (digests): Issue labeled <code class="language-plaintext highlighter-rouge">integrity-attestation</code></li>
</ul>

<p>Suggested verification command (report blob):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cosign verify-blob <span class="se">\</span>
  <span class="nt">--certificate-oidc-issuer</span> https://token.actions.githubusercontent.com <span class="se">\</span>
  <span class="nt">--certificate-identity-regexp</span> <span class="s1">'^https://github.com/&lt;org&gt;/&lt;repo&gt;/.github/workflows/deployed-integrity-check.yml@refs/heads/main$'</span> <span class="se">\</span>
  <span class="nt">--signature</span> integrity-report.json.sig <span class="se">\</span>
  integrity-report.json
</code></pre></div></div>

<p>Suggested verification command (attestation):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">IMAGE_REF</span><span class="o">=</span><span class="s2">"ghcr.io/&lt;org&gt;/&lt;repo&gt;-integrity-report:&lt;run_id&gt;"</span> <span class="c"># or digest form</span>
cosign verify-attestation <span class="se">\</span>
  <span class="nt">--type</span> https://humanaiconvention.com/attestation/integrity-report@v1 <span class="se">\</span>
  <span class="nt">--certificate-oidc-issuer</span> https://token.actions.githubusercontent.com <span class="se">\</span>
  <span class="nt">--certificate-identity-regexp</span> <span class="s1">'^https://github.com/&lt;org&gt;/&lt;repo&gt;/.github/workflows/deployed-integrity-check.yml@refs/heads/main$'</span> <span class="se">\</span>
  <span class="s2">"</span><span class="nv">$IMAGE_REF</span><span class="s2">"</span> | jq <span class="s1">'.payload|@base64d|fromjson|.predicate.reportFields.match'</span>
</code></pre></div></div>

<p>Freshness (prototype): artifact <code class="language-plaintext highlighter-rouge">attestation-freshness.json</code> contains</p>
<div class="language-jsonc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> </span><span class="nl">"lastAttestationUTC"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;ISO-UTC&gt;"</span><span class="p">,</span><span class="w"> </span><span class="nl">"match"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nl">"image"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ghcr.io/&lt;org&gt;/&lt;repo&gt;-integrity-report@sha256:..."</span><span class="p">,</span><span class="w"> </span><span class="nl">"reportDigest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;sha256&gt;"</span><span class="p">,</span><span class="w"> </span><span class="nl">"predicateDigest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;sha256&gt;"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>You can publish this JSON (e.g. via a gist or pages endpoint) and create a badge:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://img.shields.io/endpoint?url=&lt;raw-url-to-attestation-freshness.json&gt;&amp;label=integrity%20attestation
</code></pre></div></div>

<p>Optional (scaffolded): An official SLSA v1.0 predicate can be enabled via a future dedicated job when <code class="language-plaintext highlighter-rouge">GENERATE_SLSA_PREDICATE=true</code> (the workflow currently logs the subject hash as preparation).</p>

<h3 id="fulcio-root-trust--rotation-playbook">Fulcio Root Trust &amp; Rotation Playbook</h3>
<p>The workflow fetches the Fulcio root &amp; intermediate chain each run and enforces the stored root hash in <code class="language-plaintext highlighter-rouge">.github/fulcio-root.expected.json</code>.</p>

<p>If the fetched root hash differs from the expected value the job:</p>
<ol>
  <li>Creates / updates an issue labeled <code class="language-plaintext highlighter-rouge">fulcio-root-rotation</code> (and <code class="language-plaintext highlighter-rouge">supply-chain</code>, <code class="language-plaintext highlighter-rouge">audit</code>).</li>
  <li>Fails immediately (exit code 42) to prevent accepting an unreviewed trust anchor.</li>
</ol>

<p>To approve a legitimate Fulcio rotation:</p>
<ol>
  <li>Obtain the new root via two independent channels (primary: <code class="language-plaintext highlighter-rouge">https://fulcio.sigstore.dev/api/v2/rootCert</code>; secondary: Sigstore release / security advisory).</li>
  <li>Compute its SHA-256 locally: <code class="language-plaintext highlighter-rouge">sha256sum root.pem</code> (or <code class="language-plaintext highlighter-rouge">shasum -a 256 root.pem</code>).</li>
  <li>Open a PR updating <code class="language-plaintext highlighter-rouge">sha256</code> in <code class="language-plaintext highlighter-rouge">.github/fulcio-root.expected.json</code> only (no unrelated changes) and reference the rotation issue.</li>
  <li>Have at least one reviewer validate hash &amp; source.</li>
  <li>Merge; the next run will pass if the value matches.</li>
</ol>

<p>Emergency Response (unexpected rotation / compromise suspected):</p>
<ul>
  <li>Suspend downstream deployments referencing new certificates.</li>
  <li>Capture failing run artifacts (the chain) for forensics.</li>
  <li>Escalate according to internal incident playbook before updating expected hash.</li>
</ul>

<h3 id="predicate-version-negotiation">Predicate Version Negotiation</h3>
<p><code class="language-plaintext highlighter-rouge">PREDICATE_VERSION</code> environment variable drives the custom predicate type: <code class="language-plaintext highlighter-rouge">https://humanaiconvention.com/attestation/integrity-report@&lt;version&gt;</code>.
Schema currently supports <code class="language-plaintext highlighter-rouge">@v1</code>; a forward-looking <code class="language-plaintext highlighter-rouge">$defs.predicateV2</code> placeholder is included to allow additive evolution.</p>

<p>Upgrade Path (<code class="language-plaintext highlighter-rouge">v2</code> example):</p>
<ol>
  <li>Add concrete <code class="language-plaintext highlighter-rouge">predicateV2</code> structure &amp; validation logic in schema.</li>
  <li>Run workflow with matrix <code class="language-plaintext highlighter-rouge">[v1, v2]</code> producing dual attestations for a deprecation window.</li>
  <li>Update verification consumers to accept both (regex or array of types).</li>
  <li>After adoption, drop <code class="language-plaintext highlighter-rouge">v1</code> from production verification while preserving historical artifacts.</li>
</ol>

<p>Decision Guidelines:</p>
<ul>
  <li>Bump version only for breaking semantic changes (field renames / removals) or security-critical canonicalization changes.</li>
  <li>Prefer additive fields or nested extension objects to avoid churn.</li>
</ul>

<h3 id="sbom-attestation-verification">SBOM Attestation Verification</h3>
<p>SBOM is attested separately with type <code class="language-plaintext highlighter-rouge">https://humanaiconvention.com/attestation/sbom@v1</code> bound to the same OCI image subject as the integrity predicate.</p>

<p>Manual verification:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">IMAGE_REF</span><span class="o">=</span><span class="s2">"ghcr.io/&lt;org&gt;/&lt;repo&gt;-integrity-report:&lt;run_id&gt;"</span>
cosign verify-attestation <span class="se">\</span>
	<span class="nt">--type</span> https://humanaiconvention.com/attestation/sbom@v1 <span class="se">\</span>
	<span class="nt">--certificate-oidc-issuer</span> https://token.actions.githubusercontent.com <span class="se">\</span>
	<span class="nt">--certificate-identity-regexp</span> <span class="s1">'^https://github.com/&lt;org&gt;/&lt;repo&gt;/.github/workflows/deployed-integrity-check.yml@refs/heads/main$'</span> <span class="se">\</span>
	<span class="s2">"</span><span class="nv">$IMAGE_REF</span><span class="s2">"</span> | jq <span class="s1">'.payload|@base64d|fromjson|.predicate | {bomFormat,specVersion,componentsCount:(.components|length)}'</span>
</code></pre></div></div>

<h3 id="lightweight-provenance-attestation">Lightweight Provenance Attestation</h3>
<p>Type: <code class="language-plaintext highlighter-rouge">https://humanaiconvention.com/attestation/provenance-lite@v1</code> linking builder metadata and repository commit to the same OCI subject.</p>

<p>Manual verification:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cosign verify-attestation <span class="se">\</span>
	<span class="nt">--type</span> https://humanaiconvention.com/attestation/provenance-lite@v1 <span class="se">\</span>
	<span class="nt">--certificate-oidc-issuer</span> https://token.actions.githubusercontent.com <span class="se">\</span>
	<span class="nt">--certificate-identity-regexp</span> <span class="s1">'^https://github.com/&lt;org&gt;/&lt;repo&gt;/.github/workflows/deployed-integrity-check.yml@refs/heads/main$'</span> <span class="se">\</span>
	<span class="s2">"</span><span class="nv">$IMAGE_REF</span><span class="s2">"</span> | jq <span class="s1">'.payload|@base64d|fromjson|.predicate | {builder,materials,metadata}'</span>
</code></pre></div></div>

<p>Cross-check:</p>
<ul>
  <li>Ensure integrity report predicate subject digest == image digest.</li>
  <li>Ensure provenance materials digest matches HEAD commit &amp; SBOM digest (if referenced in future expansion).</li>
</ul>

<h3 id="attestation-chain-integrity">Attestation Chain Integrity</h3>
<p>All verification steps pass <code class="language-plaintext highlighter-rouge">--certificate-chain fulcio-chain/fulcio-chain.pem</code> ensuring the Fulcio root currently pinned remains the anchor.</p>

<p>If chain changes but root remains the same (intermediate rotation) the run will continue; if root changes, the enforced fail halts until manual approval.</p>

<h3 id="slsa-predicate-integrated--signed">SLSA Predicate (Integrated &amp; Signed)</h3>
<p>The deploy job now generates <code class="language-plaintext highlighter-rouge">slsa-provenance.json</code> in‑line (after the lightweight provenance) and signs it together with all other artifacts. This predicate:</p>
<ul>
  <li>Subject: <code class="language-plaintext highlighter-rouge">dist/index.html</code> (sha256 = integrity hash)</li>
  <li>Resolved dependencies: <code class="language-plaintext highlighter-rouge">sbom.json</code>, <code class="language-plaintext highlighter-rouge">attestation.json</code>, and internal <code class="language-plaintext highlighter-rouge">provenance.json</code> digest</li>
  <li>Is signed (signature, certificate, Rekor bundle) and pushed to GHCR as <code class="language-plaintext highlighter-rouge">slsa-provenance:&lt;commit&gt;</code> for remote verification.</li>
</ul>

<p>Policy enforcement currently checks presence of signature triplets for: integrity, attestation, provenance, slsa-provenance, and optional sbom.</p>

<h3 id="signing-rekor-inclusion-proofs--oci-publication">Signing, Rekor Inclusion Proofs, &amp; OCI Publication</h3>
<p>Deploy workflow steps:</p>
<ol>
  <li>Keyless Cosign signs <code class="language-plaintext highlighter-rouge">attestation.json</code>, <code class="language-plaintext highlighter-rouge">version-integrity.json</code>, <code class="language-plaintext highlighter-rouge">sbom.json</code> (if present), and <code class="language-plaintext highlighter-rouge">provenance.json</code>.</li>
  <li>For each artifact we persist:
    <ul>
      <li>Detached signature: <code class="language-plaintext highlighter-rouge">*.sig</code></li>
      <li>Fulcio certificate: <code class="language-plaintext highlighter-rouge">*.cert</code></li>
      <li>Rekor bundle (inclusion proof + signed entry): <code class="language-plaintext highlighter-rouge">*.bundle</code></li>
    </ul>
  </li>
  <li>Push JSON assets to GHCR as OCI refs:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">attestation:&lt;commit&gt;</code></li>
      <li><code class="language-plaintext highlighter-rouge">integrity:&lt;commit&gt;</code></li>
      <li><code class="language-plaintext highlighter-rouge">sbom:&lt;commit&gt;</code></li>
      <li><code class="language-plaintext highlighter-rouge">provenance:&lt;commit&gt;</code></li>
    </ul>
  </li>
  <li>CI verifies blobs (<code class="language-plaintext highlighter-rouge">cosign verify-blob</code>), validates bundle structure (LogID + InclusionProof), and then verifies OCI references (<code class="language-plaintext highlighter-rouge">cosign verify ghcr.io/...</code>).</li>
  <li>Artifacts + signatures uploaded for offline validation.</li>
</ol>

<p>Manual verification examples:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">COSIGN_EXPERIMENTAL</span><span class="o">=</span>1

<span class="c"># 1. Verify blob signature</span>
<span class="nv">distHash</span><span class="o">=</span><span class="si">$(</span>jq <span class="nt">-r</span> <span class="s1">'.sha256'</span> version-integrity.json<span class="si">)</span>
cosign verify-blob <span class="nt">--signature</span> version-integrity.sig version-integrity.json

<span class="c"># 2. Inspect certificate (OIDC identity)</span>
openssl x509 <span class="nt">-in</span> version-integrity.cert <span class="nt">-noout</span> <span class="nt">-subject</span> <span class="nt">-issuer</span> <span class="nt">-dates</span>

<span class="c"># 3. Check Rekor bundle inclusion fields</span>
jq <span class="s1">'.LogID, .Verification.InclusionProof.LogIndex, .IntegratedTime'</span> version-integrity.bundle

<span class="c"># 4. Verify OCI reference (registry copy)</span>
cosign verify ghcr.io/&lt;org&gt;/&lt;repo&gt;/integrity:&lt;commit&gt;

<span class="c"># 5. Retrieve provenance from registry</span>
oras pull ghcr.io/&lt;org&gt;/&lt;repo&gt;/provenance:&lt;commit&gt;
jq <span class="nb">.</span> provenance.json | <span class="nb">head</span>
</code></pre></div></div>

<p>Identity-Constrained Verification:
The pipeline now enforces a narrowed identity anchored to the exact workflow path &amp; branch:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--certificate-identity-regexp '^https://github.com/&lt;org&gt;/&lt;repo&gt;/.github/workflows/deployed-integrity-check.yml@refs/heads/main$'
--certificate-oidc-issuer https://token.actions.githubusercontent.com
</code></pre></div></div>
<p>This reduces blast radius vs a broad ‘https://github.com/.+’ pattern and prevents unrelated workflows from producing valid-looking signatures.</p>

<p>Hardening extensions (future):</p>
<ul>
  <li>Rotate to tag-based invocation pattern (immutable workflow reference) via environment pinning.</li>
  <li>Add policy layer (e.g., <code class="language-plaintext highlighter-rouge">cosign policy</code> / Sigstore policy-controller if moving to Kubernetes).</li>
</ul>

<h3 id="deterministic-rebuild--sbom-enforcement-deploy--daily-audit">Deterministic Rebuild &amp; SBOM Enforcement (Deploy + Daily Audit)</h3>
<p><code class="language-plaintext highlighter-rouge">verify</code> job rebuilds after deploy ensuring integrity hash matches the committed baseline.</p>

<p>SBOM Hash Policy (shared by deploy verify + daily security audit):</p>
<ul>
  <li>Before enforcement date (<code class="language-plaintext highlighter-rouge">2025-10-15</code>): mismatch produces a warning (investigate transitive drift).</li>
  <li>On/After enforcement date: mismatch fails (strict reproducibility of dependency graph).</li>
</ul>

<p>Daily security audit recomputes SBOM and compares against the committed baseline (<code class="language-plaintext highlighter-rouge">web/sbom/sbom.json</code> now included in deploy baseline commit); drift before enforcement is advisory, after enforcement is blocking.</p>

<p>Rationale: Gradual rollout minimizes false positives while dependency locking stabilizes.</p>

<p>Consumer example (React component):</p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">APP_VERSION</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/generated/appVersion</span><span class="dl">'</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">APP_VERSION</span><span class="p">.</span><span class="nx">commit</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="-github-actions-pinning-strategy">🔐 GitHub Actions Pinning Strategy</h2>
<p>All workflows pin third‑party actions to immutable commit SHAs to eliminate supply‑chain drift.</p>

<p>Pattern:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Action Pin Table</span>
<span class="c1"># | Action | Version | Commit SHA |</span>
<span class="c1"># |-------|---------|------------|</span>
<span class="c1"># | actions/checkout | v5.0.0 | 08c6903c... |</span>

<span class="na">steps</span><span class="pi">:</span>
<span class="err">	</span><span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@08c6903c...</span> <span class="c1"># v5.0.0</span>
</code></pre></div></div>

<p>Why:</p>
<ul>
  <li>Reproducibility &amp; audit trail</li>
  <li>Faster incident response (single table to diff)</li>
  <li>Prevents silent major updates</li>
</ul>

<p>Refresh procedure:</p>
<ol>
  <li>List current pins (top of each workflow file).</li>
  <li>For each action, check upstream repo Releases / tags.</li>
  <li>Resolve the commit for the newest accepted major (we intentionally jump to latest stable major).</li>
  <li>Replace the SHA in <code class="language-plaintext highlighter-rouge">uses:</code> and update the table row (keep the old in git history—no separate changelog needed).</li>
  <li>Run a dry CI (push to a branch) and confirm no behavioral regressions.</li>
  <li>Merge with a commit message: <code class="language-plaintext highlighter-rouge">ci: refresh action pins</code>.</li>
</ol>

<p>Never pin to moving tags (e.g. <code class="language-plaintext highlighter-rouge">@main</code>). Avoid unmaintained forks.</p>

<hr />

<h2 id="️-security-governance--dependency-health">🛡️ Security Governance &amp; Dependency Health</h2>

<p>Automation Layers:</p>
<ol>
  <li>Daily Security Audit (<code class="language-plaintext highlighter-rouge">security-audit.yml</code>)
    <ul>
      <li>Runs <code class="language-plaintext highlighter-rouge">npm audit --omit=dev</code> and produces <code class="language-plaintext highlighter-rouge">audit.json</code>, <code class="language-plaintext highlighter-rouge">audit-summary.json</code>.</li>
      <li>High / Critical vulnerabilities fail immediately (exit code 2).</li>
      <li>Moderate vulnerabilities become failing after staged date <code class="language-plaintext highlighter-rouge">STAGE_MODERATE_FAIL_DATE</code> (currently 2025‑11‑01) to give remediation runway.</li>
      <li>SARIF conversion scaffolded (local generation) to enable future upload integration.</li>
    </ul>
  </li>
  <li>Weekly Action Pin Refresh (<code class="language-plaintext highlighter-rouge">weekly-pin-refresh.yml</code>)
    <ul>
      <li>Opens / updates an Issue prompting review of upstream action releases.</li>
    </ul>
  </li>
  <li>SBOM Generation (<code class="language-plaintext highlighter-rouge">sbom.yml</code>)
    <ul>
      <li>Produces CycloneDX JSON &amp; XML artifacts for provenance and downstream scanning.</li>
    </ul>
  </li>
  <li>Version Integrity
    <ul>
      <li><code class="language-plaintext highlighter-rouge">vite</code> plugin inlines <code class="language-plaintext highlighter-rouge">&lt;meta name="x-app-version" ...&gt;</code> and assigns <code class="language-plaintext highlighter-rouge">window.__APP_VERSION__</code> at build time.</li>
      <li>Verification script: <code class="language-plaintext highlighter-rouge">npm run verify:inline-version</code> ensures HTML meta matches <code class="language-plaintext highlighter-rouge">version.json</code> + commit, guard‑ing against tampering.</li>
    </ul>
  </li>
</ol>

<p>Remediation Flow:</p>
<ol>
  <li>Failing daily audit triggers an Issue comment or creation.</li>
  <li>Triage severity &amp; assess exploitability (public exploit? transient transitive?).</li>
  <li>Prefer patch/minor bumps via Dependabot or manual <code class="language-plaintext highlighter-rouge">npm update --depth=0 &lt;pkg&gt;</code>.</li>
  <li>For unavoidable major bumps, open a PR labeled <code class="language-plaintext highlighter-rouge">security-major</code> with a clear diff summary.</li>
</ol>

<p>Escalation SLA Targets (guideline):
| Severity | Target Fix Window |
|———-|——————-|
| Critical | &lt; 24h |
| High     | &lt; 72h |
| Moderate | &lt; 14d (becomes enforced after stage date) |
| Low      | Opportunistic |</p>

<hr />

<h2 id="-performance-budgets--lighthouse-thresholds">📏 Performance Budgets &amp; Lighthouse Thresholds</h2>

<p>Budgets file: <code class="language-plaintext highlighter-rouge">web/lighthouse-budgets.json</code></p>

<p>Enforced in CI (<code class="language-plaintext highlighter-rouge">ci-full-backup.yml</code>):</p>
<ol>
  <li>Budgets: resource size &amp; request count caps (HTML, JS, CSS, images, third‑party).</li>
  <li>Category Thresholds (via <code class="language-plaintext highlighter-rouge">scripts/check-lighthouse-thresholds.mjs</code>):
    <ul>
      <li>Performance ≥ 90</li>
      <li>Accessibility ≥ 95</li>
      <li>Best Practices ≥ 95</li>
      <li>SEO ≥ 90</li>
      <li>(PWA optional – only if <code class="language-plaintext highlighter-rouge">MIN_LH_PWA</code> env set)</li>
    </ul>
  </li>
</ol>

<p>Failure Behavior:</p>
<ul>
  <li>Any category below its floor → job fails.</li>
  <li>Budgets exceeded during Lighthouse run → Lighthouse step fails prior to threshold script.</li>
</ul>

<p>Regressing Locally:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>web
npm run lhci <span class="nt">--</span> <span class="nt">--budgetsPath</span><span class="o">=</span>./lighthouse-budgets.json
node scripts/check-lighthouse-thresholds.mjs
</code></pre></div></div>

<p>Iteration Guidance:</p>
<ol>
  <li>Address largest JS bundles first (code splitting / tree shaking).</li>
  <li>Optimize images (AVIF / WebP already leveraged; verify dimensions &amp; compression).</li>
  <li>Eliminate unused React code paths before raising thresholds further.</li>
</ol>

<hr />

<h2 id="-local-development-quick-start">🧪 Local Development Quick Start</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>web
npm <span class="nb">install
</span>npm run dev
</code></pre></div></div>

<p>Optional validation before opening a PR:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm run lint <span class="o">&amp;&amp;</span> npm run typecheck <span class="o">&amp;&amp;</span> npm <span class="nb">test
</span>npm run build
</code></pre></div></div>

<p>&lt;!–</p>

<p>Dry-run docs-only validation (do not remove) - 2025-10-04T04:23:18Z</p>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
  </body>
</html>
